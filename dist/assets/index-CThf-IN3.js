(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=i(o);fetch(o.href,s)}})();class H{state;constructor(t){this.state=t|0}next(){this.state=this.state+1831565813|0;let t=Math.imul(this.state^this.state>>>15,1|this.state);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}nextInt(t,i){return Math.floor(this.next()*(i-t+1))+t}nextFloat(t,i){return this.next()*(i-t)+t}pick(t){return t[Math.floor(this.next()*t.length)]}shuffle(t){for(let i=t.length-1;i>0;i--){const n=Math.floor(this.next()*(i+1));[t[i],t[n]]=[t[n],t[i]]}return t}chance(t){return this.next()<t}weightedPick(t){const i=t.reduce((o,[,s])=>o+s,0);let n=this.next()*i;for(const[o,s]of t)if(n-=s,n<=0)return o;return t[t.length-1][0]}gaussian(t=0,i=1){const n=this.next(),o=this.next();return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*o)*i+t}fork(){return new H(this.nextInt(0,2147483647))}}let ce=0;function _(e=""){return ce++,`${e}${e?"_":""}${ce.toString(36)}_${Date.now().toString(36)}`}class Z{perm;grad3;constructor(t){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];const i=new Uint8Array(256);for(let n=0;n<256;n++)i[n]=n;for(let n=255;n>0;n--){const o=Math.floor(t.next()*(n+1));[i[n],i[o]]=[i[o],i[n]]}this.perm=new Uint8Array(512);for(let n=0;n<512;n++)this.perm[n]=i[n&255]}dot2(t,i,n){return t[0]*i+t[1]*n}noise2D(t,i){const n=.5*(Math.sqrt(3)-1),o=(3-Math.sqrt(3))/6,s=(t+i)*n,a=Math.floor(t+s),r=Math.floor(i+s),l=(a+r)*o,c=a-l,d=r-l,u=t-c,f=i-d;let m,p;u>f?(m=1,p=0):(m=0,p=1);const g=u-m+o,k=f-p+o,y=u-1+2*o,I=f-1+2*o,v=a&255,T=r&255,ie=this.perm[v+this.perm[T]]%12,j=this.perm[v+m+this.perm[T+p]]%12,U=this.perm[v+1+this.perm[T+1]]%12;let $,P,O,N=.5-u*u-f*f;N<0?$=0:(N*=N,$=N*N*this.dot2(this.grad3[ie],u,f));let F=.5-g*g-k*k;F<0?P=0:(F*=F,P=F*F*this.dot2(this.grad3[j],g,k));let Y=.5-y*y-I*I;return Y<0?O=0:(Y*=Y,O=Y*Y*this.dot2(this.grad3[U],y,I)),70*($+P+O)}fbm(t,i,n,o=2,s=.5){let a=0,r=1,l=1,c=0;for(let d=0;d<n;d++)a+=r*this.noise2D(t*l,i*l),c+=r,r*=s,l*=o;return a/c}ridgeNoise(t,i,n,o=2,s=.5){let a=0,r=1,l=1,c=0;for(let d=0;d<n;d++){let u=this.noise2D(t*l,i*l);u=1-Math.abs(u),u=u*u,a+=r*u,c+=r,r*=s,l*=o}return a/c}}function S(e,t,i){return Math.max(t,Math.min(i,e))}function B(e,t){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function X(e,t){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}function Re(e,t,i){return[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}].map(o=>({x:e.x+o.x,y:e.y+o.y})).filter(o=>o.x>=0&&o.x<t&&o.y>=0&&o.y<i)}function oe(e,t,i){return e.x>=0&&e.x<t&&e.y>=0&&e.y<i}const Se=[{max:.22,type:"deep_ocean"},{max:.3,type:"shallow_ocean"},{max:.33,type:"coast"},{max:.5,type:"lowland"},{max:.65,type:"highland"},{max:.82,type:"mountain"},{max:1,type:"peak"}];function Me(e){for(const t of Se)if(e<=t.max)return t.type;return"peak"}function L(e){return e==="deep_ocean"||e==="shallow_ocean"}function Te(e,t,i){const n=new Z(i),o=new Z(i.fork()),s=[];for(let a=0;a<t;a++){s[a]=[];for(let r=0;r<e;r++){const l=r/e,c=a/t;let d=0;d+=1*n.noise2D(l*3,c*3),d+=.5*n.noise2D(l*6,c*6),d+=.25*n.noise2D(l*12,c*12),d+=.12*n.noise2D(l*24,c*24),d=d/(1+.5+.25+.12);const u=o.ridgeNoise(l*4,c*4,4,2,.5);d=d*.7+u*.3,d=(d+1)/2;const f=l-.5,m=c-.5,p=Math.sqrt(f*f+m*m)*2,g=n.noise2D(l*2,c*2)*.15,k=1-Math.pow(S(p+g,0,1),1.8);d=d*k;const y=l-.25,I=c-.7,v=Math.sqrt(y*y+I*I)*3,T=1-Math.pow(S(v,0,1),2),ie=n.fbm(l*4+10,c*4+10,4)*.5+.5;d=Math.max(d,ie*T*.7);const j=l-.75,U=c-.3,$=Math.sqrt(j*j+U*U)*4,P=1-Math.pow(S($,0,1),2.5),O=n.fbm(l*5+20,c*5+20,3)*.5+.5;d=Math.max(d,O*P*.55),s[a][r]=S(d,0,1)}}return s}function De(e,t,i,n){const o=new Z(n),s=[];for(let a=0;a<t;a++){s[a]=[];for(let r=0;r<e;r++){const l=a/t,c=1-Math.abs(l-.5)*2,d=Math.max(0,i[a][r]-.5)*1.5,u=r/e,f=o.noise2D(u*4,l*4)*.15,m=c-d+f;s[a][r]=S(m,0,1)}}return s}function Le(e,t,i,n,o){const s=new Z(o),a=[],r=_e(e,t,n);for(let l=0;l<t;l++){a[l]=[];for(let c=0;c<e;c++){const d=c/e,u=l/t;let f=0;f+=1*s.noise2D(d*3,u*3),f+=.5*s.noise2D(d*6,u*6),f+=.25*s.noise2D(d*12,u*12),f=f/(1+.5+.25),f=(f+1)/2;const m=r[l][c],p=Math.max(0,1-m/15);f=f*.6+p*.4;const g=(1-i[l][c])*.2;f+=g,a[l][c]=S(f,0,1)}}return a}function _e(e,t,i){const n=Array.from({length:t},()=>new Array(e).fill(1/0)),o=[];for(let r=0;r<t;r++)for(let l=0;l<e;l++)L(i[r][l])&&(n[r][l]=0,o.push([l,r]));const s=[[0,-1],[1,0],[0,1],[-1,0]];let a=0;for(;a<o.length;){const[r,l]=o[a++];for(const[c,d]of s){const u=r+c,f=l+d;if(u>=0&&u<e&&f>=0&&f<t){const m=n[l][r]+1;m<n[f][u]&&(n[f][u]=m,o.push([u,f]))}}}return n}function qe(e,t,i,n,o,s){const a=[];for(let r=0;r<t;r++){a[r]=[];for(let l=0;l<e;l++)a[r][l]=Ae(i[r][l],n[r][l],o[r][l],s[r][l])}return a}function Ae(e,t,i,n){return L(n)?"ocean":n==="coast"?i>.6&&t<.3?"desert":"beach":n==="peak"?"snow_mountain":n==="mountain"?i<.3?"snow_mountain":"mountain":n==="highland"?"hills":i<.2?"tundra":i>.65&&t<.2?"desert":i>.6&&t<.4?"savanna":i>.7&&t>.7?"jungle":t>.75&&e<.38?"swamp":t>.65?"dense_forest":t>.4?"forest":"grassland"}const A={wood:{id:"wood",name:"Wood",category:"raw",baseValue:2,weight:3,spoilRate:0,stackSize:50,storageRequirement:"dry",description:"Raw timber from the forest."},stone:{id:"stone",name:"Stone",category:"raw",baseValue:2,weight:5,spoilRate:0,stackSize:40,storageRequirement:"none",description:"Rough quarried stone."},iron_ore:{id:"iron_ore",name:"Iron Ore",category:"raw",baseValue:4,weight:4,spoilRate:0,stackSize:30,storageRequirement:"none",description:"Unrefined iron ore from the mines."},gold_ore:{id:"gold_ore",name:"Gold Ore",category:"raw",baseValue:12,weight:5,spoilRate:0,stackSize:20,storageRequirement:"secure",description:"Raw gold-bearing rock."},coal:{id:"coal",name:"Coal",category:"raw",baseValue:3,weight:3,spoilRate:0,stackSize:40,storageRequirement:"dry",description:"Fuel for smelting and heating."},salt:{id:"salt",name:"Salt",category:"raw",baseValue:5,weight:2,spoilRate:0,stackSize:30,storageRequirement:"dry",description:"Precious preservative and seasoning."},wheat:{id:"wheat",name:"Wheat",category:"food",baseValue:2,weight:1,spoilRate:.005,stackSize:60,storageRequirement:"dry",description:"Harvested grain ready for milling."},fish:{id:"fish",name:"Fish",category:"food",baseValue:3,weight:1,spoilRate:.05,stackSize:30,storageRequirement:"cold",description:"Fresh catch from the waters."},berries:{id:"berries",name:"Berries",category:"food",baseValue:1,weight:.5,spoilRate:.08,stackSize:40,storageRequirement:"cold",description:"Wild forest berries."},meat:{id:"meat",name:"Meat",category:"food",baseValue:4,weight:2,spoilRate:.04,stackSize:25,storageRequirement:"cold",description:"Fresh game or livestock meat."},exotic_fruit:{id:"exotic_fruit",name:"Exotic Fruit",category:"food",baseValue:8,weight:1,spoilRate:.06,stackSize:20,storageRequirement:"cold",description:"Rare tropical fruit from the jungle."},wool:{id:"wool",name:"Wool",category:"material",baseValue:3,weight:1,spoilRate:0,stackSize:40,storageRequirement:"dry",description:"Raw sheep wool."},herbs:{id:"herbs",name:"Herbs",category:"material",baseValue:4,weight:.5,spoilRate:.02,stackSize:30,storageRequirement:"dry",description:"Medicinal and culinary herbs."},rare_herbs:{id:"rare_herbs",name:"Rare Herbs",category:"material",baseValue:15,weight:.5,spoilRate:.02,stackSize:15,storageRequirement:"dry",description:"Rare plants with potent properties."},hides:{id:"hides",name:"Hides",category:"material",baseValue:4,weight:2,spoilRate:.01,stackSize:25,storageRequirement:"dry",description:"Animal skins ready for tanning."},lumber:{id:"lumber",name:"Lumber",category:"processed",baseValue:5,weight:4,spoilRate:0,stackSize:40,storageRequirement:"dry",description:"Milled timber planks."},iron_ingot:{id:"iron_ingot",name:"Iron Ingot",category:"processed",baseValue:10,weight:3,spoilRate:0,stackSize:25,storageRequirement:"none",description:"Smelted iron bar."},gold_ingot:{id:"gold_ingot",name:"Gold Ingot",category:"processed",baseValue:30,weight:4,spoilRate:0,stackSize:15,storageRequirement:"secure",description:"Pure gold bar."},bread:{id:"bread",name:"Bread",category:"food",baseValue:4,weight:.5,spoilRate:.03,stackSize:40,storageRequirement:"dry",description:"Freshly baked bread."},fabric:{id:"fabric",name:"Fabric",category:"processed",baseValue:8,weight:1,spoilRate:0,stackSize:30,storageRequirement:"dry",description:"Woven cloth from wool."},leather:{id:"leather",name:"Leather",category:"processed",baseValue:8,weight:1.5,spoilRate:0,stackSize:25,storageRequirement:"dry",description:"Tanned animal leather."},tools:{id:"tools",name:"Tools",category:"processed",baseValue:15,weight:3,spoilRate:0,stackSize:15,storageRequirement:"dry",description:"Iron tools for crafting and farming."},ale:{id:"ale",name:"Ale",category:"processed",baseValue:5,weight:2,spoilRate:.01,stackSize:25,storageRequirement:"cold",description:"Brewed ale from wheat."},medicine:{id:"medicine",name:"Medicine",category:"processed",baseValue:20,weight:.5,spoilRate:.01,stackSize:15,storageRequirement:"dry",description:"Herbal remedies and poultices."},weapons:{id:"weapons",name:"Weapons",category:"military",baseValue:25,weight:3,spoilRate:0,stackSize:10,storageRequirement:"dry",description:"Forged iron swords and spears."},armor:{id:"armor",name:"Armor",category:"military",baseValue:35,weight:5,spoilRate:0,stackSize:8,storageRequirement:"dry",description:"Iron and leather body armor."},sheep:{id:"sheep",name:"Sheep",category:"raw",baseValue:8,weight:10,spoilRate:0,stackSize:20,storageRequirement:"none",description:"Woolly livestock — source of wool and meat."},deer:{id:"deer",name:"Deer",category:"raw",baseValue:6,weight:8,spoilRate:0,stackSize:10,storageRequirement:"none",description:"Wild deer — source of meat and hides."}},Ce=[{resourceId:"wood",biomes:["forest","dense_forest","jungle"],chance:.4,amountRange:[50,200],replenishRate:.5},{resourceId:"deer",biomes:["forest","dense_forest","grassland"],chance:.15,amountRange:[5,20],replenishRate:.1},{resourceId:"berries",biomes:["forest","dense_forest"],chance:.2,amountRange:[10,40],replenishRate:.3},{resourceId:"herbs",biomes:["forest","swamp","grassland"],chance:.15,amountRange:[5,20],replenishRate:.2},{resourceId:"rare_herbs",biomes:["dense_forest","jungle","swamp"],chance:.05,amountRange:[2,8],replenishRate:.05},{resourceId:"wheat",biomes:["grassland","savanna"],chance:.3,amountRange:[20,60],replenishRate:0},{resourceId:"sheep",biomes:["grassland","hills","savanna"],chance:.15,amountRange:[5,20],replenishRate:.1},{resourceId:"iron_ore",biomes:["mountain","hills"],chance:.25,amountRange:[30,150],replenishRate:0},{resourceId:"gold_ore",biomes:["mountain","desert"],chance:.08,amountRange:[10,60],replenishRate:0},{resourceId:"coal",biomes:["mountain","hills"],chance:.2,amountRange:[40,120],replenishRate:0},{resourceId:"stone",biomes:["mountain","hills","tundra","snow_mountain"],chance:.3,amountRange:[50,200],replenishRate:0},{resourceId:"fish",biomes:["beach"],chance:.4,amountRange:[30,80],replenishRate:.5},{resourceId:"salt",biomes:["beach","desert"],chance:.1,amountRange:[20,60],replenishRate:0},{resourceId:"exotic_fruit",biomes:["jungle"],chance:.2,amountRange:[10,30],replenishRate:.3}];function Ee(e,t,i,n){for(let o=0;o<i;o++)for(let s=0;s<t;s++){const a=e[o][s],r=a.biome,l=Ce.filter(u=>u.biomes.includes(r));let c=null,d=0;for(const u of l)if(n.chance(u.chance)){const f=n.nextInt(u.amountRange[0],u.amountRange[1]),m=A[u.resourceId],p=f*(m?.baseValue??1);p>d&&(d=p,c={resourceId:u.resourceId,amount:f,maxAmount:f,replenishRate:u.replenishRate})}a.resourceDeposit=c}}const q={ocean:{type:"ocean",name:"Ocean",description:"Deep open waters, impassable without a ship.",movementCost:1/0,elevationRange:[0,.25],moistureRange:[0,1],temperatureRange:[0,1],baseColor:"#1a5276",vegetationDensity:0,possibleResources:["fish"],dangerLevel:.3,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:1,productionMultiplier:.5},summer:{movementMultiplier:1,productionMultiplier:1}}},beach:{type:"beach",name:"Beach",description:"Sandy coastline where land meets sea.",movementCost:1.3,elevationRange:[.25,.32],moistureRange:[.3,1],temperatureRange:[.3,1],baseColor:"#e8d4a2",vegetationDensity:.05,possibleResources:["fish","salt"],dangerLevel:.1,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.2,productionMultiplier:.7},summer:{movementMultiplier:1,productionMultiplier:1}}},desert:{type:"desert",name:"Desert",description:"Arid wasteland with scorching heat and little water.",movementCost:2,elevationRange:[.3,.55],moistureRange:[0,.15],temperatureRange:[.65,1],baseColor:"#d4a843",vegetationDensity:.02,possibleResources:["gold_ore","stone"],dangerLevel:.3,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:.9,productionMultiplier:.9},summer:{movementMultiplier:1.3,productionMultiplier:.7}}},grassland:{type:"grassland",name:"Grassland",description:"Fertile plains with tall grasses — ideal for farming.",movementCost:1,elevationRange:[.3,.5],moistureRange:[.25,.6],temperatureRange:[.3,.7],baseColor:"#5a9c3a",vegetationDensity:.3,possibleResources:["wheat","sheep","herbs"],dangerLevel:.1,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.2,productionMultiplier:.3},summer:{movementMultiplier:1,productionMultiplier:1.2}}},forest:{type:"forest",name:"Forest",description:"Temperate woodland rich in timber and wildlife.",movementCost:1.5,elevationRange:[.32,.55],moistureRange:[.4,.75],temperatureRange:[.25,.65],baseColor:"#2d6b1e",vegetationDensity:.7,possibleResources:["wood","deer","berries","herbs"],dangerLevel:.2,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.5,productionMultiplier:.4},summer:{movementMultiplier:1,productionMultiplier:1}}},dense_forest:{type:"dense_forest",name:"Dense Forest",description:"Thick, dark woodland — hard to traverse but full of secrets.",movementCost:2.5,elevationRange:[.32,.55],moistureRange:[.65,1],temperatureRange:[.25,.65],baseColor:"#1a4c0c",vegetationDensity:.9,possibleResources:["wood","deer","berries","herbs","rare_herbs"],dangerLevel:.4,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:2,productionMultiplier:.2},summer:{movementMultiplier:1,productionMultiplier:.8}}},jungle:{type:"jungle",name:"Jungle",description:"Lush tropical rainforest teeming with life and danger.",movementCost:3,elevationRange:[.3,.5],moistureRange:[.75,1],temperatureRange:[.7,1],baseColor:"#1a6b1a",vegetationDensity:.95,possibleResources:["wood","rare_herbs","exotic_fruit"],dangerLevel:.5,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:1.1,productionMultiplier:.9},summer:{movementMultiplier:1,productionMultiplier:1}}},hills:{type:"hills",name:"Hills",description:"Rolling grassy hills with stone outcrops — good for grazing.",movementCost:1.5,elevationRange:[.5,.65],moistureRange:[.2,.6],temperatureRange:[.2,.7],baseColor:"#8c9c5c",vegetationDensity:.25,possibleResources:["stone","iron_ore","sheep","coal"],dangerLevel:.15,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.5,productionMultiplier:.5},summer:{movementMultiplier:1,productionMultiplier:1}}},mountain:{type:"mountain",name:"Mountains",description:"Tall rocky peaks — dangerous but rich in ore.",movementCost:3,elevationRange:[.65,.82],moistureRange:[0,1],temperatureRange:[0,1],baseColor:"#7c7c7c",vegetationDensity:.05,possibleResources:["iron_ore","gold_ore","stone","coal"],dangerLevel:.4,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:2.5,productionMultiplier:.3},summer:{movementMultiplier:1,productionMultiplier:.9}}},snow_mountain:{type:"snow_mountain",name:"Snow-capped Peaks",description:"Frozen mountain heights — nearly impassable.",movementCost:5,elevationRange:[.82,1],moistureRange:[0,1],temperatureRange:[0,.3],baseColor:"#c8c8d8",vegetationDensity:0,possibleResources:["stone"],dangerLevel:.6,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:3,productionMultiplier:.1},summer:{movementMultiplier:1,productionMultiplier:.5}}},tundra:{type:"tundra",name:"Tundra",description:"Frozen wasteland with permafrost and harsh winds.",movementCost:2,elevationRange:[.3,.65],moistureRange:[.1,.5],temperatureRange:[0,.2],baseColor:"#a8b8a0",vegetationDensity:.05,possibleResources:["stone","iron_ore"],dangerLevel:.35,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:2,productionMultiplier:.1},summer:{movementMultiplier:1,productionMultiplier:.6}}},swamp:{type:"swamp",name:"Swamp",description:"Murky wetlands — treacherous but with rare herbs.",movementCost:2.5,elevationRange:[.28,.38],moistureRange:[.7,1],temperatureRange:[.3,.7],baseColor:"#4c6c3c",vegetationDensity:.5,possibleResources:["herbs","rare_herbs","fish"],dangerLevel:.35,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:1.5,productionMultiplier:.3},summer:{movementMultiplier:1,productionMultiplier:.8}}},savanna:{type:"savanna",name:"Savanna",description:"Dry grasslands with scattered trees and roaming herds.",movementCost:1.2,elevationRange:[.3,.5],moistureRange:[.15,.35],temperatureRange:[.6,.9],baseColor:"#b8a848",vegetationDensity:.15,possibleResources:["wheat","sheep","herbs"],dangerLevel:.2,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1,productionMultiplier:.8},summer:{movementMultiplier:1.1,productionMultiplier:1}}}},We=["Aldric","Bran","Cedric","Doran","Edric","Finn","Gareth","Harald","Ivan","Jasper","Kael","Leif","Magnus","Nolan","Oswin","Percival","Quinn","Rowan","Silas","Theron","Ulric","Voss","Wren","Yorick","Zephyr","Alden","Bjorn","Corwin","Dorian","Elric","Felix","Gideon","Hector","Ingram","Jareth","Kellan","Lorcan","Merrick","Nigel","Orin","Phelan","Ragnar","Stellan","Torin","Uther","Vidar","Wolfric","Arden"],Be=["Alara","Brynn","Celeste","Daria","Elara","Freya","Gwendolyn","Helena","Isolde","Juna","Kira","Lyra","Miriel","Nessa","Orla","Petra","Rosalind","Seren","Thea","Una","Vera","Wilda","Ysolde","Zara","Aelith","Brigid","Cordelia","Dahlia","Eira","Fiona","Greta","Hilda","Iris","Jorunn","Katla","Lena","Maren","Niamh","Olwen","Rhiannon","Sigrid","Talia","Ursa","Violet","Wynne","Astrid","Rowena","Svea"],ge=["Ironforge","Stonewall","Blackthorn","Ashwood","Silverbrook","Goldcrest","Ravenhill","Oakenshield","Winterborne","Thornfield","Brightwater","Darkmoor","Greycloak","Hawkswood","Nightingale","Redstone","Whitewolf","Greenhollow","Stormborn","Firebrand","Coldwell","Deepwood","Fairweather","Highforge","Longstrider","Meadowbrook","Northwind","Proudfoot","Quicksilver","Riverton","Strongbow","Truehart","Underhill","Wildwood","Copperfield","Dunmore","Elderwood","Foxglove","Grimshaw","Heathrow","Kettleblack","Marshwood","Oakridge","Pennywhistle","Sagewind","Thornwick","Valeborn","Woodhaven"],xe=["Stone","Iron","Green","White","Black","Red","Gold","Silver","Oak","Elm","Ash","Thorn","Raven","Wolf","Bear","Hawk","River","Lake","Hill","Dale","Glen","Mist","Storm","Frost","High","Low","North","South","East","West","Old","New","Dark","Bright","Deep","Long","Fair","Cold","Warm","Wild"],ze=["haven","hold","stead","gate","ford","bridge","burgh","ton","dale","vale","field","wood","moor","wick","mere","marsh","crest","peak","fall","reach","watch","guard","wall","helm","keep","rock","port","bay","cove","shore","cross","way"],He=["Kingdom of {name}","Realm of {name}","Duchy of {name}","Principality of {name}","Dominion of {name}","{name}","The {adj} Kingdom","Land of {name}","Free City of {name}"],$e=["Northern","Southern","Eastern","Western","United","Holy","Grand","Great","Ancient","Iron","Golden","Silver"],Pe=["Valderia","Aethelmark","Norheim","Sunreach","Frostholme","Thornwall","Ashenmoor","Brightwind","Ironvale","Goldcrest","Ravenshire","Stormhold","Deepwood","Highreach","Westmarch","Silverkeep","Darkhollow","Greenholme","Redspire","Whitecliff"],Oe=["Pyraxis","Vorthrun","Ashenwing","Glacius","Thundermaw","Nightfang","Emberclaw","Stormscale","Dreadfire","Shadowcoil","Ironhide","Frostbite","Cinderjaw","Deathwing","Silvanus"];function Ne(e){return`${e.pick(We)} ${e.pick(ge)}`}function Fe(e){return`${e.pick(Be)} ${e.pick(ge)}`}function J(e,t){return t==="male"?Ne(e):Fe(e)}function Ye(e){return`${e.pick(xe)}${e.pick(ze)}`}function Ge(e){const t=e.pick(He),i=e.pick(Pe),n=e.pick($e);return t.replace("{name}",i).replace("{adj}",n)}function Ve(e){return e.pick(Oe)}const Xe=6,je=40;function Ue(e,t,i,n){const o=q[e.biome];if(!o||!o.canBuildSettlement)return 0;let s=0;e.elevation>=.33&&e.elevation<=.55?s+=3:e.elevation>=.55&&e.elevation<=.65&&(s+=1);let a=!1;for(let l=-3;l<=3;l++)for(let c=-3;c<=3;c++){const d=e.x+c,u=e.y+l;if(d>=0&&d<i&&u>=0&&u<n){const f=t[u][d].terrainType;(f==="shallow_ocean"||f==="coast")&&(a=!0)}}a&&(s+=3);let r=0;for(let l=-4;l<=4;l++)for(let c=-4;c<=4;c++){const d=e.x+c,u=e.y+l;if(d>=0&&d<i&&u>=0&&u<n){const f=t[u][d].resourceDeposit;f&&(r+=f.amount*.01)}}return s+=Math.min(r,5),e.biome==="grassland"&&(s+=2),e.biome==="forest"&&(s+=1),e.biome==="hills"&&(s+=1),e.biome==="beach"&&(s+=1),e.temperature>.3&&e.temperature<.7&&(s+=1),s}function Qe(e,t,i,n,o){let s=!1;for(let a=-2;a<=2;a++)for(let r=-2;r<=2;r++){const l=e.x+r,c=e.y+a;l>=0&&l<i&&c>=0&&c<n&&t[c][l].terrainType==="shallow_ocean"&&(s=!0)}return s&&o.chance(.5)?"fishing_village":(e.resourceDeposit?.resourceId==="iron_ore"||e.resourceDeposit?.resourceId==="gold_ore"||e.resourceDeposit?.resourceId==="coal")&&o.chance(.3)?"mine":e.biome==="grassland"&&o.chance(.3)?"farm":(e.biome==="forest"||e.biome==="dense_forest")&&o.chance(.2)?"lumber_camp":o.chance(.5)?"hamlet":"homestead"}function Ke(e,t){const i=[],n=(o,s=1)=>{i.push({type:o,level:s,condition:80+t.nextInt(0,20),workerId:null,isOperational:!0})};switch(e){case"homestead":n("house"),n("farm_field");break;case"hamlet":for(let o=0;o<t.nextInt(3,5);o++)n("house");n("farm_field"),t.chance(.5)&&n("hunter_lodge");break;case"village":for(let o=0;o<t.nextInt(6,10);o++)n("house");for(let o=0;o<2;o++)n("farm_field");n("market"),n("tavern"),t.chance(.5)&&n("blacksmith"),t.chance(.4)&&n("church");break;case"town":for(let o=0;o<t.nextInt(12,20);o++)n("house");for(let o=0;o<3;o++)n("farm_field");n("market"),n("tavern"),n("blacksmith"),n("church"),n("barracks"),n("warehouse"),n("wall"),t.chance(.5)&&n("guild_hall"),t.chance(.5)&&n("bakery");break;case"farm":n("house");for(let o=0;o<t.nextInt(2,4);o++)n("farm_field");break;case"mine":n("house"),n("mine_shaft"),t.chance(.4)&&n("smelter");break;case"lumber_camp":n("house"),n("sawmill");break;case"fishing_village":for(let o=0;o<t.nextInt(3,6);o++)n("house");n("dock"),t.chance(.4)&&n("tavern");break;default:n("house");break}return i}function Ze(e,t,i,n){const o=new Map,s=[],a=[];for(let r=0;r<i;r++)for(let l=0;l<t;l++){const c=Ue(e[r][l],e,t,i);c>0&&a.push({x:l,y:r,score:c})}a.sort((r,l)=>l.score+n.next()*2-(r.score+n.next()*2));for(const r of a){if(o.size>=je)break;if(s.some(y=>X(y,r)<Xe))continue;const c=e[r.y][r.x],d=Qe(c,e,t,i,n);let u=d;o.size<3&&(d==="hamlet"||d==="homestead")?u="town":o.size<8&&d==="homestead"&&n.chance(.3)&&(u="village");const f=_("loc"),m=Ye(n),p=Ke(u,n),g=p.filter(y=>y.type==="house").length,k={id:f,name:m,type:u,position:{x:r.x,y:r.y},size:g,populationCapacity:g*4,residentIds:[],buildings:p,productionSites:[],storage:Je(u,n),storageCapacity:{none:200,dry:100,cold:30,secure:20},tradeRouteIds:[],marketPrices:{},defenseLevel:u==="town"?3:u==="village"?1:0,wallLevel:u==="town"?1:0,garrisonIds:[],ownerId:null,countryId:null,prosperity:50+n.nextInt(-10,10),safety:60+n.nextInt(-10,10),happiness:50+n.nextInt(-5,5),foundedTurn:0,isDestroyed:!1,growthPoints:0};o.set(f,k),c.locationId=f,s.push({x:r.x,y:r.y})}return o}function Je(e,t){const i=[],n=(o,s)=>{i.push({resourceId:o,quantity:s,quality:.7,age:0})};switch(n("wheat",t.nextInt(5,15)),e){case"town":case"city":n("bread",t.nextInt(10,30)),n("wheat",t.nextInt(10,20)),n("wood",t.nextInt(10,25)),n("stone",t.nextInt(5,15)),n("iron_ore",t.nextInt(3,10)),n("tools",t.nextInt(3,8)),n("fabric",t.nextInt(2,6)),n("ale",t.nextInt(5,15)),t.chance(.3)&&n("weapons",t.nextInt(1,4));break;case"village":n("bread",t.nextInt(5,15)),n("wood",t.nextInt(5,15)),n("tools",t.nextInt(1,4));break;case"hamlet":case"homestead":n("wood",t.nextInt(3,10));break;case"farm":n("wheat",t.nextInt(10,25)),n("sheep",t.nextInt(2,6));break;case"mine":n("iron_ore",t.nextInt(5,15)),n("coal",t.nextInt(5,10)),n("stone",t.nextInt(5,10));break;case"lumber_camp":n("wood",t.nextInt(15,30));break;case"fishing_village":n("fish",t.nextInt(5,15));break;case"port":n("fish",t.nextInt(10,20)),n("bread",t.nextInt(5,10)),n("ale",t.nextInt(3,8));break}return i}class et{data=[];get size(){return this.data.length}push(t){this.data.push(t),this.bubbleUp(this.data.length-1)}pop(){if(this.data.length===0)return;const t=this.data[0],i=this.data.pop();return this.data.length>0&&(this.data[0]=i,this.bubbleDown(0)),t}bubbleUp(t){for(;t>0;){const i=t-1>>1;if(this.data[t].cost>=this.data[i].cost)break;[this.data[t],this.data[i]]=[this.data[i],this.data[t]],t=i}}bubbleDown(t){const i=this.data.length;for(;;){let n=t;const o=2*t+1,s=2*t+2;if(o<i&&this.data[o].cost<this.data[n].cost&&(n=o),s<i&&this.data[s].cost<this.data[n].cost&&(n=s),n===t)break;[this.data[t],this.data[n]]=[this.data[n],this.data[t]],t=n}}}function Q(e){return`${e.x},${e.y}`}function ye(e,t,i,n,o){const s=new et,a=new Map,r=new Map,l=new Map,c=Q(e);r.set(c,0),l.set(c,B(e,t)),s.push({pos:e,cost:l.get(c)});const d=new Set;for(;s.size>0;){const u=s.pop(),f=Q(u.pos);if(u.pos.x===t.x&&u.pos.y===t.y){const p=[];let g=t;for(;g;)p.unshift(g),g=a.get(Q(g));return p}if(d.has(f))continue;d.add(f);const m=Re(u.pos,i,n);for(const p of m){const g=Q(p);if(d.has(g))continue;const k=o(p.x,p.y);if(k>=1/0)continue;const y=(r.get(f)??1/0)+k,I=r.get(g)??1/0;if(y<I){a.set(g,u.pos),r.set(g,y);const v=y+B(p,t);l.set(g,v),s.push({pos:p,cost:v})}}}return[]}const tt=40;function it(e){if(L(e.terrainType))return 1/0;const t=q[e.biome];if(!t)return 5;let i=t.movementCost;return e.roadLevel>=3?i*=.3:e.roadLevel>=2?i*=.5:e.roadLevel>=1&&(i*=.7),i+=Math.max(0,e.elevation-.5)*2,i}function nt(e,t,i,n){const o=Array.from(t.values()).filter(r=>!r.isDestroyed&&r.type!=="dungeon"&&r.type!=="ruins"),s=[];for(let r=0;r<o.length;r++)for(let l=r+1;l<o.length;l++){const c=X(o[r].position,o[l].position);c<tt&&s.push({a:o[r],b:o[l],dist:c})}s.sort((r,l)=>{const c=x(r.a)+x(r.b),d=x(l.a)+x(l.b);return r.dist/c-l.dist/d});const a=Math.min(s.length,o.length*2);for(let r=0;r<a;r++){const l=s[r],c=ye(l.a.position,l.b.position,i,n,(f,m)=>it(e[m][f]));if(c.length===0)continue;const d=x(l.a)+x(l.b),u=d>=6?3:d>=3?2:1;for(const f of c){const m=e[f.y][f.x];m.roadLevel=Math.max(m.roadLevel,u)}}}function x(e){switch(e.type){case"city":return 5;case"town":return 4;case"castle":return 4;case"port":return 3;case"village":return 2;case"hamlet":return 1;default:return 1}}const ot={homestead:[["farmer",5],["hunter",2],["unemployed",1]],hamlet:[["farmer",5],["hunter",2],["miner",1],["lumberjack",2],["unemployed",1]],village:[["farmer",4],["hunter",2],["blacksmith",1],["baker",1],["weaver",1],["merchant",1],["guard",1],["priest",.5],["unemployed",1]],town:[["farmer",3],["hunter",1],["blacksmith",2],["baker",1],["weaver",1],["brewer",1],["tanner",1],["merchant",2],["soldier",2],["guard",2],["scholar",.5],["priest",1],["herbalist",1],["unemployed",1]],city:[["farmer",2],["blacksmith",2],["baker",2],["weaver",2],["brewer",1],["tanner",1],["merchant",3],["soldier",3],["guard",3],["scholar",1],["priest",1],["herbalist",1],["noble",.5],["unemployed",1]],mine:[["miner",5],["farmer",1],["unemployed",1]],farm:[["farmer",6],["unemployed",1]],lumber_camp:[["lumberjack",5],["farmer",1],["unemployed",1]],fishing_village:[["fisher",5],["farmer",1],["merchant",1],["unemployed",1]],port:[["fisher",3],["merchant",3],["soldier",1],["guard",2],["baker",1],["unemployed",1]],castle:[["soldier",4],["guard",3],["noble",1],["unemployed",2],["blacksmith",1]]},st={homestead:[2,4],hamlet:[5,12],village:[12,25],town:[25,50],city:[50,80],mine:[3,8],farm:[2,6],lumber_camp:[3,6],fishing_village:[6,15],port:[15,30],castle:[10,25]};function K(e,t,i,n="unemployed"){const o=e.chance(.5)?"male":"female",s=J(e,o),a=at(e,n),r=rt(e,n),l=lt(e);return{id:_("ch"),name:s,age:a,gender:o,position:{...t},homeLocationId:i,jobType:n,health:50+r.endurance*5,maxHealth:50+r.endurance*5,stats:r,needs:{food:70+e.nextInt(-10,10),shelter:i?80:30,safety:60+e.nextInt(-10,10),social:50+e.nextInt(-10,10),purpose:n!=="unemployed"?60:30},personality:l,relationships:[],skills:ct(e,n),inventory:[],gold:e.nextInt(0,20),equippedWeapon:null,equippedArmor:null,isAlive:!0,currentAction:null,destination:null,turnsUntilArrival:0,title:null,lordId:null,vassalIds:[],ownedLocationIds:[],knownLocationIds:i?[i]:[],flags:{}}}function at(e,t){return t==="child"?e.nextInt(0,14):t==="elder"?e.nextInt(55,75):t==="noble"?e.nextInt(25,55):t==="soldier"||t==="guard"?e.nextInt(18,40):t==="scholar"||t==="priest"?e.nextInt(25,60):e.nextInt(16,50)}function rt(e,t){const i=()=>e.nextInt(3,8),n={strength:i(),dexterity:i(),intelligence:i(),charisma:i(),endurance:i()};switch(t){case"farmer":n.strength+=2,n.endurance+=2;break;case"miner":n.strength+=3,n.endurance+=2;break;case"blacksmith":n.strength+=3,n.dexterity+=1;break;case"soldier":n.strength+=2,n.dexterity+=2,n.endurance+=2;break;case"hunter":n.dexterity+=3,n.endurance+=1;break;case"merchant":n.charisma+=3,n.intelligence+=1;break;case"scholar":n.intelligence+=4;break;case"noble":n.charisma+=2,n.intelligence+=2;break;case"adventurer":n.strength+=1,n.dexterity+=1,n.endurance+=1,n.charisma+=1;break}return n}function lt(e){return{ambition:e.next(),courage:e.next(),greed:e.next(),loyalty:e.next(),kindness:e.next(),curiosity:e.next()}}function ct(e,t){const i={};switch(i.combat=e.nextInt(1,15),i.survival=e.nextInt(5,20),t){case"farmer":i.farming=e.nextInt(20,60),i.cooking=e.nextInt(10,30);break;case"miner":i.mining=e.nextInt(20,60);break;case"lumberjack":i.woodworking=e.nextInt(20,60);break;case"fisher":i.fishing=e.nextInt(20,60);break;case"blacksmith":i.blacksmithing=e.nextInt(25,65),i.smelting=e.nextInt(15,40);break;case"weaver":i.weaving=e.nextInt(25,60);break;case"baker":i.cooking=e.nextInt(25,60);break;case"brewer":i.brewing=e.nextInt(25,60);break;case"tanner":i.leatherworking=e.nextInt(25,60);break;case"merchant":i.trading=e.nextInt(25,65),i.persuasion=e.nextInt(15,40);break;case"soldier":case"guard":i.combat=e.nextInt(30,70),i.tactics=e.nextInt(10,30);break;case"hunter":i.hunting=e.nextInt(25,60),i.combat=e.nextInt(15,40),i.survival=e.nextInt(20,50);break;case"herbalist":i.herbalism=e.nextInt(25,60);break;case"scholar":i.lore=e.nextInt(30,70);break;case"priest":i.healing=e.nextInt(20,50),i.persuasion=e.nextInt(15,40);break;case"noble":i.tactics=e.nextInt(15,40),i.persuasion=e.nextInt(20,50),i.trading=e.nextInt(10,30);break;case"adventurer":i.combat=e.nextInt(20,50),i.survival=e.nextInt(20,50),i.lore=e.nextInt(10,30);break}return i}function dt(e,t){const i=new Map;for(const n of e.values()){if(n.isDestroyed)continue;const o=st[n.type]??[2,6],s=t.nextInt(o[0],o[1]),a=ot[n.type]??[["farmer",3],["unemployed",2]];let r=0;for(;r<s;){const c=Math.min(t.nextInt(1,4),s-r),d=t.weightedPick(a),u=K(t,n.position,n.id,d);if(u.age=t.nextInt(25,50),u.gold=t.nextInt(5,40),i.set(u.id,u),n.residentIds.push(u.id),r++,c>=2){const f=u.gender==="male"?"female":"male",m=t.weightedPick(a),p=K(t,n.position,n.id,m);p.gender=f,p.name=J(t,f),p.age=u.age+t.nextInt(-5,5),i.set(p.id,p),n.residentIds.push(p.id),r++,u.relationships.push({targetId:p.id,type:"spouse",strength:60+t.nextInt(0,30)}),p.relationships.push({targetId:u.id,type:"spouse",strength:60+t.nextInt(0,30)});for(let g=2;g<c&&r<s;g++){const k=t.nextInt(1,Math.max(1,u.age-18)),y=t.chance(.5)?"male":"female",I=k<15?"child":t.weightedPick(a),v=K(t,n.position,n.id,I);v.gender=y,v.name=J(t,y),v.age=k,i.set(v.id,v),n.residentIds.push(v.id),r++,u.relationships.push({targetId:v.id,type:"child",strength:70+t.nextInt(0,20)}),v.relationships.push({targetId:u.id,type:"parent",strength:60+t.nextInt(0,30)}),p.relationships.push({targetId:v.id,type:"child",strength:70+t.nextInt(0,20)}),v.relationships.push({targetId:p.id,type:"parent",strength:60+t.nextInt(0,30)})}}}ut(n,i);const l=[...n.residentIds];for(let c=0;c<Math.min(5,l.length);c++){const d=i.get(t.pick(l)),u=i.get(t.pick(l));d&&u&&d.id!==u.id&&(d.relationships.find(m=>m.targetId===u.id)||(t.chance(.7)?(d.relationships.push({targetId:u.id,type:"friend",strength:t.nextInt(20,60)}),u.relationships.push({targetId:d.id,type:"friend",strength:t.nextInt(20,60)})):(d.relationships.push({targetId:u.id,type:"rival",strength:t.nextInt(-40,-10)}),u.relationships.push({targetId:d.id,type:"rival",strength:t.nextInt(-40,-10)}))))}}return i}function ut(e,t,i){const n={farm_field:["farmer"],mine_shaft:["miner"],sawmill:["lumberjack"],blacksmith:["blacksmith"],weaponsmith:["blacksmith","soldier"],armorer:["blacksmith"],bakery:["baker"],brewery:["brewer"],weaver:["weaver"],tanner:["tanner"],dock:["fisher"],apothecary:["herbalist"],hunter_lodge:["hunter"],barracks:["soldier"],church:["priest"],market:["merchant"]};for(const o of e.buildings){if(o.workerId)continue;const s=n[o.type];if(s)for(const a of e.residentIds){const r=t.get(a);if(r&&s.includes(r.jobType)&&!ht(r.id,e)){o.workerId=r.id;break}}}}function ht(e,t){return t.buildings.some(i=>i.workerId===e)}const de={wolf:{type:"wolf",name:"Wolf",baseHealth:25,baseAttack:8,baseDefense:3,baseSpeed:4,defaultBehavior:"hunting",hostile:!0,wanderRadius:8,preferredBiomes:["forest","dense_forest","hills","tundra"],packSize:[3,7],lootTable:[{resourceId:"hides",chance:.8,quantity:[1,2]},{resourceId:"meat",chance:.6,quantity:[1,2]}],description:"Cunning pack hunters that roam forests and hills."},bear:{type:"bear",name:"Bear",baseHealth:60,baseAttack:14,baseDefense:6,baseSpeed:2,defaultBehavior:"territorial",hostile:!1,wanderRadius:5,preferredBiomes:["forest","dense_forest","hills","mountain"],packSize:[1,2],lootTable:[{resourceId:"hides",chance:.9,quantity:[2,4]},{resourceId:"meat",chance:.8,quantity:[3,5]}],description:"Powerful solitary predator — territorial but avoids conflict."},deer:{type:"deer",name:"Deer",baseHealth:15,baseAttack:2,baseDefense:1,baseSpeed:5,defaultBehavior:"passive",hostile:!1,wanderRadius:10,preferredBiomes:["forest","grassland","hills"],packSize:[3,8],lootTable:[{resourceId:"meat",chance:1,quantity:[2,3]},{resourceId:"hides",chance:.9,quantity:[1,2]}],description:"Graceful woodland creatures — a valuable game animal."},sheep:{type:"sheep",name:"Wild Sheep",baseHealth:10,baseAttack:1,baseDefense:1,baseSpeed:3,defaultBehavior:"passive",hostile:!1,wanderRadius:6,preferredBiomes:["grassland","hills","savanna"],packSize:[5,15],lootTable:[{resourceId:"wool",chance:1,quantity:[1,3]},{resourceId:"meat",chance:.5,quantity:[1,1]}],description:"Docile grazers valued for wool and meat."},boar:{type:"boar",name:"Wild Boar",baseHealth:35,baseAttack:10,baseDefense:5,baseSpeed:3,defaultBehavior:"territorial",hostile:!1,wanderRadius:6,preferredBiomes:["forest","dense_forest","swamp"],packSize:[2,5],lootTable:[{resourceId:"meat",chance:.9,quantity:[2,4]},{resourceId:"hides",chance:.7,quantity:[1,2]}],description:"Aggressive when provoked — a dangerous quarry."},dragon:{type:"dragon",name:"Dragon",baseHealth:500,baseAttack:50,baseDefense:30,baseSpeed:6,defaultBehavior:"territorial",hostile:!0,wanderRadius:20,preferredBiomes:["mountain","snow_mountain"],packSize:[1,1],lootTable:[{resourceId:"gold_ore",chance:1,quantity:[10,30]},{resourceId:"rare_herbs",chance:.5,quantity:[3,8]}],description:"Ancient and terrifying — the apex predator of legends."},bandit:{type:"bandit",name:"Bandits",baseHealth:30,baseAttack:10,baseDefense:5,baseSpeed:3,defaultBehavior:"raiding",hostile:!0,wanderRadius:12,preferredBiomes:["forest","hills","dense_forest"],packSize:[3,10],lootTable:[{resourceId:"weapons",chance:.3,quantity:[1,1]},{resourceId:"armor",chance:.1,quantity:[1,1]}],description:"Outlaws who prey on travelers and trade routes."}},ue=60,ft=5;function mt(e,t,i,n){const o=new Map,s=[],a={};for(const[c,d]of Object.entries(de))for(const u of d.preferredBiomes)a[u]||(a[u]=[]),a[u].push(c);let r=0;const l=ue*10;for(;s.length<ue&&r<l;){r++;const c=n.nextInt(0,t-1),d=n.nextInt(0,i-1),u=e[d][c];if(L(u.terrainType)||u.locationId||s.some(v=>Math.abs(v.x-c)+Math.abs(v.y-d)<ft))continue;const m=a[u.biome]||[];if(m.length===0)continue;const p=n.pick(m),g=de[p];if(p==="dragon"&&(Array.from(o.values()).filter(T=>T.type==="dragon").length>=3||!n.chance(.15))||p==="bandit"&&(Array.from(o.values()).filter(T=>T.type==="bandit").length>=8||!n.chance(.3)))continue;const k=n.nextInt(g.packSize[0],g.packSize[1]),y=_("creature"),I={id:y,type:p,name:p==="dragon"?Ve(n):null,position:{x:c,y:d},health:g.baseHealth*k*(.8+n.next()*.4),maxHealth:g.baseHealth*k,attack:g.baseAttack*Math.sqrt(k),defense:g.baseDefense*Math.sqrt(k),speed:g.baseSpeed,behavior:g.defaultBehavior,homePosition:{x:c,y:d},wanderRadius:g.wanderRadius,isHostile:g.hostile,loot:[],age:0,lastActionTurn:0};for(const v of g.lootTable)n.chance(v.chance)&&I.loot.push({resourceId:v.resourceId,quantity:n.nextInt(v.quantity[0],v.quantity[1])*k,quality:.5+n.next()*.5,age:0});o.set(y,I),s.push({x:c,y:d})}return o}const ne=["#c44444","#4444c4","#44c444","#c4c444","#c444c4","#44c4c4","#c48844","#8844c4","#44c488","#c44488"];function pt(e,t,i){const n=new Map,o=[],s=Array.from(e.values()).filter(c=>!c.isDestroyed&&gt(c.type)).sort((c,d)=>he(d.type)-he(c.type)),a=Math.min(Math.max(2,Math.floor(s.length/8)),ne.length),r=s.slice(0,a);for(let c=0;c<r.length;c++){const d=r[c],u=_("country"),f=Ge(i),m=yt(d,t,i),p={id:u,name:f,color:ne[c%ne.length],leaderId:m.id,capitalLocationId:d.id,locationIds:[d.id],alliances:[],enemies:[],vassalIds:[],treasury:i.nextInt(200,800),taxRate:i.nextFloat(.05,.2),militaryStrength:0,reputation:i.nextInt(-10,30),foundedTurn:0};n.set(u,p),d.countryId=u,d.ownerId=m.id,m.ownedLocationIds.push(d.id),m.title="King"}const l=Array.from(n.values());for(const c of s){if(c.countryId)continue;let d=null,u=1/0;for(const f of l){const m=e.get(f.capitalLocationId);if(!m)continue;const p=X(c.position,m.position);p<u&&(u=p,d=f)}if(d&&u<50){c.countryId=d.id,d.locationIds.push(c.id);const f=bt(c,t,i);if(f){f.lordId=d.leaderId,f.title=c.type==="town"?"Baron":"Lord",d.vassalIds.push(f.id),c.ownerId=f.id,f.ownedLocationIds.push(c.id);const m=t.get(d.leaderId);m&&(f.relationships.push({targetId:m.id,type:"lord",strength:50+i.nextInt(-20,20)}),m.relationships.push({targetId:f.id,type:"vassal",strength:30+i.nextInt(-20,20)}))}}}for(let c=0;c<l.length;c++)for(let d=c+1;d<l.length;d++){const u=e.get(l[c].capitalLocationId),f=e.get(l[d].capitalLocationId);if(!u||!f)continue;const m=X(u.position,f.position);let p="neutral",g=0;m<30&&(i.chance(.3)?(p="alliance",g=i.nextInt(20,60),l[c].alliances.push(l[d].id),l[d].alliances.push(l[c].id)):i.chance(.3)?(p="rivalry",g=i.nextInt(-60,-20),l[c].enemies.push(l[d].id),l[d].enemies.push(l[c].id)):(p="trade_agreement",g=i.nextInt(5,30))),o.push({countryAId:l[c].id,countryBId:l[d].id,type:p,strength:g,startedTurn:0})}for(const c of l)c.militaryStrength=wt(c,e);return{countries:n,diplomacy:o}}function gt(e){return["homestead","hamlet","village","town","city","castle","farm","mine","lumber_camp","fishing_village","port"].includes(e)}function he(e){return{city:10,town:8,castle:7,port:6,village:4,hamlet:2,homestead:1,mine:2,farm:1,lumber_camp:1,fishing_village:2}[e]??0}function yt(e,t,i){for(const o of e.residentIds){const s=t.get(o);if(s&&s.jobType==="noble")return s}if(e.residentIds.length>0){const o=t.get(e.residentIds[0]);if(o)return o.jobType="noble",o.title="King",o.personality.ambition=Math.max(o.personality.ambition,.7),o}const n=be(e,i);return t.set(n.id,n),e.residentIds.push(n.id),n}function bt(e,t,i){for(const n of e.residentIds){const o=t.get(n);if(o&&o.personality.ambition>.5&&o.age>=20)return o.jobType="noble",o}if(e.residentIds.length>=3){const n=be(e,i);return t.set(n.id,n),e.residentIds.push(n.id),n}return null}function be(e,t){const i=t.chance(.5)?"male":"female";return{id:_("ch"),name:J(t,i),age:t.nextInt(25,55),gender:i,position:{...e.position},homeLocationId:e.id,jobType:"noble",health:80,maxHealth:80,stats:{strength:t.nextInt(4,8),dexterity:t.nextInt(4,7),intelligence:t.nextInt(5,9),charisma:t.nextInt(6,10),endurance:t.nextInt(4,7)},needs:{food:80,shelter:90,safety:70,social:60,purpose:70},personality:{ambition:t.nextFloat(.6,1),courage:t.next(),greed:t.nextFloat(.3,.8),loyalty:t.next(),kindness:t.next(),curiosity:t.next()},relationships:[],skills:{tactics:t.nextInt(15,40),persuasion:t.nextInt(20,50),trading:t.nextInt(10,30),combat:t.nextInt(10,25)},inventory:[],gold:t.nextInt(50,300),equippedWeapon:null,equippedArmor:null,isAlive:!0,currentAction:null,destination:null,turnsUntilArrival:0,title:null,lordId:null,vassalIds:[],ownedLocationIds:[],knownLocationIds:[e.id],flags:{}}}function wt(e,t,i){let n=0;for(const o of e.locationIds){const s=t.get(o);s&&(n+=s.defenseLevel*10,n+=s.garrisonIds.length*5,n+=s.wallLevel*20)}return n}const we={width:128,height:128,seed:Date.now()};function vt(e=we,t){const{width:i,height:n,seed:o}=e,s=new H(o);t?.("Shaping continents...",.05);const a=Te(i,n,s.fork());t?.("Classifying terrain...",.15);const r=[];for(let y=0;y<n;y++){r[y]=[];for(let I=0;I<i;I++)r[y][I]=Me(a[y][I])}t?.("Simulating climate...",.25);const l=De(i,n,a,s.fork()),c=Le(i,n,a,r,s.fork());t?.("Growing biomes...",.35);const d=qe(i,n,a,c,l,r),u=[];for(let y=0;y<n;y++){u[y]=[];for(let I=0;I<i;I++){const v=q[d[y][I]];u[y][I]={x:I,y,elevation:a[y][I],moisture:c[y][I],temperature:l[y][I],terrainType:r[y][I],biome:d[y][I],vegetation:(v?.vegetationDensity??0)*(.7+s.next()*.3),features:[],resourceDeposit:null,locationId:null,roadLevel:0,explored:!1,visible:!1,riverFlow:0}}}t?.("Scattering resources...",.45),Ee(u,i,n,s.fork()),t?.("Founding settlements...",.55);const f=Ze(u,i,n,s.fork());t?.("Building roads...",.65),nt(u,f,i,n),t?.("Populating the world...",.75);const m=dt(f,s.fork());t?.("Spawning creatures...",.82);const p=mt(u,i,n,s.fork());t?.("Establishing kingdoms...",.9);const{countries:g,diplomacy:k}=pt(f,m,s.fork());return t?.("World complete!",1),{width:i,height:n,seed:o,tiles:u,locations:f,characters:m,creatures:p,countries:g,tradeRoutes:new Map,items:new Map,diplomacy:k}}const se=90,kt=["spring","summer","autumn","winter"];function It(e){const t=e%(se*4),i=Math.floor(t/se);return kt[i]}function Rt(e){return Math.floor(e/(se*4))+1}const St={spring:{clear:.3,cloudy:.25,rain:.3,storm:.1,snow:0,fog:.05,heatwave:0,blizzard:0},summer:{clear:.45,cloudy:.2,rain:.15,storm:.1,snow:0,fog:0,heatwave:.1,blizzard:0},autumn:{clear:.25,cloudy:.3,rain:.25,storm:.05,snow:.05,fog:.1,heatwave:0,blizzard:0},winter:{clear:.2,cloudy:.2,rain:.1,storm:.05,snow:.3,fog:.05,heatwave:0,blizzard:.1}},Mt=[{id:"saw_lumber",name:"Saw Lumber",buildingType:"sawmill",inputs:[{resourceId:"wood",quantity:3}],outputs:[{resourceId:"lumber",quantity:2,baseQuality:.7}],duration:2,skillRequired:"woodworking",minimumSkillLevel:5,description:"Mill raw wood into usable lumber planks."},{id:"smelt_iron",name:"Smelt Iron",buildingType:"smelter",inputs:[{resourceId:"iron_ore",quantity:2},{resourceId:"coal",quantity:1}],outputs:[{resourceId:"iron_ingot",quantity:1,baseQuality:.6}],duration:3,skillRequired:"smelting",minimumSkillLevel:10,description:"Smelt iron ore into ingots."},{id:"smelt_gold",name:"Smelt Gold",buildingType:"smelter",inputs:[{resourceId:"gold_ore",quantity:2},{resourceId:"coal",quantity:1}],outputs:[{resourceId:"gold_ingot",quantity:1,baseQuality:.7}],duration:4,skillRequired:"smelting",minimumSkillLevel:20,description:"Smelt gold ore into precious ingots."},{id:"bake_bread",name:"Bake Bread",buildingType:"bakery",inputs:[{resourceId:"wheat",quantity:3}],outputs:[{resourceId:"bread",quantity:4,baseQuality:.7}],duration:1,skillRequired:"cooking",minimumSkillLevel:5,description:"Bake nutritious bread from wheat."},{id:"weave_fabric",name:"Weave Fabric",buildingType:"weaver",inputs:[{resourceId:"wool",quantity:3}],outputs:[{resourceId:"fabric",quantity:2,baseQuality:.6}],duration:3,skillRequired:"weaving",minimumSkillLevel:10,description:"Weave wool into usable fabric."},{id:"tan_leather",name:"Tan Leather",buildingType:"tanner",inputs:[{resourceId:"hides",quantity:2}],outputs:[{resourceId:"leather",quantity:2,baseQuality:.6}],duration:3,skillRequired:"leatherworking",minimumSkillLevel:10,description:"Tan raw hides into leather."},{id:"forge_tools",name:"Forge Tools",buildingType:"blacksmith",inputs:[{resourceId:"iron_ingot",quantity:1},{resourceId:"wood",quantity:1}],outputs:[{resourceId:"tools",quantity:2,baseQuality:.6}],duration:2,skillRequired:"blacksmithing",minimumSkillLevel:15,description:"Forge iron and wood into useful tools."},{id:"forge_weapons",name:"Forge Weapons",buildingType:"weaponsmith",inputs:[{resourceId:"iron_ingot",quantity:2},{resourceId:"leather",quantity:1}],outputs:[{resourceId:"weapons",quantity:1,baseQuality:.5}],duration:4,skillRequired:"weaponsmithing",minimumSkillLevel:20,description:"Forge deadly iron weapons."},{id:"craft_armor",name:"Craft Armor",buildingType:"armorer",inputs:[{resourceId:"iron_ingot",quantity:3},{resourceId:"leather",quantity:2}],outputs:[{resourceId:"armor",quantity:1,baseQuality:.5}],duration:5,skillRequired:"armoring",minimumSkillLevel:25,description:"Craft protective armor from iron and leather."},{id:"brew_ale",name:"Brew Ale",buildingType:"brewery",inputs:[{resourceId:"wheat",quantity:3},{resourceId:"herbs",quantity:1}],outputs:[{resourceId:"ale",quantity:3,baseQuality:.6}],duration:3,skillRequired:"brewing",minimumSkillLevel:10,description:"Brew hearty ale from wheat and herbs."},{id:"make_medicine",name:"Make Medicine",buildingType:"apothecary",inputs:[{resourceId:"herbs",quantity:2}],outputs:[{resourceId:"medicine",quantity:1,baseQuality:.5}],duration:2,skillRequired:"herbalism",minimumSkillLevel:15,description:"Prepare medicinal remedies."},{id:"shear_sheep",name:"Shear Sheep",buildingType:"farm_field",inputs:[{resourceId:"sheep",quantity:1}],outputs:[{resourceId:"wool",quantity:3,baseQuality:.7},{resourceId:"meat",quantity:1,baseQuality:.7}],duration:2,skillRequired:"farming",minimumSkillLevel:5,description:"Shear wool from sheep."},{id:"butcher_deer",name:"Process Deer",buildingType:"hunter_lodge",inputs:[{resourceId:"deer",quantity:1}],outputs:[{resourceId:"meat",quantity:3,baseQuality:.7},{resourceId:"hides",quantity:2,baseQuality:.7}],duration:1,skillRequired:"hunting",minimumSkillLevel:5,description:"Butcher deer for meat and hides."},{id:"farm_wheat",name:"Farm Wheat",buildingType:"farm_field",inputs:[],outputs:[{resourceId:"wheat",quantity:4,baseQuality:.7}],duration:5,skillRequired:"farming",minimumSkillLevel:0,description:"Grow and harvest wheat."},{id:"mine_iron",name:"Mine Iron Ore",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"iron_ore",quantity:2,baseQuality:.6}],duration:3,skillRequired:"mining",minimumSkillLevel:5,description:"Extract iron ore from the earth."},{id:"mine_gold",name:"Mine Gold Ore",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"gold_ore",quantity:1,baseQuality:.5}],duration:4,skillRequired:"mining",minimumSkillLevel:15,description:"Extract precious gold ore."},{id:"mine_coal",name:"Mine Coal",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"coal",quantity:3,baseQuality:.8}],duration:2,skillRequired:"mining",minimumSkillLevel:0,description:"Extract coal from the mines."},{id:"quarry_stone",name:"Quarry Stone",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"stone",quantity:3,baseQuality:.8}],duration:2,skillRequired:"mining",minimumSkillLevel:0,description:"Quarry stone blocks."},{id:"catch_fish",name:"Catch Fish",buildingType:"dock",inputs:[],outputs:[{resourceId:"fish",quantity:3,baseQuality:.8}],duration:1,skillRequired:"fishing",minimumSkillLevel:0,description:"Catch fresh fish."},{id:"chop_wood",name:"Chop Wood",buildingType:"hunter_lodge",inputs:[],outputs:[{resourceId:"wood",quantity:3,baseQuality:.8}],duration:2,skillRequired:"woodworking",minimumSkillLevel:0,description:"Fell trees and collect wood."},{id:"gather_herbs",name:"Gather Herbs",buildingType:"apothecary",inputs:[],outputs:[{resourceId:"herbs",quantity:2,baseQuality:.6}],duration:2,skillRequired:"herbalism",minimumSkillLevel:0,description:"Gather medicinal herbs from the wild."}];function Tt(e){return Mt.filter(t=>t.buildingType===e)}function Dt(e,t,i){const n=[];for(const o of e.locations.values()){if(o.isDestroyed)continue;const s=Lt(o,e,t,i);n.push(...s),Ct(o,e),Et(o),Wt(o,e),Bt(o),xt(o)}return n}function Lt(e,t,i,n){const o=[],s=t.tiles[e.position.y]?.[e.position.x],a=s?q[s.biome]:null,r=i==="winter"?a?.seasonalEffects.winter.productionMultiplier??.5:a?.seasonalEffects.summer.productionMultiplier??1;for(const l of e.buildings){if(!l.isOperational||!l.workerId)continue;const c=Tt(l.type);if(c.length!==0)for(const d of c){const u=t.characters.get(l.workerId);if(!u||!u.isAlive)continue;const f=u.skills[d.skillRequired]??0;if(f<d.minimumSkillLevel||!_t(e,d))continue;let m=e.productionSites.find(g=>g.buildingType===l.type&&g.recipeId===d.id);m||(m={buildingType:l.type,recipeId:d.id,workerId:l.workerId,progress:0,efficiency:.5,isActive:!0},e.productionSites.push(m));const p=Math.min(f/100,.5);m.efficiency=(.5+p)*r,m.progress+=m.efficiency*(100/d.duration),m.progress>=100&&(qt(e,d),At(e,d,f,n),m.progress=0,u.skills[d.skillRequired]!==void 0&&(u.skills[d.skillRequired]=Math.min(100,(u.skills[d.skillRequired]??0)+n.nextFloat(.1,.5))),o.push(`${e.name}: Produced ${d.outputs.map(g=>g.quantity+" "+g.resourceId).join(", ")}`));break}}return o}function _t(e,t){for(const i of t.inputs)if(e.storage.filter(o=>o.resourceId===i.resourceId).reduce((o,s)=>o+s.quantity,0)<i.quantity)return!1;return!0}function qt(e,t){for(const i of t.inputs){let n=i.quantity;for(let o=e.storage.length-1;o>=0&&n>0;o--)if(e.storage[o].resourceId===i.resourceId){const s=Math.min(n,e.storage[o].quantity);e.storage[o].quantity-=s,n-=s,e.storage[o].quantity<=0&&e.storage.splice(o,1)}}}function At(e,t,i,n){for(const o of t.outputs){const s=i/200,a=Math.min(1,o.baseQuality+s+n.nextFloat(-.1,.1));ve(e,o.resourceId,o.quantity,a)}}function ve(e,t,i,n=.7){const o=A[t];if(!o)return;const s=e.storage.filter(d=>A[d.resourceId]?.storageRequirement===o.storageRequirement).reduce((d,u)=>d+u.quantity,0),a=e.storageCapacity[o.storageRequirement]??0,r=Math.max(0,a-s),l=Math.min(i,r);if(l<=0)return;const c=e.storage.find(d=>d.resourceId===t&&d.quantity<o.stackSize);if(c){const d=Math.min(l,o.stackSize-c.quantity);c.quantity+=d,c.quality=(c.quality+n)/2,d<l&&e.storage.push({resourceId:t,quantity:l-d,quality:n,age:0})}else e.storage.push({resourceId:t,quantity:l,quality:n,age:0})}function Ct(e,t){const i=e.residentIds.length;if(i===0)return;const n=i*.5;let o=0;const s=["bread","meat","fish","wheat","berries","exotic_fruit"];for(const r of s){if(o>=n)break;const l=n-o;for(let c=e.storage.length-1;c>=0;c--)if(e.storage[c].resourceId===r){const d=Math.min(l-o,e.storage[c].quantity);e.storage[c].quantity-=d,o+=d,e.storage[c].quantity<=0&&e.storage.splice(c,1)}}const a=Math.min(1,o/n);e.happiness=Math.max(0,Math.min(100,e.happiness+(a>.8?1:a>.5?0:-2)));for(const r of e.residentIds){const l=t.characters.get(r);l&&(l.needs.food=Math.min(100,a*80+10))}}function Et(e){for(let t=e.storage.length-1;t>=0;t--){const i=e.storage[t];i.age++;const n=A[i.resourceId];if(n&&n.spoilRate>0){const o=Math.ceil(i.quantity*n.spoilRate);i.quantity-=o,i.quantity<=0&&e.storage.splice(t,1)}}}function Wt(e,t){for(let n=-3;n<=3;n++)for(let o=-3;o<=3;o++){const s=e.position.x+o,a=e.position.y+n;if(s>=0&&s<t.width&&a>=0&&a<t.height){const r=t.tiles[a][s].resourceDeposit;r&&r.replenishRate>0&&(r.amount=Math.min(r.maxAmount,r.amount+r.replenishRate))}}}function Bt(e){for(const t of e.storage){const i=A[t.resourceId];if(!i)continue;const n=t.quantity/(i.stackSize*2),o=Math.max(.5,Math.min(3,1.5-n));e.marketPrices[t.resourceId]=Math.round(i.baseValue*o)}}function xt(e,t,i,n){let o=0;const s=["bread","meat","fish","wheat","berries"],a=e.storage.filter(l=>s.includes(l.resourceId)).reduce((l,c)=>l+c.quantity,0);a>e.residentIds.length*2&&(o+=2),e.prosperity>60&&(o+=1),e.tradeRouteIds.length>0&&(o+=1),e.happiness>70&&(o+=1),e.safety<30&&(o-=2),a<e.residentIds.length&&(o-=2),e.happiness<30&&(o-=1),e.growthPoints=Math.max(0,e.growthPoints+o);const r=30+(a>0?20:0)+(e.safety>50?15:0)+(e.happiness>50?15:0);e.prosperity+=Math.sign(r-e.prosperity)*.5,e.prosperity=Math.max(0,Math.min(100,e.prosperity))}const zt={hauling:20,cart:80,horse_cart:200,ship:1e3};function Ht(e,t){const i=[],n=Array.from(e.locations.values()).filter(o=>!o.isDestroyed&&o.residentIds.length>=3);for(const o of n){if(o.tradeRouteIds.length>=3)continue;const s=[];for(const l of o.storage){const c=A[l.resourceId];c&&l.quantity>c.stackSize*.5&&s.push({resourceId:l.resourceId,amount:l.quantity})}if(s.length===0)continue;let a=null,r=0;for(const l of n){if(l.id===o.id)continue;if(e.tradeRoutes.size>30)break;if(Array.from(e.tradeRoutes.values()).find(f=>f.fromLocationId===o.id&&f.toLocationId===l.id||f.fromLocationId===l.id&&f.toLocationId===o.id))continue;const d=X(o.position,l.position);if(d>30)continue;let u=0;for(const f of s){const m=l.storage.filter(g=>g.resourceId===f.resourceId).reduce((g,k)=>g+k.quantity,0),p=A[f.resourceId];m<(p?.stackSize??20)*.3&&(u+=f.amount*(p?.baseValue??1))}u/=d,o.countryId&&o.countryId===l.countryId&&(u*=1.5),u>r&&(r=u,a=l)}if(a&&r>5){const l=ye(o.position,a.position,e.width,e.height,(c,d)=>{const u=e.tiles[d][c];return L(u.terrainType)?1/0:q[u.biome]?.movementCost??3});if(l.length>0){const c=_("route"),d={id:c,fromLocationId:o.id,toLocationId:a.id,path:l,distance:l.length,transportType:$t(l.length,o,a),goods:[],merchantId:null,isActive:!0,dangerLevel:0,lastUsedTurn:0};e.tradeRoutes.set(c,d),o.tradeRouteIds.push(c),a.tradeRouteIds.push(c),i.push(`Trade route established: ${o.name} ↔ ${a.name}`)}}}return i}function $t(e,t,i){return t.type==="port"||i.type==="port"?"ship":e>15?"horse_cart":e>8?"cart":"hauling"}function Pt(e,t,i){const n=[];for(const o of e.tradeRoutes.values()){if(!o.isActive)continue;const s=e.locations.get(o.fromLocationId),a=e.locations.get(o.toLocationId);if(!s||!a||s.isDestroyed||a.isDestroyed){o.isActive=!1;continue}if(i.chance(o.dangerLevel*.1)){n.push(`Trade route ${s.name} → ${a.name} raided by bandits!`),o.isActive=!1;continue}const r=zt[o.transportType];let l=0;for(let c=s.storage.length-1;c>=0&&l<r;c--){const d=s.storage[c],u=A[d.resourceId];if(!u||a.storage.filter(g=>g.resourceId===d.resourceId).reduce((g,k)=>g+k.quantity,0)>u.stackSize*.5||d.quantity<=u.stackSize*.3)continue;const m=Math.min(Math.floor(d.quantity*.3),Math.floor((r-l)/u.weight));if(m<=0)continue;d.quantity-=m,d.quantity<=0&&s.storage.splice(c,1),ve(a,d.resourceId,m,d.quality),l+=m*u.weight;const p=Math.floor(m*(a.marketPrices[d.resourceId]??u.baseValue)*.3);for(const g of s.residentIds){const k=e.characters.get(g);if(k&&k.jobType==="merchant"){k.gold+=Math.floor(p/Math.max(1,s.residentIds.filter(y=>e.characters.get(y)?.jobType==="merchant").length));break}}}o.lastUsedTurn=t}return n}function Ot(e){for(const t of e.tradeRoutes.values()){let i=0;for(const n of t.path)for(const o of e.creatures.values())o.isHostile&&Math.abs(o.position.x-n.x)+Math.abs(o.position.y-n.y)<5&&(i+=.05);t.dangerLevel=Math.min(1,i)}}const Nt={hungerDrive:2,safetyDrive:1.5,socialDrive:.8,ambitionDrive:1,workDrive:1.5,wanderlust:.05,careerChangeChance:.005,adventurerChance:.001,marriageChance:.01};function Ft(e,t,i,n){if(!e.isAlive)return{type:"idle"};if(e.age<10)return{type:"idle"};if(e.currentAction?.type==="traveling"&&e.turnsUntilArrival>0)return e.currentAction;const o=[],s=e.homeLocationId?t.locations.get(e.homeLocationId):null;if(s&&e.jobType!=="unemployed"&&e.jobType!=="child"&&e.jobType!=="elder"){const l=i.workDrive*(1-e.personality.curiosity*.3);o.push({action:{type:"working",buildingType:jt(e.jobType)},weight:l*(e.needs.purpose<40?1.5:1),description:"go to work"})}if(e.needs.food<50){const l=i.hungerDrive*(1-e.needs.food/100);s&&o.push({action:{type:"trading",locationId:s.id},weight:l*2,description:"get food"})}if(e.needs.social<60&&e.relationships.length>0){const l=e.relationships.find(c=>c.type==="friend"||c.type==="spouse");l&&o.push({action:{type:"socializing",targetId:l.targetId},weight:i.socialDrive*(1-e.needs.social/100)*e.personality.kindness,description:"socialize"})}if(e.health<e.maxHealth*.7&&o.push({action:{type:"resting"},weight:i.safetyDrive*(1-e.health/e.maxHealth),description:"rest and recover"}),o.push({action:{type:"idle"},weight:.3,description:"do nothing"}),e.personality.curiosity>.7&&n.chance(i.wanderlust)&&Xt(e,t)&&o.push({action:{type:"exploring"},weight:i.ambitionDrive*e.personality.curiosity,description:"explore nearby areas"}),n.chance(i.careerChangeChance*e.personality.ambition)&&(e.needs.purpose<30||e.personality.ambition>.8)&&e.personality.courage>.7&&e.stats.strength>6&&o.push({action:{type:"idle"},weight:i.ambitionDrive*e.personality.ambition*.5,description:"change career"}),e.personality.curiosity>.8&&e.personality.courage>.8&&e.personality.ambition>.7&&e.age>=16&&e.age<=35&&n.chance(i.adventurerChance)&&o.push({action:{type:"exploring"},weight:i.ambitionDrive*2,description:"become an adventurer"}),!e.relationships.some(l=>l.type==="spouse")&&e.age>=16&&e.age<=50&&n.chance(i.marriageChance)&&o.push({action:{type:"socializing",targetId:""},weight:i.socialDrive*.5,description:"look for partner"}),o.length===0)return{type:"idle"};const a=o.reduce((l,c)=>l+Math.max(0,c.weight),0);if(a<=0)return{type:"idle"};let r=n.next()*a;for(const l of o)if(r-=Math.max(0,l.weight),r<=0)return l.action;return o[o.length-1].action}function Yt(e,t,i,n){const o=B(e.position,i),s=e.homePosition?B(e.position,e.homePosition):0;return e.type==="dragon"?Gt(e,t,i,o,n):e.type==="bandit"?Vt(e,t,i,o,n):e.isHostile&&o<4?{dx:Math.sign(i.x-e.position.x),dy:Math.sign(i.y-e.position.y),behavior:"aggressive"}:!e.isHostile&&o<3?{dx:-Math.sign(i.x-e.position.x),dy:-Math.sign(i.y-e.position.y),behavior:"fleeing"}:e.behavior==="territorial"&&s>e.wanderRadius?{dx:Math.sign((e.homePosition?.x??0)-e.position.x),dy:Math.sign((e.homePosition?.y??0)-e.position.y),behavior:"territorial"}:n.chance(.3)?{dx:n.nextInt(-1,1),dy:n.nextInt(-1,1),behavior:e.behavior}:{dx:0,dy:0,behavior:e.behavior}}function Gt(e,t,i,n,o){if(o.chance(.02))return{dx:o.nextInt(-2,2),dy:o.nextInt(-2,2),behavior:"migrating"};if(o.chance(.05)){let s=null,a=1/0;for(const r of t.locations.values()){if(r.isDestroyed)continue;const l=B(e.position,r.position);l<a&&l<15&&(a=l,s=r)}if(s)return{dx:Math.sign(s.position.x-e.position.x),dy:Math.sign(s.position.y-e.position.y),behavior:"aggressive"}}return n<6?{dx:Math.sign(i.x-e.position.x),dy:Math.sign(i.y-e.position.y),behavior:"hunting"}:{dx:0,dy:0,behavior:"territorial"}}function Vt(e,t,i,n,o){if(n<4)return{dx:Math.sign(i.x-e.position.x),dy:Math.sign(i.y-e.position.y),behavior:"raiding"};if(o.chance(.1))for(let a=-5;a<=5;a++)for(let r=-5;r<=5;r++){const l=e.position.x+r,c=e.position.y+a;if(l>=0&&l<t.width&&c>=0&&c<t.height&&t.tiles[c][l].roadLevel>0)return{dx:Math.sign(r),dy:Math.sign(a),behavior:"raiding"}}return o.chance(.3)?{dx:o.nextInt(-1,1),dy:o.nextInt(-1,1),behavior:e.behavior}:{dx:0,dy:0,behavior:e.behavior}}function Xt(e,t){for(let n=-5;n<=5;n++)for(let o=-5;o<=5;o++){const s=e.position.x+o,a=e.position.y+n;if(s>=0&&s<t.width&&a>=0&&a<t.height&&!t.tiles[a][s].explored)return{x:s,y:a}}return null}function jt(e){return{farmer:"farm_field",miner:"mine_shaft",lumberjack:"sawmill",fisher:"dock",blacksmith:"blacksmith",weaver:"weaver",baker:"bakery",brewer:"brewery",tanner:"tanner",hunter:"hunter_lodge",herbalist:"apothecary",soldier:"barracks",guard:"wall",priest:"church",merchant:"market"}[e]??"house"}function Ut(e,t,i,n){const o=[];for(const s of e.creatures.values()){if(s.type!=="dragon"||!n.chance(.03))continue;let a=null,r=1/0;for(const l of e.locations.values()){if(l.isDestroyed)continue;const c=B(s.position,l.position);c<r&&c<10&&(r=c,a=l)}if(a){o.push(D("dragon_attack",t,`${s.name??"A dragon"} attacks ${a.name}!`,`The fearsome ${s.name??"dragon"} descends upon ${a.name}, breathing fire and destruction.`,a.id,[],"major")),a.defenseLevel=Math.max(0,a.defenseLevel-2),a.safety=Math.max(0,a.safety-30),a.happiness=Math.max(0,a.happiness-20),a.prosperity=Math.max(0,a.prosperity-15);for(const l of a.buildings)n.chance(.3)&&(l.condition=Math.max(0,l.condition-n.nextInt(20,50)),l.condition<=0&&(l.isOperational=!1))}}for(const s of e.creatures.values())if(s.type==="bandit"&&n.chance(.05))for(const a of e.locations.values()){if(a.isDestroyed)continue;if(B(s.position,a.position)<5&&a.defenseLevel<3&&a.garrisonIds.length<3){o.push(D("bandit_attack",t,`Bandits raid ${a.name}!`,`A group of bandits attacks the poorly defended ${a.name}, stealing goods and terrorizing residents.`,a.id,[],"moderate"));const l=Math.min(a.storage.length,n.nextInt(1,3));for(let c=0;c<l&&a.storage.length>0;c++){const d=n.nextInt(0,a.storage.length-1);a.storage.splice(d,1)}a.safety=Math.max(0,a.safety-15);break}}if(n.chance(.005)){Array.from(e.countries.values());for(const s of e.diplomacy)if(s.type==="rivalry"&&s.strength<-40&&n.chance(.1)){const a=e.countries.get(s.countryAId),r=e.countries.get(s.countryBId);a&&r&&(s.type="war",a.enemies.push(r.id),r.enemies.push(a.id),o.push(D("war_declared",t,`${a.name} declares war on ${r.name}!`,`Tensions between ${a.name} and ${r.name} have erupted into open war. Border settlements prepare for conflict.`,null,[a.leaderId,r.leaderId],"catastrophic")))}}for(const s of e.diplomacy)if(s.type==="war"&&t-s.startedTurn>50&&n.chance(.02)){s.type="truce",s.strength=0;const a=e.countries.get(s.countryAId),r=e.countries.get(s.countryBId);a&&r&&(a.enemies=a.enemies.filter(l=>l!==r.id),r.enemies=r.enemies.filter(l=>l!==a.id),o.push(D("peace_treaty",t,`${a.name} and ${r.name} sign a peace treaty`,`After long conflict, ${a.name} and ${r.name} agree to a truce.`,null,[a.leaderId,r.leaderId],"major")))}if(i==="autumn"&&n.chance(.02)){const s=Array.from(e.locations.values()).filter(a=>!a.isDestroyed&&(a.type==="farm"||a.type==="village"||a.type==="hamlet"));if(s.length>0){const a=n.pick(s);o.push(D("bountiful_harvest",t,`Bountiful harvest in ${a.name}!`,`The farmers of ${a.name} celebrate an exceptional harvest this season.`,a.id,[],"minor")),a.prosperity=Math.min(100,a.prosperity+10),a.happiness=Math.min(100,a.happiness+10)}}if(i==="winter"&&n.chance(.01)){const s=Array.from(e.locations.values()).filter(a=>!a.isDestroyed&&a.residentIds.length>5&&a.storage.filter(r=>["wheat","bread","meat","fish"].includes(r.resourceId)).reduce((r,l)=>r+l.quantity,0)<a.residentIds.length);if(s.length>0){const a=n.pick(s);o.push(D("famine",t,`Famine strikes ${a.name}!`,`Food stores run dangerously low in ${a.name}. The people cry out for relief.`,a.id,[],"major")),a.happiness=Math.max(0,a.happiness-20),a.prosperity=Math.max(0,a.prosperity-10)}}if(n.chance(.002)){const s=Array.from(e.locations.values()).filter(a=>!a.isDestroyed&&a.residentIds.length>15);if(s.length>0){const a=n.pick(s);o.push(D("plague",t,`Plague breaks out in ${a.name}!`,`A terrible sickness spreads through ${a.name}. Many fall ill.`,a.id,[],"catastrophic"));const r=Math.floor(a.residentIds.length*n.nextFloat(.1,.3));for(let l=0;l<r&&a.residentIds.length>2;l++){const c=a.residentIds.pop(),d=e.characters.get(c);d&&(d.isAlive=!1)}a.happiness=Math.max(0,a.happiness-30)}}for(const s of e.locations.values())if(!s.isDestroyed&&!(s.residentIds.length>=s.populationCapacity))for(const a of s.residentIds){const r=e.characters.get(a);if(!r||!r.isAlive||r.age<18||r.age>45)continue;const l=r.relationships.find(d=>d.type==="spouse");if(!l)continue;const c=e.characters.get(l.targetId);if(!(!c||!c.isAlive)&&n.chance(.003)){o.push(D("birth",t,`A child is born in ${s.name}`,`${r.name} and ${c.name} welcome a new child.`,s.id,[r.id,c.id],"minor"));break}}return(i==="autumn"||i==="spring")&&n.chance(.01)&&o.push(D("monster_migration",t,"Creatures are migrating!","Packs of wild beasts are on the move as the seasons change. Travelers beware!",null,[],"moderate")),o}function D(e,t,i,n,o,s,a){return{id:_("evt"),type:e,turn:t,title:i,description:n,locationId:o,characterIds:s,isResolved:!1,effects:[],severity:a}}const h={deepWater:"#0f3460",water:"#1a5276",waterHighlight:"#5dade2",sand:"#e8d4a2",sandDark:"#d4b87a",desert:"#d4a843",desertDark:"#b8922c",grassDark:"#2d6b1e",grass:"#4a8c3a",grassLight:"#6aac5a",dryGrass:"#9ca44c",treeDark:"#1a4c0c",tree:"#2d6b1e",treeLight:"#4a8c3a",jungleTree:"#1a6b1a",jungleTreeDark:"#0d4d0d",hillGrass:"#8c9c5c",rock:"#7c7c7c",rockDark:"#5c5c5c",snow:"#e8e8f0",snowShadow:"#c8c8d8",tundra:"#a8b8a0",tundraDark:"#8ca080",swampWater:"#3c5c3c",swamp:"#4c6c3c",savanna:"#b8a848",savannaDark:"#a09030",woodWall:"#8c6c3c",woodWallDark:"#6c5028",stoneWall:"#a0a0a0",stoneWallDark:"#707070",stoneWallLight:"#c0c0c0",roofRed:"#a04040",roofRedDark:"#803030",roofBlue:"#4040a0",roofBrown:"#705030",skinLight:"#e8c8a0",skinMedium:"#d4b088",hairBrown:"#5a3a1a",clothRed:"#c44444",clothBlue:"#4444c4",clothBrown:"#8c6c3c",clothGold:"#c8a848",uiBorder:"#3a3a5e",uiText:"#e0d8c8",uiHighlight:"#c8a84e",uiDanger:"#c44444",uiSafe:"#44a044",roadDirt:"#a09070",roadStone:"#b0a898",roadHighway:"#c0b8a8",fireOrange:"#e87020",fireYellow:"#f0c040"};function fe(e,t){const i=Math.max(0,parseInt(e.slice(1,3),16)-t),n=Math.max(0,parseInt(e.slice(3,5),16)-t),o=Math.max(0,parseInt(e.slice(5,7),16)-t);return`#${i.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`}function me(e,t){const i=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16);return`rgba(${i},${n},${o},${t})`}const w=64,b=32,C=12;class Qt{x;y;zoom;targetX;targetY;targetZoom;screenWidth;screenHeight;minZoom=.25;maxZoom=3;smoothing=.15;constructor(t,i){this.x=0,this.y=0,this.zoom=1,this.targetX=0,this.targetY=0,this.targetZoom=1,this.screenWidth=t,this.screenHeight=i}update(){this.x+=(this.targetX-this.x)*this.smoothing,this.y+=(this.targetY-this.y)*this.smoothing,this.zoom+=(this.targetZoom-this.zoom)*this.smoothing}pan(t,i){this.targetX-=t/this.zoom,this.targetY-=i/this.zoom}zoomAt(t,i,n){const o=S(this.targetZoom*t,this.minZoom,this.maxZoom),s=o/this.targetZoom,a=(i-this.screenWidth/2)/this.targetZoom+this.targetX,r=(n-this.screenHeight/2)/this.targetZoom+this.targetY;this.targetX=a-(a-this.targetX)/s,this.targetY=r-(r-this.targetY)/s,this.targetZoom=o}centerOnTile(t,i){const n=(t-i)*(w/2),o=(t+i)*(b/2);this.targetX=n,this.targetY=o}screenToWorld(t,i){return{wx:(t-this.screenWidth/2)/this.zoom+this.x,wy:(i-this.screenHeight/2)/this.zoom+this.y}}worldToScreen(t,i){return{sx:(t-this.x)*this.zoom+this.screenWidth/2,sy:(i-this.y)*this.zoom+this.screenHeight/2}}screenToTile(t,i){const{wx:n,wy:o}=this.screenToWorld(t,i),s=(n/(w/2)+o/(b/2))/2,a=(o/(b/2)-n/(w/2))/2;return{tx:Math.floor(s),ty:Math.floor(a)}}getVisibleRange(t,i){const o=this.screenToTile(0,0),s=this.screenToTile(this.screenWidth,0),a=this.screenToTile(0,this.screenHeight),r=this.screenToTile(this.screenWidth,this.screenHeight);return{minX:S(Math.min(o.tx,a.tx)-4,0,t-1),maxX:S(Math.max(s.tx,r.tx)+4,0,t-1),minY:S(Math.min(o.ty,s.ty)-4,0,i-1),maxY:S(Math.max(a.ty,r.ty)+4,0,i-1)}}resize(t,i){this.screenWidth=t,this.screenHeight=i}}const ae=new Map;function Kt(e,t,i,n,o){const s=Math.round(t*5),a=Math.round(o*3),r=`${e}_${s}_${i}_${n}_${a}`,l=ae.get(r);if(l)return l;const c=Zt(e,t,i,n,o);return ae.set(r,c),c}function Zt(e,t,i,n,o){const s=Math.floor(t*5)*C,a=b+s+40,r=new OffscreenCanvas(w+2,a),l=r.getContext("2d"),c=Jt(e,n),d=a-b-s;return s>0&&ti(l,d+b/2,s,c.sideDark,c.sideLight),ei(l,w/2+1,d+b/2,w,b,c.top),ii(l,w/2+1,d+b/2,e,i,c),o>.1&&e!=="ocean"&&e!=="beach"&&e!=="desert"&&ni(l,w/2+1,d,e,o,n,i),e==="ocean"&&ri(l,w/2+1,d+b/2,i),r}function Jt(e,t){let i,n;switch(e){case"ocean":i=t==="winter"?h.deepWater:h.water,n=h.waterHighlight;break;case"beach":i=h.sand,n=h.sandDark;break;case"desert":i=h.desert,n=h.desertDark;break;case"grassland":i=t==="winter"?h.dryGrass:t==="autumn"?"#8ca04c":h.grass,n=h.grassLight;break;case"forest":case"dense_forest":i=t==="winter"?"#5c7c4c":t==="autumn"?"#a07030":h.grassDark,n=h.treeLight;break;case"jungle":i=h.jungleTree,n=h.jungleTreeDark;break;case"hills":i=t==="winter"?h.snowShadow:h.hillGrass,n=h.rock;break;case"mountain":i=h.rock,n=h.rockDark;break;case"snow_mountain":i=h.snow,n=h.snowShadow;break;case"tundra":i=t==="winter"?h.snow:h.tundra,n=h.tundraDark;break;case"swamp":i=h.swamp,n=h.swampWater;break;case"savanna":i=t==="winter"?h.dryGrass:h.savanna,n=h.savannaDark;break;default:i=h.grass,n=h.grassDark}return{top:i,sideDark:fe(i,40),sideLight:fe(i,20),accent:n}}function ei(e,t,i,n,o,s){e.fillStyle=s,e.beginPath(),e.moveTo(t,i-o/2),e.lineTo(t+n/2,i),e.lineTo(t,i+o/2),e.lineTo(t-n/2,i),e.closePath(),e.fill()}function ti(e,t,i,n,o){const s=w/2+1;e.fillStyle=n,e.beginPath(),e.moveTo(s-w/2,t),e.lineTo(s,t+b/2),e.lineTo(s,t+b/2+i),e.lineTo(s-w/2,t+i),e.closePath(),e.fill(),e.fillStyle=o,e.beginPath(),e.moveTo(s+w/2,t),e.lineTo(s,t+b/2),e.lineTo(s,t+b/2+i),e.lineTo(s+w/2,t+i),e.closePath(),e.fill()}function ii(e,t,i,n,o,s){const a=le(o);if(e.fillStyle=s.accent,n==="grassland"||n==="savanna")for(let r=0;r<6;r++){const l=a*(r+1)*7%40-20,c=a*(r+1)*11%20-10;z(l,c,w-8,b-4)&&e.fillRect(t+l,i+c,2,1)}else if(n==="desert")for(let r=0;r<4;r++){const l=a*(r+1)*13%30-15,c=a*(r+1)*17%14-7;z(l,c,w-12,b-6)&&e.fillRect(t+l,i+c,4,1)}else if(n==="mountain"||n==="snow_mountain")for(let r=0;r<5;r++){const l=a*(r+1)*9%36-18,c=a*(r+1)*13%16-8;z(l,c,w-10,b-5)&&e.fillRect(t+l,i+c,3,2)}else if(n==="swamp"){e.fillStyle=h.swampWater;for(let r=0;r<3;r++){const l=a*(r+1)*11%30-15,c=a*(r+1)*7%12-6;z(l,c,w-16,b-8)&&e.fillRect(t+l,i+c,5,2)}}}function ni(e,t,i,n,o,s,a){const r=Math.floor(o*4),l=le(a+1e3);for(let c=0;c<r;c++){const d=l*(c+1)*7%30-15,u=l*(c+1)*11%14-7;if(!z(d,u,w-20,b-10))continue;const f=t+d,m=i+u+b/2;n==="jungle"||n==="dense_forest"?si(e,f,m,s,n==="jungle"):n==="forest"?oi(e,f,m,s):ai(e,f,m,s)}}function oi(e,t,i,n){e.fillStyle="#5a3a1a",e.fillRect(t,i-4,2,5);let o;n==="autumn"?o="#c07030":n==="winter"?o="#6c8c5c":o=h.tree,e.fillStyle=o,e.fillRect(t-2,i-8,6,3),e.fillRect(t-1,i-10,4,2),e.fillRect(t,i-11,2,1)}function si(e,t,i,n,o){e.fillStyle=o?"#3a2a0a":"#5a3a1a",e.fillRect(t,i-6,3,7);let s=o?h.jungleTree:h.treeDark;n==="autumn"&&!o&&(s="#a06020"),e.fillStyle=s,e.fillRect(t-3,i-10,9,4),e.fillRect(t-2,i-13,7,3),e.fillRect(t-1,i-15,5,2),e.fillRect(t,i-16,3,1)}function ai(e,t,i,n){const o=n==="winter"?h.dryGrass:h.grassLight;e.fillStyle=o,e.fillRect(t-1,i-3,4,2),e.fillRect(t,i-4,2,1)}function ri(e,t,i,n){e.fillStyle=h.waterHighlight;const o=le(n+5e3);for(let s=0;s<3;s++){const a=o*(s+1)*7%24-12,r=o*(s+1)*11%10-5;z(a,r,w-16,b-8)&&e.fillRect(t+a,i+r,3,1)}}function z(e,t,i,n){return Math.abs(e)/(i/2)+Math.abs(t)/(n/2)<=1}function le(e){return e=(e>>16^e)*73244475,e=(e>>16^e)*73244475,e=e>>16^e,Math.abs(e)}function li(){ae.clear()}const G=6;function ci(e){const t=new H(e.world.seed+e.turn*31337);e.turn++;const i=It(e.turn);i!==e.season&&(e.season=i,li(),V(e,`Season changes to ${i}.`,"system")),e.weather=mi(e.season,t);const n=Dt(e.world,e.season,t.fork());for(const s of n.slice(0,3))V(e,s,"trade");if(e.turn%5===0){const s=Pt(e.world,e.turn,t.fork());for(const a of s)V(e,a,"trade")}if(e.turn%20===0){const s=Ht(e.world,t.fork());for(const a of s)V(e,a,"trade");Ot(e.world)}di(e,t.fork()),hi(e,t.fork());const o=Ut(e.world,e.turn,e.season,t.fork());for(const s of o)e.activeEvents.push(s),V(e,s.title,gi(s.severity));fi(e),e.turn%360===0&&pi(e.world),e.party.maxMovementPoints=5,e.party.movementPoints=e.party.maxMovementPoints,e.activeEvents=e.activeEvents.filter(s=>!s.isResolved&&e.turn-s.turn<50)}function di(e,t){const i=e.world;for(const n of i.characters.values()){if(!n.isAlive||e.party.members.some(s=>s.id===n.id))continue;const o=Ft(n,i,Nt,t);n.currentAction=o,ui(n,o),n.needs.food=Math.max(0,n.needs.food-.5),n.needs.social=Math.max(0,n.needs.social-.3),n.needs.purpose=Math.max(0,n.needs.purpose-.2),o.type==="working"&&(n.needs.purpose=Math.min(100,n.needs.purpose+3)),o.type==="socializing"&&(n.needs.social=Math.min(100,n.needs.social+5)),o.type==="resting"&&(n.health=Math.min(n.maxHealth,n.health+5))}}function ui(e,t,i,n){if(t)switch(t.type){case"traveling":e.turnsUntilArrival>0&&(e.turnsUntilArrival--,e.turnsUntilArrival<=0&&e.destination&&(e.position={...e.destination},e.destination=null));break;case"working":break;case"idle":e.health=Math.min(e.maxHealth,e.health+1);break}}function hi(e,t){const i=e.world;for(const n of i.creatures.values()){if(n.health<=0)continue;const{dx:o,dy:s,behavior:a}=Yt(n,i,e.party.position,t);n.behavior=a;const r=n.position.x+o,l=n.position.y+s;if(oe({x:r,y:l},i.width,i.height)){const c=i.tiles[l][r];L(c.terrainType)||(n.position.x=r,n.position.y=l)}n.lastActionTurn=e.turn,n.age++}for(const[n,o]of i.creatures)o.health<=0&&i.creatures.delete(n)}function fi(e){const{world:t,party:i}=e,{x:n,y:o}=i.position;for(let s=0;s<t.height;s++)for(let a=0;a<t.width;a++)t.tiles[s][a].visible=!1;for(let s=-G;s<=G;s++)for(let a=-G;a<=G;a++){if(Math.sqrt(a*a+s*s)>G)continue;const l=n+a,c=o+s;l>=0&&l<t.width&&c>=0&&c<t.height&&(t.tiles[c][l].visible=!0,t.tiles[c][l].explored=!0)}}function mi(e,t){const i=St[e],n=Object.entries(i);return t.weightedPick(n)}function pi(e){for(const t of e.characters.values())t.isAlive&&(t.age++,t.age>65&&Math.random()<(t.age-65)*.05&&(t.isAlive=!1),t.age>=15&&t.jobType==="child"&&(t.jobType="unemployed"))}function V(e,t,i){e.eventLog.push({turn:e.turn,message:t,type:i}),e.eventLog.length>200&&(e.eventLog=e.eventLog.slice(-150))}function gi(e){switch(e){case"catastrophic":return"danger";case"major":return"danger";case"moderate":return"info";default:return"info"}}class yi{state;rng;constructor(){this.state=null,this.rng=new H(0)}newGame(t,i){const n={...we,...t};this.rng=new H(n.seed),i?.("Generating world...",0);const o=vt(n,i),s=this.findStartPosition(o),a=K(this.rng,s,null,"adventurer");a.name="The Adventurer",a.stats.strength=8,a.stats.dexterity=7,a.stats.intelligence=6,a.stats.charisma=6,a.stats.endurance=8,a.health=100,a.maxHealth=100,a.gold=50,a.skills.combat=25,a.skills.survival=20,a.skills.trading=10;const r={definitionId:"iron_sword",instanceId:_("item"),name:"Worn Iron Sword",ownerId:a.id,condition:"worn",rarity:"common",enchantments:[],attuned:!1,attunedToId:null,createdBy:null,history:["Found in an old chest."],currentDurability:60,maxDurability:100,type:"weapon",attack:7,defense:0,speed:5,weight:3,value:18};a.equippedWeapon=r,a.inventory.push(r);const l={definitionId:"leather_armor",instanceId:_("item"),name:"Leather Vest",ownerId:a.id,condition:"good",rarity:"common",enchantments:[],attuned:!1,attunedToId:null,createdBy:null,history:[],currentDurability:65,maxDurability:80,type:"armor",attack:0,defense:3,speed:-1,weight:5,value:15};a.equippedArmor=l,a.inventory.push(l);const c={members:[a],position:{...s},inventory:[],gold:50,reputation:{},movementPoints:5,maxMovementPoints:5};this.state={world:o,turn:0,season:"spring",weather:"clear",party:c,activeEvents:[],eventLog:[{turn:0,message:"Your adventure begins in the world of legends. Explore, trade, and survive!",type:"system"}],gameOver:!1,isPaused:!1,selectedTile:null,viewMode:"world"},this.updateVisibility(),this.addLog("You stand at the edge of civilization. The world awaits.","system"),this.describeCurrentLocation()}findStartPosition(t){const i=Array.from(t.locations.values()).filter(s=>s.type==="town"||s.type==="village").sort((s,a)=>a.residentIds.length-s.residentIds.length);if(i.length>0){const s=i[0];for(let a=-2;a<=2;a++)for(let r=-2;r<=2;r++){const l=s.position.x+r,c=s.position.y+a;if(l>=0&&l<t.width&&c>=0&&c<t.height){const d=t.tiles[c][l];if(!L(d.terrainType)&&!d.locationId)return{x:l,y:c}}}return s.position}const n=Math.floor(t.width/2),o=Math.floor(t.height/2);for(let s=0;s<20;s++)for(let a=-s;a<=s;a++)for(let r=-s;r<=s;r++){const l=n+r,c=o+a;if(l>=0&&l<t.width&&c>=0&&c<t.height&&!L(t.tiles[c][l].terrainType))return{x:l,y:c}}return{x:n,y:o}}moveParty(t,i){const{party:n,world:o}=this.state,s=n.position.x+t,a=n.position.y+i;if(!oe({x:s,y:a},o.width,o.height))return!1;const r=o.tiles[a][s];if(L(r.terrainType))return this.addLog("The way is blocked by water.","system"),!1;const l=q[r.biome],c=l?Math.ceil(l.movementCost):1;if(n.movementPoints<c)return this.addLog("Not enough movement points. End your turn to rest.","system"),!1;n.movementPoints-=c,n.position.x=s,n.position.y=a;for(const d of n.members)d.position={...n.position};return this.updateVisibility(),this.describeCurrentLocation(),this.checkEncounters(),!0}endTurn(){ci(this.state)}rest(){const{party:t,world:i}=this.state,n=i.tiles[t.position.y]?.[t.position.x];if(!n?.locationId){for(const a of t.members)a.health=Math.min(a.maxHealth,a.health+5);return this.addLog("You camp in the wilderness. Some health restored.","info"),this.endTurn(),!0}const o=i.locations.get(n.locationId);if(!o||o.isDestroyed)return this.addLog("These ruins offer little shelter.","info"),this.endTurn(),!0;for(const a of t.members)a.health=Math.min(a.maxHealth,a.health+20),a.needs.food=Math.min(100,a.needs.food+30),a.needs.shelter=Math.min(100,a.needs.shelter+40);return o.buildings.some(a=>a.type==="tavern")?(this.addLog(`You rest at the tavern in ${o.name}. Health and spirits restored!`,"social"),t.gold>=2&&(t.gold-=2)):this.addLog(`You rest in ${o.name}. Health restored.`,"info"),this.endTurn(),!0}buyFood(){const{party:t,world:i}=this.state,n=i.tiles[t.position.y]?.[t.position.x];if(!n?.locationId)return this.addLog("There is no market here.","system"),!1;const o=i.locations.get(n.locationId);if(!o||o.isDestroyed)return!1;const s=["bread","meat","fish","berries"];for(const a of s){const r=o.storage.findIndex(l=>l.resourceId===a&&l.quantity>0);if(r>=0){const l=o.marketPrices[a]??3;if(t.gold>=l){t.gold-=l,o.storage[r].quantity--,o.storage[r].quantity<=0&&o.storage.splice(r,1);for(const c of t.members)c.needs.food=Math.min(100,c.needs.food+25);return this.addLog(`Bought ${a} for ${l} gold in ${o.name}.`,"trade"),!0}else return this.addLog(`Not enough gold to buy ${a} (${l}g).`,"system"),!1}}return this.addLog("No food available here.","system"),!1}getCurrentLocation(){const{party:t,world:i}=this.state,n=i.tiles[t.position.y]?.[t.position.x];return n?.locationId?i.locations.get(n.locationId)??null:null}checkEncounters(){const{party:t,world:i}=this.state,n=t.position;for(const o of i.creatures.values())o.position.x===n.x&&o.position.y===n.y&&(o.isHostile?(this.addLog(`You encounter hostile ${o.name??o.type}!`,"combat"),this.initiateCombat(o)):this.addLog(`You spot a group of ${o.type} nearby.`,"info"))}initiateCombat(t){const n=this.state.party.members[0];if(!n)return;let o=n.health,s=t.health;const a=(n.stats.strength+(n.equippedWeapon?.attack??0))*2,r=n.stats.endurance+(n.equippedArmor?.defense??0),l=t.attack,c=t.defense;let d=0;for(;o>0&&s>0&&d<20;){d++;const u=Math.max(1,a-c+Math.floor(Math.random()*4)-2);if(s-=u,s>0){const f=Math.max(1,l-r+Math.floor(Math.random()*4)-2);o-=f}}if(s<=0){this.addLog(`You defeated the ${t.name??t.type}!`,"combat"),t.health=0;for(const u of t.loot)this.addLog(`Obtained ${u.quantity} ${u.resourceId}.`,"info");n.skills.combat=Math.min(100,(n.skills.combat??0)+2)}else this.addLog(`The ${t.name??t.type} drove you back! You took heavy damage.`,"danger");n.health=Math.max(1,o)}describeCurrentLocation(){const{party:t,world:i}=this.state,n=i.tiles[t.position.y][t.position.x];if(q[n.biome],n.locationId){const o=i.locations.get(n.locationId);if(o&&(this.addLog(`You arrive at ${o.name} (${o.type}).`,"discovery"),o.countryId)){const s=i.countries.get(o.countryId);s&&this.addLog(`This land belongs to the ${s.name}.`,"info")}}n.resourceDeposit&&this.addLog(`You notice deposits of ${n.resourceDeposit.resourceId} here.`,"discovery")}updateVisibility(){const{world:t,party:i}=this.state,n=6;for(let o=0;o<t.height;o++)for(let s=0;s<t.width;s++)t.tiles[o][s].visible=!1;for(let o=-n;o<=n;o++)for(let s=-n;s<=n;s++){if(s*s+o*o>n*n)continue;const a=i.position.x+s,r=i.position.y+o;a>=0&&a<t.width&&r>=0&&r<t.height&&(t.tiles[r][a].visible=!0,t.tiles[r][a].explored=!0)}}getTileInfo(t,i){const{world:n}=this.state;if(!oe({x:t,y:i},n.width,n.height))return[];const o=n.tiles[i][t],s=[],a=q[o.biome];if(s.push(`${a?.name??o.biome} (${t}, ${i})`),s.push(`Elevation: ${Math.round(o.elevation*100)}%`),o.resourceDeposit&&s.push(`Resource: ${o.resourceDeposit.resourceId} (${o.resourceDeposit.amount})`),o.locationId){const r=n.locations.get(o.locationId);if(r&&(s.push(`${r.name} — ${r.type}`),s.push(`Population: ${r.residentIds.length}`),s.push(`Prosperity: ${Math.round(r.prosperity)}`),s.push(`Safety: ${Math.round(r.safety)}`),r.countryId)){const l=n.countries.get(r.countryId);l&&s.push(`Country: ${l.name}`)}}if(o.roadLevel>0){const r=["","Path","Road","Highway"];s.push(`Road: ${r[o.roadLevel]}`)}return s}getDateString(){const t=Rt(this.state.turn),i=this.state.season;return`Year ${t}, ${i.charAt(0).toUpperCase()+i.slice(1)} — Day ${this.state.turn%90+1}`}addLog(t,i){this.state.eventLog.push({turn:this.state.turn,message:t,type:i}),this.state.eventLog.length>200&&(this.state.eventLog=this.state.eventLog.slice(-150))}}const pe=new Map;function bi(e,t,i){const n=`${e}_${t}_${i??"none"}`,o=pe.get(n);if(o)return o;const s=wi(e,t,i);return pe.set(n,s),s}function wi(e,t,i){const n=new OffscreenCanvas(48,48),o=n.getContext("2d");switch(e){case"homestead":R(o,24,36);break;case"hamlet":R(o,18,36),R(o,30,36);break;case"village":W(o,16,36),W(o,30,36),R(o,24,30);break;case"town":ke(o);break;case"city":vi(o);break;case"castle":ki(o);break;case"mine":Ii(o);break;case"farm":Ri(o);break;case"lumber_camp":Si(o);break;case"fishing_village":Mi(o);break;case"port":Ti(o);break;case"dungeon":Di(o);break;case"ruins":Li(o);break;case"dragon_lair":_i(o);break;case"bandit_camp":qi(o);break;case"monastery":Ai(o);break;default:R(o,24,36)}return i&&["town","city","castle","port"].includes(e)&&Ci(o,10,8,i),n}function R(e,t,i){e.fillStyle=h.woodWall,e.fillRect(t-4,i-6,8,6),e.fillStyle=h.woodWallDark,e.fillRect(t-4,i-6,2,6),e.fillStyle=h.roofBrown,e.fillRect(t-5,i-9,10,3),e.fillRect(t-4,i-10,8,1),e.fillStyle="#f0e0a0",e.fillRect(t,i-5,2,2)}function W(e,t,i){e.fillStyle=h.woodWall,e.fillRect(t-5,i-8,10,8),e.fillStyle=h.woodWallDark,e.fillRect(t-5,i-8,2,8),e.fillStyle=h.roofRed,e.fillRect(t-6,i-11,12,3),e.fillRect(t-5,i-12,10,1),e.fillStyle="#f0e0a0",e.fillRect(t-2,i-6,2,2),e.fillRect(t+1,i-6,2,2),e.fillStyle=h.woodWallDark,e.fillRect(t-1,i-3,3,3)}function ke(e,t){W(e,12,40),W(e,28,40),W(e,36,40),e.fillStyle=h.stoneWall,e.fillRect(18,18,12,16),e.fillStyle=h.stoneWallDark,e.fillRect(18,18,3,16),e.fillStyle=h.roofRedDark,e.fillRect(17,14,14,4),e.fillRect(18,12,12,2),e.fillStyle=h.stoneWall,e.fillRect(22,6,5,8),e.fillStyle=h.roofRed,e.fillRect(21,4,7,3),e.fillRect(22,3,5,1)}function vi(e,t){ke(e),R(e,6,40),R(e,42,40),e.fillStyle=h.stoneWallDark,e.fillRect(2,34,2,8),e.fillRect(44,34,2,8),e.fillRect(2,42,44,2)}function ki(e,t){e.fillStyle=h.stoneWall,e.fillRect(8,20,32,20),e.fillStyle=h.stoneWallDark,e.fillRect(8,20,4,20),e.fillStyle=h.stoneWall,e.fillRect(6,10,8,14),e.fillStyle=h.stoneWallDark,e.fillRect(6,10,2,14),e.fillRect(6,8,2,3),e.fillRect(10,8,2,3),e.fillStyle=h.stoneWall,e.fillRect(34,10,8,14),e.fillStyle=h.stoneWallDark,e.fillRect(34,10,2,14),e.fillRect(34,8,2,3),e.fillRect(38,8,2,3),e.fillStyle=h.stoneWallLight,e.fillRect(18,8,12,18),e.fillStyle=h.stoneWallDark,e.fillRect(18,8,3,18),e.fillStyle=h.roofRed,e.fillRect(17,4,14,4),e.fillRect(19,2,10,2),e.fillStyle="#2a2a2a",e.fillRect(21,32,6,8),e.fillStyle="#3a3a3a",e.fillRect(22,32,4,7)}function Ii(e){e.fillStyle="#3a3a3a",e.fillRect(16,28,16,12),e.fillStyle=h.woodWall,e.fillRect(15,26,18,3),e.fillRect(15,26,3,14),e.fillRect(30,26,3,14),e.fillStyle=h.woodWallDark,e.fillRect(20,38,8,2),R(e,36,36)}function Ri(e){R(e,12,30),e.fillStyle="#a08840",e.fillRect(22,28,20,12),e.fillStyle="#60a030";for(let t=0;t<4;t++)e.fillRect(24,29+t*3,16,1)}function Si(e){R(e,24,36),e.fillStyle=h.woodWallDark,e.fillRect(8,34,10,3),e.fillRect(9,32,8,2),e.fillStyle="#6c5028",e.fillRect(36,36,4,3)}function Mi(e){R(e,16,32),R(e,30,32),e.fillStyle=h.woodWall,e.fillRect(20,36,12,2),e.fillRect(24,38,4,6)}function Ti(e,t){W(e,16,34),W(e,32,34),e.fillStyle=h.woodWall,e.fillRect(10,38,28,3),e.fillRect(18,41,4,5),e.fillRect(30,41,4,5),e.fillStyle=h.stoneWall,e.fillRect(22,24,10,8),e.fillStyle=h.roofBrown,e.fillRect(21,22,12,3)}function Di(e){e.fillStyle="#2a2a3a",e.fillRect(18,30,12,10),e.fillStyle="#4a4a5a",e.fillRect(17,28,14,3),e.fillStyle="#e0d0b0",e.fillRect(22,34,4,3),e.fillRect(23,33,2,1)}function Li(e){e.fillStyle=h.stoneWallDark,e.fillRect(12,30,4,8),e.fillRect(20,28,3,10),e.fillRect(30,32,5,6),e.fillRect(14,36,20,2),e.fillStyle="#8a8a7a",e.fillRect(16,34,3,2),e.fillRect(26,35,4,2)}function _i(e){e.fillStyle="#2a2a2a",e.fillRect(14,24,20,16),e.fillStyle=h.rockDark,e.fillRect(12,22,24,4),e.fillRect(14,20,20,3),e.fillStyle=h.clothGold,e.fillRect(20,36,2,2),e.fillRect(26,35,3,2),e.fillStyle=h.fireOrange,e.fillRect(22,30,4,2),e.fillStyle=h.fireYellow,e.fillRect(23,29,2,1)}function qi(e){e.fillStyle="#7c6c4c",e.fillRect(12,28,10,8),e.fillRect(11,26,12,3),e.fillRect(28,30,8,6),e.fillRect(27,28,10,3),e.fillStyle=h.fireOrange,e.fillRect(22,34,3,2),e.fillStyle=h.fireYellow,e.fillRect(23,33,1,1)}function Ai(e){e.fillStyle=h.stoneWallLight,e.fillRect(14,18,20,20),e.fillStyle=h.stoneWallDark,e.fillRect(14,18,4,20),e.fillStyle=h.roofBlue,e.fillRect(13,14,22,4),e.fillRect(15,12,18,2),e.fillStyle=h.stoneWallLight,e.fillRect(21,4,6,10),e.fillStyle=h.roofBlue,e.fillRect(20,2,8,3),e.fillStyle=h.clothGold,e.fillRect(23,0,2,3),e.fillRect(22,1,4,1)}function Ci(e,t,i,n){e.fillStyle=h.woodWallDark,e.fillRect(t,i,1,10),e.fillStyle=n,e.fillRect(t+1,i,6,4),e.fillRect(t+1,i+4,5,1)}const ee=new Map;function Ei(){const e="party",t=ee.get(e);if(t)return t;const i=new OffscreenCanvas(16,24),n=i.getContext("2d");return Bi(n,8,20),ee.set(e,i),i}function Wi(e){const t=`creature_${e}`,i=ee.get(t);if(i)return i;const n=new OffscreenCanvas(16,20),o=n.getContext("2d");switch(e){case"wolf":xi(o,8,16);break;case"bear":zi(o,8,16);break;case"deer":Hi(o,8,16);break;case"sheep":$i(o,8,16);break;case"boar":Pi(o,8,16);break;case"dragon":Oi(o,8,12);break;case"bandit":Ni(o,8,16);break}return ee.set(t,n),n}function Bi(e,t,i){e.fillStyle=h.clothBrown,e.fillRect(t-2,i-4,2,4),e.fillRect(t+1,i-4,2,4),e.fillStyle=h.clothBlue,e.fillRect(t-3,i-9,7,5),e.fillRect(t-4,i-8,1,4),e.fillRect(t+4,i-8,1,4),e.fillStyle=h.skinLight,e.fillRect(t-2,i-13,5,4),e.fillStyle=h.hairBrown,e.fillRect(t-2,i-14,5,2),e.fillStyle="#2a2a2a",e.fillRect(t-1,i-12,1,1),e.fillRect(t+1,i-12,1,1),e.fillStyle="#a0a0a0",e.fillRect(t+4,i-14,1,8),e.fillStyle=h.clothGold,e.fillRect(t+3,i-7,3,1),e.fillStyle=h.clothRed,e.fillRect(t-3,i-9,2,6)}function xi(e,t,i){e.fillStyle="#6a6a6a",e.fillRect(t-4,i-4,8,3),e.fillRect(t+3,i-6,4,3),e.fillRect(t+4,i-7,1,1),e.fillRect(t+6,i-7,1,1),e.fillRect(t-3,i-1,1,2),e.fillRect(t-1,i-1,1,2),e.fillRect(t+2,i-1,1,2),e.fillRect(t+4,i-1,1,2),e.fillRect(t-5,i-5,2,1),e.fillStyle="#ffcc00",e.fillRect(t+5,i-5,1,1)}function zi(e,t,i){e.fillStyle="#5a3a1a",e.fillRect(t-5,i-5,10,4),e.fillRect(t+4,i-7,4,4),e.fillRect(t+4,i-8,1,1),e.fillRect(t+7,i-8,1,1),e.fillRect(t-4,i-1,2,2),e.fillRect(t+1,i-1,2,2),e.fillStyle="#1a1a1a",e.fillRect(t+6,i-6,1,1)}function Hi(e,t,i){e.fillStyle="#a07040",e.fillRect(t-4,i-5,8,3),e.fillRect(t+3,i-8,3,3),e.fillStyle="#7c6c4c",e.fillRect(t+3,i-10,1,2),e.fillRect(t+5,i-10,1,2),e.fillRect(t+2,i-10,1,1),e.fillRect(t+6,i-10,1,1),e.fillStyle="#a07040",e.fillRect(t-3,i-2,1,3),e.fillRect(t-1,i-2,1,3),e.fillRect(t+2,i-2,1,3),e.fillRect(t+4,i-2,1,3),e.fillStyle="#1a1a1a",e.fillRect(t+4,i-7,1,1)}function $i(e,t,i){e.fillStyle="#e0d8c8",e.fillRect(t-3,i-5,7,4),e.fillRect(t-2,i-6,5,1),e.fillStyle="#2a2a2a",e.fillRect(t+3,i-5,2,2),e.fillStyle="#3a3a3a",e.fillRect(t-2,i-1,1,2),e.fillRect(t+1,i-1,1,2)}function Pi(e,t,i){e.fillStyle="#5a4030",e.fillRect(t-4,i-4,8,3),e.fillRect(t+3,i-5,3,3),e.fillStyle="#e0d0b0",e.fillRect(t+6,i-4,1,1),e.fillStyle="#3a2a1a",e.fillRect(t-3,i-1,1,2),e.fillRect(t+2,i-1,1,2)}function Oi(e,t,i){e.fillStyle="#8a2020",e.fillRect(t-7,i-6,5,3),e.fillRect(t+3,i-6,5,3),e.fillRect(t-6,i-8,3,2),e.fillRect(t+4,i-8,3,2),e.fillStyle="#c44444",e.fillRect(t-4,i-3,9,4),e.fillRect(t+4,i-5,4,3),e.fillRect(t-6,i-2,3,2),e.fillRect(t-7,i-1,2,1),e.fillStyle="#ffcc00",e.fillRect(t+6,i-4,1,1),e.fillStyle=h.fireOrange,e.fillRect(t+8,i-4,2,1),e.fillStyle=h.fireYellow,e.fillRect(t+8,i-5,1,1),e.fillStyle="#3a1a1a",e.fillRect(t+4,i-6,1,1),e.fillRect(t+6,i-6,1,1),e.fillStyle="#a03030",e.fillRect(t-2,i+1,2,2),e.fillRect(t+2,i+1,2,2)}function Ni(e,t,i){e.fillStyle="#3a3a2a",e.fillRect(t-2,i-4,2,4),e.fillRect(t+1,i-4,2,4),e.fillStyle="#4a3a2a",e.fillRect(t-3,i-9,7,5),e.fillStyle=h.skinMedium,e.fillRect(t-2,i-12,5,3),e.fillStyle="#2a2a1a",e.fillRect(t-2,i-13,5,2),e.fillRect(t-3,i-12,1,2),e.fillStyle="#1a1a1a",e.fillRect(t-1,i-10,3,1),e.fillStyle="#a0a0a0",e.fillRect(t+4,i-10,1,6)}class Fi{canvas;ctx;camera;animationTime=0;minimapCanvas=null;minimapDirty=!0;constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.camera=new Qt(t.width,t.height),this.ctx.imageSmoothingEnabled=!1}resize(){const t=window.devicePixelRatio||1,i=this.canvas.parentElement;this.canvas.width=i.clientWidth*t,this.canvas.height=i.clientHeight*t,this.canvas.style.width=`${i.clientWidth}px`,this.canvas.style.height=`${i.clientHeight}px`,this.ctx.setTransform(t,0,0,t,0,0),this.ctx.imageSmoothingEnabled=!1,this.camera.resize(i.clientWidth,i.clientHeight)}render(t,i){this.animationTime+=i,this.camera.update();const n=this.ctx,{world:o,party:s,season:a}=t;n.fillStyle=h.deepWater,n.fillRect(0,0,this.camera.screenWidth,this.camera.screenHeight),n.save(),n.translate(this.camera.screenWidth/2-this.camera.x*this.camera.zoom,this.camera.screenHeight/2-this.camera.y*this.camera.zoom),n.scale(this.camera.zoom,this.camera.zoom);const r=this.camera.getVisibleRange(o.width,o.height);for(let l=r.minY;l<=r.maxY;l++)for(let c=r.minX;c<=r.maxX;c++){const d=o.tiles[l][c];this.renderTile(n,d,a,t)}for(let l=r.minY;l<=r.maxY;l++)for(let c=r.minX;c<=r.maxX;c++){const d=o.tiles[l][c];if(d.locationId){const u=o.locations.get(d.locationId);u&&!u.isDestroyed&&this.renderLocation(n,u,o.countries.get(u.countryId??"")?.color??null,d.elevation)}}for(const l of o.creatures.values()){const{x:c,y:d}=l.position;if(c>=r.minX&&c<=r.maxX&&d>=r.minY&&d<=r.maxY){const u=o.tiles[d][c];(u.explored||u.visible)&&this.renderCreature(n,l,u.elevation)}}this.renderParty(n,s.position.x,s.position.y,o.tiles[s.position.y]?.[s.position.x]?.elevation??.3),t.selectedTile&&this.renderSelectionHighlight(n,t.selectedTile.x,t.selectedTile.y,o.tiles[t.selectedTile.y]?.[t.selectedTile.x]?.elevation??.3),this.renderCountryBorders(n,o,r),n.restore(),this.renderMinimap(n,t),this.renderFogOfWar(n,t,r)}renderTile(t,i,n,o){const{x:s,y:a}=i,r=(s-a)*(w/2),l=(s+a)*(b/2),c=Kt(i.biome,i.elevation,(s*7+a*13)%8,n,i.vegetation),d=Math.floor(i.elevation*5)*C,u=r-w/2,f=l-c.height+b/2;t.drawImage(c,u,f),i.roadLevel>0&&this.renderRoad(t,r,l-d,i.roadLevel),i.explored?i.visible||(t.fillStyle="rgba(10,10,15,0.45)",this.fillIsoDiamond(t,r,l-d,w,b)):(t.fillStyle="rgba(10,10,15,0.85)",this.fillIsoDiamond(t,r,l-d,w,b))}renderRoad(t,i,n,o){const s=o>=3?h.roadHighway:o>=2?h.roadStone:h.roadDirt;t.fillStyle=s;const a=o>=3?6:o>=2?4:3;t.fillRect(i-a/2,n-a/2,a,a)}renderLocation(t,i,n,o){const{x:s,y:a}=i.position,r=(s-a)*(w/2),l=(s+a)*(b/2),c=Math.floor(o*5)*C,d=bi(i.type,i.size,n);t.drawImage(d,r-24,l-c-40),t.fillStyle=h.uiText,t.font="7px monospace",t.textAlign="center",t.fillText(i.name,r,l-c-42)}renderCreature(t,i,n){const{x:o,y:s}=i.position,a=(o-s)*(w/2),r=(o+s)*(b/2),l=Math.floor(n*5)*C,c=Wi(i.type);t.drawImage(c,a-8,r-l-16)}renderParty(t,i,n,o){const s=(i-n)*(w/2),a=(i+n)*(b/2),r=Math.floor(o*5)*C,l=Math.sin(this.animationTime*3)*.3+.7;t.fillStyle=me(h.uiHighlight,l*.3),this.fillIsoDiamond(t,s,a-r,w+4,b+2);const c=Ei();t.drawImage(c,s-8,a-r-20)}renderSelectionHighlight(t,i,n,o){const s=(i-n)*(w/2),a=(i+n)*(b/2),r=Math.floor(o*5)*C;t.strokeStyle=h.uiHighlight,t.lineWidth=1.5,t.beginPath(),t.moveTo(s,a-r-b/2),t.lineTo(s+w/2,a-r),t.lineTo(s,a-r+b/2),t.lineTo(s-w/2,a-r),t.closePath(),t.stroke()}renderCountryBorders(t,i,n){for(let o=n.minY;o<=n.maxY;o++)for(let s=n.minX;s<=n.maxX;s++){const a=i.tiles[o][s];if(!a.locationId)continue;const r=i.locations.get(a.locationId);if(!r?.countryId)continue;const l=i.countries.get(r.countryId);if(!l)continue;const c=(s-o)*(w/2),d=(s+o)*(b/2),u=Math.floor(a.elevation*5)*C;t.strokeStyle=me(l.color,.4),t.lineWidth=1,t.beginPath(),t.moveTo(c,d-u-b/2),t.lineTo(c+w/2,d-u),t.lineTo(c,d-u+b/2),t.lineTo(c-w/2,d-u),t.closePath(),t.stroke()}}renderMinimap(t,i){const o=this.camera.screenWidth-160-12,s=12;(this.minimapDirty||!this.minimapCanvas)&&(this.minimapCanvas=this.generateMinimapImage(i),this.minimapDirty=!1),t.fillStyle="rgba(10,10,20,0.8)",t.fillRect(o-2,s-2,164,164),t.strokeStyle=h.uiBorder,t.lineWidth=1,t.strokeRect(o-2,s-2,164,164),t.drawImage(this.minimapCanvas,o,s,160,160);const a=160/i.world.width,r=160/i.world.height,l=this.camera.getVisibleRange(i.world.width,i.world.height);t.strokeStyle=h.uiHighlight,t.lineWidth=1,t.strokeRect(o+l.minX*a,s+l.minY*r,(l.maxX-l.minX)*a,(l.maxY-l.minY)*r);const c=o+i.party.position.x*a,d=s+i.party.position.y*r;t.fillStyle=h.uiHighlight,t.fillRect(c-2,d-2,4,4)}generateMinimapImage(t){const{world:i}=t,n=new OffscreenCanvas(i.width,i.height),o=n.getContext("2d");for(let s=0;s<i.height;s++)for(let a=0;a<i.width;a++){const r=i.tiles[s][a];o.fillStyle=Yi(r),o.fillRect(a,s,1,1)}for(const s of i.locations.values()){if(s.isDestroyed)continue;const a=i.countries.get(s.countryId??"");o.fillStyle=a?.color??"#ffffff",o.fillRect(s.position.x-1,s.position.y-1,3,3)}return n}invalidateMinimap(){this.minimapDirty=!0}renderFogOfWar(t,i,n){}fillIsoDiamond(t,i,n,o,s){t.beginPath(),t.moveTo(i,n-s/2),t.lineTo(i+o/2,n),t.lineTo(i,n+s/2),t.lineTo(i-o/2,n),t.closePath(),t.fill()}}function Yi(e){if(e.locationId)return"#ffffff";if(e.roadLevel>0)return h.roadDirt;switch(e.biome){case"ocean":return h.deepWater;case"beach":return h.sand;case"desert":return h.desert;case"grassland":return h.grass;case"forest":return h.tree;case"dense_forest":return h.treeDark;case"jungle":return h.jungleTree;case"hills":return h.hillGrass;case"mountain":return h.rock;case"snow_mountain":return h.snow;case"tundra":return h.tundra;case"swamp":return h.swamp;case"savanna":return h.savanna;default:return h.grass}}class Gi{engine;renderer;canvas;isDragging=!1;lastMouseX=0;lastMouseY=0;keysDown=new Set;constructor(t,i,n){this.engine=t,this.renderer=i,this.canvas=n,this.setupEventListeners()}setupEventListeners(){window.addEventListener("keydown",t=>this.onKeyDown(t)),window.addEventListener("keyup",t=>this.onKeyUp(t)),this.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),this.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),this.canvas.addEventListener("mouseup",t=>this.onMouseUp(t)),this.canvas.addEventListener("wheel",t=>this.onWheel(t)),this.canvas.addEventListener("click",t=>this.onClick(t)),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.canvas.addEventListener("touchstart",t=>this.onTouchStart(t)),this.canvas.addEventListener("touchmove",t=>this.onTouchMove(t)),this.canvas.addEventListener("touchend",()=>this.onTouchEnd())}onKeyDown(t){this.keysDown.add(t.key);const i=this.engine.state;if(!(!i||i.gameOver))switch(t.key){case"w":case"ArrowUp":t.preventDefault(),this.engine.moveParty(-1,-1);break;case"e":this.engine.moveParty(1,-1);break;case"s":case"ArrowDown":t.preventDefault(),this.engine.moveParty(1,1);break;case"q":this.engine.moveParty(-1,1);break;case"a":case"ArrowLeft":t.preventDefault(),this.engine.moveParty(-1,0);break;case"d":case"ArrowRight":t.preventDefault(),this.engine.moveParty(1,0);break;case"Enter":case" ":t.preventDefault(),this.engine.endTurn();break;case"c":this.renderer.camera.centerOnTile(i.party.position.x,i.party.position.y);break;case"r":this.engine.rest();break;case"f":this.engine.buyFood();break;case"p":i.isPaused=!i.isPaused;break;case"+":case"=":this.renderer.camera.zoomAt(1.2,this.renderer.camera.screenWidth/2,this.renderer.camera.screenHeight/2);break;case"-":this.renderer.camera.zoomAt(.8,this.renderer.camera.screenWidth/2,this.renderer.camera.screenHeight/2);break}}onKeyUp(t){this.keysDown.delete(t.key)}onMouseDown(t){(t.button===0||t.button===2)&&(this.isDragging=!0,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY)}onMouseMove(t){if(this.isDragging){const i=t.clientX-this.lastMouseX,n=t.clientY-this.lastMouseY;this.renderer.camera.pan(i,n),this.lastMouseX=t.clientX,this.lastMouseY=t.clientY}}onMouseUp(t){this.isDragging=!1}onWheel(t){t.preventDefault();const i=t.deltaY>0?.9:1.1;this.renderer.camera.zoomAt(i,t.clientX,t.clientY)}onClick(t){if(this.isDragging)return;const i=this.engine.state;if(!i)return;const{tx:n,ty:o}=this.renderer.camera.screenToTile(t.clientX,t.clientY);n>=0&&n<i.world.width&&o>=0&&o<i.world.height&&(i.selectedTile={x:n,y:o})}onTouchStart(t){t.touches.length===1&&(this.isDragging=!0,this.lastMouseX=t.touches[0].clientX,this.lastMouseY=t.touches[0].clientY)}onTouchMove(t){if(t.preventDefault(),this.isDragging&&t.touches.length===1){const i=t.touches[0].clientX-this.lastMouseX,n=t.touches[0].clientY-this.lastMouseY;this.renderer.camera.pan(i,n),this.lastMouseX=t.touches[0].clientX,this.lastMouseY=t.touches[0].clientY}}onTouchEnd(){this.isDragging=!1}update(){this.keysDown.has("ArrowLeft")&&this.keysDown.has("Shift")&&this.renderer.camera.pan(8,0),this.keysDown.has("ArrowRight")&&this.keysDown.has("Shift")&&this.renderer.camera.pan(-8,0),this.keysDown.has("ArrowUp")&&this.keysDown.has("Shift")&&this.renderer.camera.pan(0,8),this.keysDown.has("ArrowDown")&&this.keysDown.has("Shift")&&this.renderer.camera.pan(0,-8)}}class Vi{ctx;engine;width;height;constructor(t,i){this.ctx=t,this.engine=i,this.width=0,this.height=0}render(t,i,n){this.width=i,this.height=n,this.renderTopBar(t),this.renderEventLog(t),this.renderBottomBar(t),this.renderTileInfo(t),this.renderPartyStatus(t)}renderTopBar(t){const i=this.ctx,n=32;i.fillStyle="rgba(10,10,20,0.85)",i.fillRect(0,0,this.width-180,n),i.fillStyle=h.uiBorder,i.fillRect(0,n,this.width-180,1),i.fillStyle=h.uiText,i.font="12px monospace",i.textAlign="left";const o=this.engine.getDateString();i.fillText(o,12,20);const s={clear:"Clear",cloudy:"Cloudy",rain:"Rain",storm:"Storm",snow:"Snow",fog:"Fog",heatwave:"Heat",blizzard:"Blizzard"};i.fillStyle=h.uiHighlight,i.fillText(`Weather: ${s[t.weather]??t.weather}`,300,20),i.fillStyle=h.uiText,i.fillText(`Turn ${t.turn}`,480,20);const a=Array.from(t.world.characters.values()).filter(l=>l.isAlive).length,r=Array.from(t.world.locations.values()).filter(l=>!l.isDestroyed).length;i.fillText(`Pop: ${a} | Settlements: ${r}`,570,20)}renderEventLog(t){const i=this.ctx,n=380,o=180,s=8,a=this.height-o-50;i.fillStyle="rgba(10,10,20,0.8)",i.fillRect(s,a,n,o),i.strokeStyle=h.uiBorder,i.lineWidth=1,i.strokeRect(s,a,n,o),i.fillStyle=h.uiHighlight,i.font="10px monospace",i.textAlign="left",i.fillText("EVENT LOG",s+8,a+14);const r=t.eventLog.slice(-12),l=13;let c=a+28;for(const d of r){i.fillStyle=Xi(d.type),i.font="9px monospace";const u=`[${d.turn}] ${d.message}`,f=50,m=u.length>f?u.slice(0,f)+"...":u;i.fillText(m,s+8,c),c+=l}}renderBottomBar(t){const i=this.ctx,n=40,o=this.height-n;i.fillStyle="rgba(10,10,20,0.85)",i.fillRect(0,o,this.width,n),i.fillStyle=h.uiBorder,i.fillRect(0,o,this.width,1),i.fillStyle="#8a8070",i.font="10px monospace",i.textAlign="center",i.fillText("WASD/QE: Move | ENTER/SPACE: End Turn | R: Rest | F: Buy Food | Scroll: Zoom | C: Center",this.width/2,o+15),i.fillStyle=h.uiHighlight,i.textAlign="left",i.fillText(`Movement: ${t.party.movementPoints}/${t.party.maxMovementPoints}`,12,o+30),i.fillText(`Gold: ${t.party.gold}`,200,o+30);const s=t.party.members[0];if(s){const r=s.health/s.maxHealth,l=r>.6?h.uiSafe:r>.3?h.uiHighlight:h.uiDanger;i.fillStyle=l,i.fillText(`HP: ${Math.round(s.health)}/${s.maxHealth}`,320,o+30)}const a=t.world.tiles[t.party.position.y]?.[t.party.position.x];if(a?.locationId){const r=t.world.locations.get(a.locationId);r&&!r.isDestroyed&&(i.fillStyle=h.uiHighlight,i.textAlign="right",i.fillText(`At: ${r.name} (${r.type})`,this.width-12,o+30))}}renderTileInfo(t){if(!t.selectedTile)return;const i=this.ctx,n=this.engine.getTileInfo(t.selectedTile.x,t.selectedTile.y);if(n.length===0)return;const o=220,s=n.length*16+24,a=this.width-o-12,r=180;i.fillStyle="rgba(10,10,20,0.85)",i.fillRect(a,r,o,s),i.strokeStyle=h.uiBorder,i.lineWidth=1,i.strokeRect(a,r,o,s),i.fillStyle=h.uiHighlight,i.font="10px monospace",i.textAlign="left",i.fillText("TILE INFO",a+8,r+14);let l=r+30;for(const c of n)i.fillStyle=h.uiText,i.font="9px monospace",i.fillText(c,a+8,l),l+=16}renderPartyStatus(t){const i=this.ctx,n=t.party.members[0];if(!n)return;const o=8,s=40,a=180,r=100;i.fillStyle="rgba(10,10,20,0.8)",i.fillRect(o,s,a,r),i.strokeStyle=h.uiBorder,i.lineWidth=1,i.strokeRect(o,s,a,r),i.fillStyle=h.uiHighlight,i.font="10px monospace",i.textAlign="left",i.fillText(n.name,o+8,s+14),i.fillStyle=h.uiText,i.font="9px monospace",i.fillText("Level: Adventurer",o+8,s+28),i.fillText(`STR:${n.stats.strength} DEX:${n.stats.dexterity} INT:${n.stats.intelligence}`,o+8,s+42),i.fillText(`CHR:${n.stats.charisma} END:${n.stats.endurance}`,o+8,s+56);const l=o+8,c=s+64,d=a-16,u=8,f=n.health/n.maxHealth;i.fillStyle="#2a1a1a",i.fillRect(l,c,d,u),i.fillStyle=f>.6?h.uiSafe:f>.3?h.uiHighlight:h.uiDanger,i.fillRect(l,c,d*f,u),i.fillStyle=h.uiText,i.fillText(`Combat: ${n.skills.combat??0} | Survival: ${n.skills.survival??0}`,o+8,s+88)}}function Xi(e){switch(e){case"combat":return"#e04040";case"trade":return"#40a0e0";case"political":return"#a040e0";case"discovery":return"#40e040";case"danger":return"#e08040";case"social":return"#e0a0e0";case"system":return"#a0a0a0";default:return h.uiText}}const te=document.getElementById("game-canvas"),re=document.getElementById("loading-screen"),ji=document.getElementById("loading-bar"),E=new yi,M=new Fi(te),Ui=new Vi(te.getContext("2d"),E);function Ie(){M.resize()}window.addEventListener("resize",Ie);Ie();function Qi(e,t){ji.style.width=`${Math.round(t*100)}%`;const i=re.querySelector("p");i&&(i.textContent=e)}async function Ki(){const e=Math.floor(Math.random()*999999999);await new Promise(o=>{setTimeout(()=>{E.newGame({seed:e,width:128,height:128},Qi),o()},50)}),M.camera.centerOnTile(E.state.party.position.x,E.state.party.position.y),M.camera.x=M.camera.targetX,M.camera.y=M.camera.targetY,re.style.opacity="0",setTimeout(()=>{re.style.display="none"},500);const t=new Gi(E,M,te);let i=performance.now();function n(o){const s=(o-i)/1e3;i=o,t.update(),M.render(E.state,s),te.getContext("2d"),Ui.render(E.state,M.camera.screenWidth,M.camera.screenHeight),requestAnimationFrame(n)}requestAnimationFrame(n)}Ki().catch(console.error);
