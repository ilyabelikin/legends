(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();class x{state;constructor(t){this.state=t|0}next(){this.state=this.state+1831565813|0;let t=Math.imul(this.state^this.state>>>15,1|this.state);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}nextInt(t,i){return Math.floor(this.next()*(i-t+1))+t}nextFloat(t,i){return this.next()*(i-t)+t}pick(t){return t[Math.floor(this.next()*t.length)]}shuffle(t){for(let i=t.length-1;i>0;i--){const o=Math.floor(this.next()*(i+1));[t[i],t[o]]=[t[o],t[i]]}return t}chance(t){return this.next()<t}weightedPick(t){const i=t.reduce((n,[,s])=>n+s,0);let o=this.next()*i;for(const[n,s]of t)if(o-=s,o<=0)return n;return t[t.length-1][0]}gaussian(t=0,i=1){const o=this.next(),n=this.next();return Math.sqrt(-2*Math.log(o))*Math.cos(2*Math.PI*n)*i+t}fork(){return new x(this.nextInt(0,2147483647))}}let Le=0;function L(e=""){return Le++,`${e}${e?"_":""}${Le.toString(36)}_${Date.now().toString(36)}`}class le{perm;grad3;constructor(t){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];const i=new Uint8Array(256);for(let o=0;o<256;o++)i[o]=o;for(let o=255;o>0;o--){const n=Math.floor(t.next()*(o+1));[i[o],i[n]]=[i[n],i[o]]}this.perm=new Uint8Array(512);for(let o=0;o<512;o++)this.perm[o]=i[o&255]}dot2(t,i,o){return t[0]*i+t[1]*o}noise2D(t,i){const o=.5*(Math.sqrt(3)-1),n=(3-Math.sqrt(3))/6,s=(t+i)*o,a=Math.floor(t+s),r=Math.floor(i+s),l=(a+r)*n,c=a-l,d=r-l,f=t-c,u=i-d;let h,p;f>u?(h=1,p=0):(h=0,p=1);const y=f-h+n,b=u-p+n,m=f-1+2*n,I=u-1+2*n,v=a&255,w=r&255,R=this.perm[v+this.perm[w]]%12,k=this.perm[v+h+this.perm[w+p]]%12,M=this.perm[v+1+this.perm[w+1]]%12;let T,A,N,$=.5-f*f-u*u;$<0?T=0:($*=$,T=$*$*this.dot2(this.grad3[R],f,u));let X=.5-y*y-b*b;X<0?A=0:(X*=X,A=X*X*this.dot2(this.grad3[k],y,b));let G=.5-m*m-I*I;return G<0?N=0:(G*=G,N=G*G*this.dot2(this.grad3[M],m,I)),70*(T+A+N)}fbm(t,i,o,n=2,s=.5){let a=0,r=1,l=1,c=0;for(let d=0;d<o;d++)a+=r*this.noise2D(t*l,i*l),c+=r,r*=s,l*=n;return a/c}ridgeNoise(t,i,o,n=2,s=.5){let a=0,r=1,l=1,c=0;for(let d=0;d<o;d++){let f=this.noise2D(t*l,i*l);f=1-Math.abs(f),f=f*f,a+=r*f,c+=r,r*=s,l*=n}return a/c}}function H(e,t,i){return Math.max(t,Math.min(i,e))}function S(e,t){const i=e.x,o=e.y,n=-i-o,s=t.x,a=t.y,r=-s-a;return(Math.abs(i-s)+Math.abs(o-a)+Math.abs(n-r))/2}function K(e,t){const i=e.x-t.x,o=e.y-t.y;return Math.sqrt(i*i+o*o)}function tt(e,t,i){return[{x:1,y:0},{x:0,y:-1},{x:-1,y:-1},{x:-1,y:0},{x:0,y:1},{x:1,y:1}].map(n=>({x:e.x+n.x,y:e.y+n.y})).filter(n=>n.x>=0&&n.x<t&&n.y>=0&&n.y<i)}function re(e,t,i){return e.x>=0&&e.x<t&&e.y>=0&&e.y<i}function P(e,t,i,o){return{x:i*e,y:o*t}}function ye(e,t,i,o){const n=e/i,s=t/o;return it(n,s)}function it(e,t){const i=-e-t;let o=Math.round(e),n=Math.round(t),s=Math.round(i);const a=Math.abs(o-e),r=Math.abs(n-t),l=Math.abs(s-i);return a>r&&a>l?o=-n-s:r>l&&(n=-o-s),{q:o,r:n}}const ot=[{max:2,type:"deep_ocean"},{max:4,type:"shallow_ocean"},{max:5,type:"lowland"},{max:7,type:"lowland"},{max:9,type:"highland"},{max:12,type:"mountain"},{max:14,type:"peak"}];function nt(e){for(const t of ot)if(e<=t.max)return t.type;return"peak"}function st(e,t,i,o,n){const s=[{dx:1,dy:0},{dx:0,dy:-1},{dx:-1,dy:-1},{dx:-1,dy:0},{dx:0,dy:1},{dx:1,dy:1}];for(const{dx:a,dy:r}of s){const l=e+a,c=t+r;if(l>=0&&l<o&&c>=0&&c<n){const d=i[c][l];if(d==="deep_ocean"||d==="shallow_ocean")return!0}}return!1}function E(e){return e==="deep_ocean"||e==="shallow_ocean"}function at(e,t,i){const o=new le(i),n=new le(i.fork()),s=[];for(let a=0;a<t;a++){s[a]=[];for(let r=0;r<e;r++){const l=r/e,c=a/t;let d=0;d+=1*o.noise2D(l*3,c*3),d+=.5*o.noise2D(l*6,c*6),d+=.25*o.noise2D(l*12,c*12),d+=.12*o.noise2D(l*24,c*24),d=d/(1+.5+.25+.12);const f=n.ridgeNoise(l*4,c*4,4,2,.5);d=d*.7+f*.3,d=(d+1)/2;const u=l-.35,h=c-.35,p=Math.sqrt(u*u+h*h)*2.2,y=o.noise2D(l*2,c*2)*.15,b=1-Math.pow(H(p+y,0,1),1.8);d=d*b;const m=l-.65,I=c-.7,v=Math.sqrt(m*m+I*I)*2.5,w=o.noise2D(l*2.3+7,c*2.3+7)*.18,R=1-Math.pow(H(v+w,0,1),1.6),k=o.fbm(l*4+10,c*4+10,4)*.5+.5;d=Math.max(d,k*R*.75);const M=l-.75,T=c-.25,A=Math.sqrt(M*M+T*T)*5,N=1-Math.pow(H(A,0,1),2.8),$=o.fbm(l*5+20,c*5+20,3)*.5+.5;d=Math.max(d,$*N*.58);const X=l-.55,G=c-.5,Qe=Math.sqrt(X*X+G*G)*6,Ke=1-Math.pow(H(Qe,0,1),3),Ze=o.fbm(l*6+40,c*6+40,3)*.5+.5;d=Math.max(d,Ze*Ke*.5);const Me=l-.2,Te=c-.8,Je=Math.sqrt(Me*Me+Te*Te)*7,xe=1-Math.pow(H(Je,0,1),3.5),et=o.fbm(l*7+60,c*7+60,2)*.5+.5;d=Math.max(d,et*xe*.45),s[a][r]=Math.floor(H(d,0,.999)*15)}}return s}function lt(e,t,i,o){const n=new le(o),s=[];for(let a=0;a<t;a++){s[a]=[];for(let r=0;r<e;r++){const l=a/t,c=1-Math.abs(l-.5)*2,d=i[a][r]/14,f=Math.max(0,d-.5)*1.5,u=r/e,h=n.noise2D(u*4,l*4)*.15,p=c-f+h;s[a][r]=H(p,0,1)}}return s}function rt(e,t,i,o,n){const s=new le(n),a=[],r=ct(e,t,o);for(let l=0;l<t;l++){a[l]=[];for(let c=0;c<e;c++){const d=c/e,f=l/t;let u=0;u+=1*s.noise2D(d*3,f*3),u+=.5*s.noise2D(d*6,f*6),u+=.25*s.noise2D(d*12,f*12),u=u/(1+.5+.25),u=(u+1)/2;const h=r[l][c],p=Math.max(0,1-h/15);u=u*.6+p*.4;const y=(1-i[l][c])*.2;u+=y,a[l][c]=H(u,0,1)}}return a}function ct(e,t,i){const o=Array.from({length:t},()=>new Array(e).fill(1/0)),n=[];for(let r=0;r<t;r++)for(let l=0;l<e;l++)E(i[r][l])&&(o[r][l]=0,n.push([l,r]));const s=[[0,-1],[1,0],[0,1],[-1,0]];let a=0;for(;a<n.length;){const[r,l]=n[a++];for(const[c,d]of s){const f=r+c,u=l+d;if(f>=0&&f<e&&u>=0&&u<t){const h=o[l][r]+1;h<o[u][f]&&(o[u][f]=h,n.push([f,u]))}}}return o}function dt(e,t,i,o,n,s){const a=[];for(let r=0;r<t;r++){a[r]=[];for(let l=0;l<e;l++)a[r][l]=ft(i[r][l],o[r][l],n[r][l],s[r][l])}return a}function ft(e,t,i,o){return E(o)?"ocean":o==="coast"?i>.6&&t<.3?"desert":"beach":o==="peak"?"snow_mountain":o==="mountain"?"mountain":o==="highland"?"hills":i<.2?"tundra":i>.65&&t<.2?"desert":i>.6&&t<.4?"savanna":i>.7&&t>.7?"jungle":t>.75&&e<=6?"swamp":t>.65?"dense_forest":t>.4?"forest":"grassland"}const B={wood:{id:"wood",name:"Wood",category:"raw",baseValue:2,weight:3,spoilRate:0,stackSize:50,storageRequirement:"dry",description:"Raw timber from the forest."},stone:{id:"stone",name:"Stone",category:"raw",baseValue:2,weight:5,spoilRate:0,stackSize:40,storageRequirement:"none",description:"Rough quarried stone."},iron_ore:{id:"iron_ore",name:"Iron Ore",category:"raw",baseValue:4,weight:4,spoilRate:0,stackSize:30,storageRequirement:"none",description:"Unrefined iron ore from the mines."},gold_ore:{id:"gold_ore",name:"Gold Ore",category:"raw",baseValue:12,weight:5,spoilRate:0,stackSize:20,storageRequirement:"secure",description:"Raw gold-bearing rock."},coal:{id:"coal",name:"Coal",category:"raw",baseValue:3,weight:3,spoilRate:0,stackSize:40,storageRequirement:"dry",description:"Fuel for smelting and heating."},salt:{id:"salt",name:"Salt",category:"raw",baseValue:5,weight:2,spoilRate:0,stackSize:30,storageRequirement:"dry",description:"Precious preservative and seasoning."},wheat:{id:"wheat",name:"Wheat",category:"food",baseValue:2,weight:1,spoilRate:.005,stackSize:60,storageRequirement:"dry",description:"Harvested grain ready for milling."},fish:{id:"fish",name:"Fish",category:"food",baseValue:3,weight:1,spoilRate:.02,stackSize:30,storageRequirement:"cold",description:"Fresh catch from the waters."},berries:{id:"berries",name:"Berries",category:"food",baseValue:1,weight:.5,spoilRate:.04,stackSize:40,storageRequirement:"cold",description:"Wild forest berries."},meat:{id:"meat",name:"Meat",category:"food",baseValue:4,weight:2,spoilRate:.02,stackSize:25,storageRequirement:"cold",description:"Fresh game or livestock meat."},exotic_fruit:{id:"exotic_fruit",name:"Exotic Fruit",category:"food",baseValue:8,weight:1,spoilRate:.06,stackSize:20,storageRequirement:"cold",description:"Rare tropical fruit from the jungle."},wool:{id:"wool",name:"Wool",category:"material",baseValue:3,weight:1,spoilRate:0,stackSize:40,storageRequirement:"dry",description:"Raw sheep wool."},herbs:{id:"herbs",name:"Herbs",category:"material",baseValue:4,weight:.5,spoilRate:.02,stackSize:30,storageRequirement:"dry",description:"Medicinal and culinary herbs."},rare_herbs:{id:"rare_herbs",name:"Rare Herbs",category:"material",baseValue:15,weight:.5,spoilRate:.02,stackSize:15,storageRequirement:"dry",description:"Rare plants with potent properties."},hides:{id:"hides",name:"Hides",category:"material",baseValue:4,weight:2,spoilRate:.01,stackSize:25,storageRequirement:"dry",description:"Animal skins ready for tanning."},lumber:{id:"lumber",name:"Lumber",category:"processed",baseValue:5,weight:4,spoilRate:0,stackSize:40,storageRequirement:"dry",description:"Milled timber planks."},iron_ingot:{id:"iron_ingot",name:"Iron Ingot",category:"processed",baseValue:10,weight:3,spoilRate:0,stackSize:25,storageRequirement:"none",description:"Smelted iron bar."},gold_ingot:{id:"gold_ingot",name:"Gold Ingot",category:"processed",baseValue:30,weight:4,spoilRate:0,stackSize:15,storageRequirement:"secure",description:"Pure gold bar."},bread:{id:"bread",name:"Bread",category:"food",baseValue:4,weight:.5,spoilRate:.03,stackSize:40,storageRequirement:"dry",description:"Freshly baked bread."},fabric:{id:"fabric",name:"Fabric",category:"processed",baseValue:8,weight:1,spoilRate:0,stackSize:30,storageRequirement:"dry",description:"Woven cloth from wool."},leather:{id:"leather",name:"Leather",category:"processed",baseValue:8,weight:1.5,spoilRate:0,stackSize:25,storageRequirement:"dry",description:"Tanned animal leather."},tools:{id:"tools",name:"Tools",category:"processed",baseValue:15,weight:3,spoilRate:0,stackSize:15,storageRequirement:"dry",description:"Iron tools for crafting and farming."},ale:{id:"ale",name:"Ale",category:"processed",baseValue:5,weight:2,spoilRate:.01,stackSize:25,storageRequirement:"cold",description:"Brewed ale from wheat."},medicine:{id:"medicine",name:"Medicine",category:"processed",baseValue:20,weight:.5,spoilRate:.01,stackSize:15,storageRequirement:"dry",description:"Herbal remedies and poultices."},weapons:{id:"weapons",name:"Weapons",category:"military",baseValue:25,weight:3,spoilRate:0,stackSize:10,storageRequirement:"dry",description:"Forged iron swords and spears."},armor:{id:"armor",name:"Armor",category:"military",baseValue:35,weight:5,spoilRate:0,stackSize:8,storageRequirement:"dry",description:"Iron and leather body armor."},sheep:{id:"sheep",name:"Sheep",category:"raw",baseValue:8,weight:10,spoilRate:0,stackSize:20,storageRequirement:"none",description:"Woolly livestock — source of wool and meat."},deer:{id:"deer",name:"Deer",category:"raw",baseValue:6,weight:8,spoilRate:0,stackSize:10,storageRequirement:"none",description:"Wild deer — source of meat and hides."}},ut=[{resourceId:"wood",biomes:["forest","dense_forest","jungle"],chance:.4,amountRange:[50,200],replenishRate:.5},{resourceId:"deer",biomes:["forest","dense_forest","grassland"],chance:.15,amountRange:[5,20],replenishRate:.1},{resourceId:"berries",biomes:["forest","dense_forest"],chance:.2,amountRange:[10,40],replenishRate:.3},{resourceId:"herbs",biomes:["forest","swamp","grassland"],chance:.15,amountRange:[5,20],replenishRate:.2},{resourceId:"rare_herbs",biomes:["dense_forest","jungle","swamp"],chance:.05,amountRange:[2,8],replenishRate:.05},{resourceId:"wheat",biomes:["grassland","savanna"],chance:.3,amountRange:[20,60],replenishRate:0},{resourceId:"sheep",biomes:["grassland","hills","savanna"],chance:.15,amountRange:[5,20],replenishRate:.1},{resourceId:"iron_ore",biomes:["mountain","hills"],chance:.25,amountRange:[30,150],replenishRate:0},{resourceId:"gold_ore",biomes:["mountain","desert"],chance:.08,amountRange:[10,60],replenishRate:0},{resourceId:"coal",biomes:["mountain","hills"],chance:.2,amountRange:[40,120],replenishRate:0},{resourceId:"stone",biomes:["mountain","hills","tundra","snow_mountain"],chance:.3,amountRange:[50,200],replenishRate:0},{resourceId:"fish",biomes:["beach"],chance:.4,amountRange:[30,80],replenishRate:.5},{resourceId:"salt",biomes:["beach","desert"],chance:.1,amountRange:[20,60],replenishRate:0},{resourceId:"exotic_fruit",biomes:["jungle"],chance:.2,amountRange:[10,30],replenishRate:.3}];function ht(e,t,i,o){for(let n=0;n<i;n++)for(let s=0;s<t;s++){const a=e[n][s],r=a.biome,l=ut.filter(f=>f.biomes.includes(r));let c=null,d=0;for(const f of l)if(o.chance(f.chance)){const u=o.nextInt(f.amountRange[0],f.amountRange[1]),h=B[f.resourceId],p=u*(h?.baseValue??1);p>d&&(d=p,c={resourceId:f.resourceId,amount:u,maxAmount:u,replenishRate:f.replenishRate})}a.resourceDeposit=c}}const oe={ocean:{type:"ocean",name:"Ocean",description:"Deep open waters, impassable without a ship.",movementCost:1/0,elevationRange:[4,4],moistureRange:[0,1],temperatureRange:[0,1],baseColor:"#1a5276",vegetationDensity:0,possibleResources:["fish"],dangerLevel:.3,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:1,productionMultiplier:.5},summer:{movementMultiplier:1,productionMultiplier:1}}},beach:{type:"beach",name:"Beach",description:"Sandy coastline where land meets sea.",movementCost:1.3,elevationRange:[4,4],moistureRange:[.3,1],temperatureRange:[.3,1],baseColor:"#e8d4a2",vegetationDensity:.05,possibleResources:["fish","salt"],dangerLevel:.1,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.2,productionMultiplier:.7},summer:{movementMultiplier:1,productionMultiplier:1}}},desert:{type:"desert",name:"Desert",description:"Arid wasteland with scorching heat and little water.",movementCost:2,elevationRange:[5,8],moistureRange:[0,.15],temperatureRange:[.65,1],baseColor:"#d4a843",vegetationDensity:.02,possibleResources:["gold_ore","stone"],dangerLevel:.3,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:.9,productionMultiplier:.9},summer:{movementMultiplier:1.3,productionMultiplier:.7}}},grassland:{type:"grassland",name:"Grassland",description:"Fertile plains with tall grasses — ideal for farming.",movementCost:1,elevationRange:[4,7],moistureRange:[.25,.6],temperatureRange:[.3,.7],baseColor:"#5a9c3a",vegetationDensity:.3,possibleResources:["wheat","sheep","herbs"],dangerLevel:.1,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.2,productionMultiplier:.3},summer:{movementMultiplier:1,productionMultiplier:1.2}}},forest:{type:"forest",name:"Forest",description:"Temperate woodland rich in timber and wildlife.",movementCost:1.5,elevationRange:[5,8],moistureRange:[.4,.75],temperatureRange:[.25,.65],baseColor:"#2d6b1e",vegetationDensity:.7,possibleResources:["wood","deer","berries","herbs"],dangerLevel:.2,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.5,productionMultiplier:.4},summer:{movementMultiplier:1,productionMultiplier:1}}},dense_forest:{type:"dense_forest",name:"Dense Forest",description:"Thick, dark woodland — hard to traverse but full of secrets.",movementCost:2.5,elevationRange:[5,8],moistureRange:[.65,1],temperatureRange:[.25,.65],baseColor:"#1a4c0c",vegetationDensity:.9,possibleResources:["wood","deer","berries","herbs","rare_herbs"],dangerLevel:.4,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:2,productionMultiplier:.2},summer:{movementMultiplier:1,productionMultiplier:.8}}},jungle:{type:"jungle",name:"Jungle",description:"Lush tropical rainforest teeming with life and danger.",movementCost:3,elevationRange:[5,7],moistureRange:[.75,1],temperatureRange:[.7,1],baseColor:"#1a6b1a",vegetationDensity:.95,possibleResources:["wood","rare_herbs","exotic_fruit"],dangerLevel:.5,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:1.1,productionMultiplier:.9},summer:{movementMultiplier:1,productionMultiplier:1}}},hills:{type:"hills",name:"Hills",description:"Rolling grassy hills with stone outcrops — good for grazing.",movementCost:1.5,elevationRange:[8,9],moistureRange:[.2,.6],temperatureRange:[.2,.7],baseColor:"#8c9c5c",vegetationDensity:.25,possibleResources:["stone","iron_ore","sheep","coal"],dangerLevel:.15,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1.5,productionMultiplier:.5},summer:{movementMultiplier:1,productionMultiplier:1}}},mountain:{type:"mountain",name:"Mountains",description:"Tall rocky peaks — dangerous but rich in ore.",movementCost:3,elevationRange:[10,12],moistureRange:[0,1],temperatureRange:[0,1],baseColor:"#7c7c7c",vegetationDensity:.05,possibleResources:["iron_ore","gold_ore","stone","coal"],dangerLevel:.4,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:2.5,productionMultiplier:.3},summer:{movementMultiplier:1,productionMultiplier:.9}}},snow_mountain:{type:"snow_mountain",name:"Snow-capped Peaks",description:"Frozen mountain heights — nearly impassable.",movementCost:5,elevationRange:[13,14],moistureRange:[0,1],temperatureRange:[0,.3],baseColor:"#c8c8d8",vegetationDensity:0,possibleResources:["stone"],dangerLevel:.6,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:3,productionMultiplier:.1},summer:{movementMultiplier:1,productionMultiplier:.5}}},tundra:{type:"tundra",name:"Tundra",description:"Frozen wasteland with permafrost and harsh winds.",movementCost:2,elevationRange:[5,9],moistureRange:[.1,.5],temperatureRange:[0,.2],baseColor:"#a8b8a0",vegetationDensity:.05,possibleResources:["stone","iron_ore"],dangerLevel:.35,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:2,productionMultiplier:.1},summer:{movementMultiplier:1,productionMultiplier:.6}}},swamp:{type:"swamp",name:"Swamp",description:"Murky wetlands — treacherous but with rare herbs.",movementCost:2.5,elevationRange:[4,6],moistureRange:[.7,1],temperatureRange:[.3,.7],baseColor:"#4c6c3c",vegetationDensity:.5,possibleResources:["herbs","rare_herbs","fish"],dangerLevel:.35,canBuildSettlement:!1,seasonalEffects:{winter:{movementMultiplier:1.5,productionMultiplier:.3},summer:{movementMultiplier:1,productionMultiplier:.8}}},savanna:{type:"savanna",name:"Savanna",description:"Dry grasslands with scattered trees and roaming herds.",movementCost:1.2,elevationRange:[4,7],moistureRange:[.15,.35],temperatureRange:[.6,.9],baseColor:"#b8a848",vegetationDensity:.15,possibleResources:["wheat","sheep","herbs"],dangerLevel:.2,canBuildSettlement:!0,seasonalEffects:{winter:{movementMultiplier:1,productionMultiplier:.8},summer:{movementMultiplier:1.1,productionMultiplier:1}}}},pt=["Aldric","Bran","Cedric","Doran","Edric","Finn","Gareth","Harald","Ivan","Jasper","Kael","Leif","Magnus","Nolan","Oswin","Percival","Quinn","Rowan","Silas","Theron","Ulric","Voss","Wren","Yorick","Zephyr","Alden","Bjorn","Corwin","Dorian","Elric","Felix","Gideon","Hector","Ingram","Jareth","Kellan","Lorcan","Merrick","Nigel","Orin","Phelan","Ragnar","Stellan","Torin","Uther","Vidar","Wolfric","Arden"],mt=["Alara","Brynn","Celeste","Daria","Elara","Freya","Gwendolyn","Helena","Isolde","Juna","Kira","Lyra","Miriel","Nessa","Orla","Petra","Rosalind","Seren","Thea","Una","Vera","Wilda","Ysolde","Zara","Aelith","Brigid","Cordelia","Dahlia","Eira","Fiona","Greta","Hilda","Iris","Jorunn","Katla","Lena","Maren","Niamh","Olwen","Rhiannon","Sigrid","Talia","Ursa","Violet","Wynne","Astrid","Rowena","Svea"],Fe=["Ironforge","Stonewall","Blackthorn","Ashwood","Silverbrook","Goldcrest","Ravenhill","Oakenshield","Winterborne","Thornfield","Brightwater","Darkmoor","Greycloak","Hawkswood","Nightingale","Redstone","Whitewolf","Greenhollow","Stormborn","Firebrand","Coldwell","Deepwood","Fairweather","Highforge","Longstrider","Meadowbrook","Northwind","Proudfoot","Quicksilver","Riverton","Strongbow","Truehart","Underhill","Wildwood","Copperfield","Dunmore","Elderwood","Foxglove","Grimshaw","Heathrow","Kettleblack","Marshwood","Oakridge","Pennywhistle","Sagewind","Thornwick","Valeborn","Woodhaven"],yt=["Stone","Iron","Green","White","Black","Red","Gold","Silver","Oak","Elm","Ash","Thorn","Raven","Wolf","Bear","Hawk","River","Lake","Hill","Dale","Glen","Mist","Storm","Frost","High","Low","North","South","East","West","Old","New","Dark","Bright","Deep","Long","Fair","Cold","Warm","Wild"],gt=["haven","hold","stead","gate","ford","bridge","burgh","ton","dale","vale","field","wood","moor","wick","mere","marsh","crest","peak","fall","reach","watch","guard","wall","helm","keep","rock","port","bay","cove","shore","cross","way"],bt=["Kingdom of {name}","Realm of {name}","Duchy of {name}","Principality of {name}","Dominion of {name}","{name}","The {adj} Kingdom","Land of {name}","Free City of {name}"],It=["Northern","Southern","Eastern","Western","United","Holy","Grand","Great","Ancient","Iron","Golden","Silver"],vt=["Valderia","Aethelmark","Norheim","Sunreach","Frostholme","Thornwall","Ashenmoor","Brightwind","Ironvale","Goldcrest","Ravenshire","Stormhold","Deepwood","Highreach","Westmarch","Silverkeep","Darkhollow","Greenholme","Redspire","Whitecliff"],wt=["Pyraxis","Vorthrun","Ashenwing","Glacius","Thundermaw","Nightfang","Emberclaw","Stormscale","Dreadfire","Shadowcoil","Ironhide","Frostbite","Cinderjaw","Deathwing","Silvanus"];function Rt(e){return`${e.pick(pt)} ${e.pick(Fe)}`}function kt(e){return`${e.pick(mt)} ${e.pick(Fe)}`}function ce(e,t){return t==="male"?Rt(e):kt(e)}function St(e){return`${e.pick(yt)}${e.pick(gt)}`}function Mt(e){const t=e.pick(bt),i=e.pick(vt),o=e.pick(It);return t.replace("{name}",i).replace("{adj}",o)}function De(e){return e.pick(wt)}const Tt=6,Lt=120;function Dt(e,t,i,o){const n=oe[e.biome];if(!n||!n.canBuildSettlement)return 0;let s=0;e.elevation>=4&&e.elevation<=7?s+=3:e.elevation>=8&&e.elevation<=9&&(s+=1);let a=!1;for(let l=-3;l<=3;l++)for(let c=-3;c<=3;c++){const d=e.x+c,f=e.y+l;if(d>=0&&d<i&&f>=0&&f<o){const u=t[f][d].terrainType;(u==="shallow_ocean"||u==="coast")&&(a=!0)}}a&&(s+=3);let r=0;for(let l=-4;l<=4;l++)for(let c=-4;c<=4;c++){const d=e.x+c,f=e.y+l;if(d>=0&&d<i&&f>=0&&f<o){const u=t[f][d].resourceDeposit;u&&(r+=u.amount*.01)}}return s+=Math.min(r,5),e.biome==="grassland"&&(s+=2),e.biome==="forest"&&(s+=1),e.biome==="hills"&&(s+=1),e.biome==="beach"&&(s+=1),e.temperature>.3&&e.temperature<.7&&(s+=1),s}function At(e,t,i,o,n){let s=!1;for(let a=-2;a<=2;a++)for(let r=-2;r<=2;r++){const l=e.x+r,c=e.y+a;l>=0&&l<i&&c>=0&&c<o&&t[c][l].terrainType==="shallow_ocean"&&(s=!0)}return s&&n.chance(.3)?"fishing_village":(e.resourceDeposit?.resourceId==="iron_ore"||e.resourceDeposit?.resourceId==="gold_ore"||e.resourceDeposit?.resourceId==="coal")&&n.chance(.2)?"mine":e.biome==="grassland"&&n.chance(.2)?"farm":(e.biome==="forest"||e.biome==="dense_forest")&&n.chance(.15)?"lumber_camp":n.chance(.5)?"hamlet":"homestead"}function qt(e,t){const i=[],o=(n,s=1)=>{i.push({type:n,level:s,condition:80+t.nextInt(0,20),workerId:null,isOperational:!0})};switch(e){case"homestead":for(let n=0;n<t.nextInt(1,3);n++)o("house");o("farm_field");break;case"hamlet":for(let n=0;n<t.nextInt(6,10);n++)o("house");o("farm_field"),t.chance(.5)&&o("hunter_lodge");break;case"village":for(let n=0;n<t.nextInt(15,25);n++)o("house");for(let n=0;n<2;n++)o("farm_field");o("market"),o("tavern"),t.chance(.5)&&o("blacksmith"),t.chance(.4)&&o("church");break;case"town":for(let n=0;n<t.nextInt(30,50);n++)o("house");for(let n=0;n<3;n++)o("farm_field");o("market"),o("tavern"),o("blacksmith"),o("church"),o("barracks"),o("warehouse"),o("wall"),t.chance(.5)&&o("guild_hall"),t.chance(.5)&&o("bakery");break;case"city":for(let n=0;n<t.nextInt(60,100);n++)o("house");for(let n=0;n<2;n++)o("market");o("tavern"),o("blacksmith"),o("church"),o("barracks");for(let n=0;n<2;n++)o("warehouse");o("wall",2),o("guild_hall"),o("bakery"),t.chance(.6)&&o("apothecary"),t.chance(.5)&&o("weaponsmith"),t.chance(.5)&&o("armorer");break;case"castle":o("castle_keep",2),o("wall",3);for(let n=0;n<2;n++)o("barracks",2);for(let n=0;n<t.nextInt(15,30);n++)o("house");o("warehouse"),o("blacksmith"),o("weaponsmith"),o("armorer"),o("stable"),t.chance(.6)&&o("church"),t.chance(.4)&&o("tavern");break;case"farm":for(let n=0;n<t.nextInt(2,4);n++)o("house");for(let n=0;n<t.nextInt(2,4);n++)o("farm_field");break;case"mine":for(let n=0;n<t.nextInt(3,6);n++)o("house");o("mine_shaft"),t.chance(.4)&&o("smelter");break;case"lumber_camp":for(let n=0;n<t.nextInt(2,5);n++)o("house");o("sawmill");break;case"fishing_village":for(let n=0;n<t.nextInt(8,15);n++)o("house");o("dock"),t.chance(.4)&&o("tavern");break;case"port":for(let n=0;n<t.nextInt(25,40);n++)o("house");for(let n=0;n<t.nextInt(2,4);n++)o("dock");for(let n=0;n<2;n++)o("warehouse");o("market"),o("tavern"),o("blacksmith"),t.chance(.6)&&o("guild_hall"),t.chance(.5)&&o("church"),t.chance(.4)&&o("barracks");break;default:o("house");break}return i}function Ct(e,t,i,o){const n=new Map,s=[],a=[];for(let r=0;r<i;r++)for(let l=0;l<t;l++){const c=Dt(e[r][l],e,t,i);c>0&&a.push({x:l,y:r,score:c})}a.sort((r,l)=>l.score+o.next()*2-(r.score+o.next()*2));for(const r of a){if(n.size>=Lt)break;if(s.some(v=>K(v,r)<Tt))continue;const c=e[r.y][r.x],d=At(c,e,t,i,o);let f=d;const u=c.elevation>=6||c.biome==="hills"||c.biome==="mountains",h=d==="hamlet"||d==="homestead"||d==="farm"||d==="mine"||d==="lumber_camp";n.size<2&&h?u&&o.chance(.5)?f="castle":f="city":n.size<12&&h?u&&o.chance(.4)?f="castle":o.chance(.25)?f="city":f="town":n.size<25&&h?u&&o.chance(.3)?f="castle":o.chance(.35)?f="village":o.chance(.5)&&(f="town"):n.size<40&&(d==="hamlet"||d==="homestead")&&o.chance(.4)&&(f="village");const p=L("loc"),y=St(o),b=qt(f,o),m=b.filter(v=>v.type==="house").length,I={id:p,name:y,type:f,position:{x:r.x,y:r.y},size:m,populationCapacity:m*6,residentIds:[],buildings:b,productionSites:[],storage:Pt(f,o),storageCapacity:{none:200,dry:100,cold:30,secure:20},tradeRouteIds:[],marketPrices:{},defenseLevel:f==="castle"?5:f==="city"?4:f==="town"?3:f==="port"?2:f==="village"?1:0,wallLevel:f==="castle"?3:f==="city"?2:f==="town"||f==="port"?1:0,garrisonIds:[],ownerId:null,countryId:null,prosperity:50+o.nextInt(-10,10),safety:60+o.nextInt(-10,10),happiness:50+o.nextInt(-5,5),foundedTurn:0,isDestroyed:!1,growthPoints:0,durability:f==="castle"?120:f==="city"?100:f==="town"?80:f==="port"?70:f==="village"?60:40,originalType:null,burningTurns:0};n.set(p,I),c.locationId=p,s.push({x:r.x,y:r.y})}return n}function Pt(e,t){const i=[],o=(n,s)=>{i.push({resourceId:n,quantity:Math.round(s),quality:.7,age:0})};switch(e){case"city":o("bread",t.nextInt(40,60)),o("meat",t.nextInt(15,25)),o("wheat",t.nextInt(20,35)),o("ale",t.nextInt(15,25)),o("wood",t.nextInt(15,30)),o("stone",t.nextInt(10,20)),o("iron_ore",t.nextInt(5,15)),o("tools",t.nextInt(5,12)),o("fabric",t.nextInt(5,10)),o("weapons",t.nextInt(2,6)),o("armor",t.nextInt(1,3));break;case"town":o("bread",t.nextInt(25,40)),o("wheat",t.nextInt(15,25)),o("meat",t.nextInt(8,15)),o("ale",t.nextInt(8,15)),o("wood",t.nextInt(10,25)),o("stone",t.nextInt(5,15)),o("tools",t.nextInt(3,8)),o("fabric",t.nextInt(2,6)),t.chance(.4)&&o("weapons",t.nextInt(1,4));break;case"castle":o("bread",t.nextInt(30,50)),o("meat",t.nextInt(15,25)),o("ale",t.nextInt(10,20)),o("weapons",t.nextInt(5,10)),o("armor",t.nextInt(3,6)),o("stone",t.nextInt(10,20)),o("tools",t.nextInt(3,6));break;case"village":o("wheat",t.nextInt(15,25)),o("bread",t.nextInt(8,15)),o("wood",t.nextInt(8,15)),o("tools",t.nextInt(1,4));break;case"hamlet":case"homestead":o("wheat",t.nextInt(8,15)),o("wood",t.nextInt(3,10));break;case"farm":o("wheat",t.nextInt(20,40)),o("sheep",t.nextInt(3,8)),o("bread",t.nextInt(5,10));break;case"mine":o("iron_ore",t.nextInt(10,25)),o("coal",t.nextInt(8,15)),o("stone",t.nextInt(8,15)),o("bread",t.nextInt(5,10));break;case"lumber_camp":o("wood",t.nextInt(20,40)),o("wheat",t.nextInt(5,10));break;case"fishing_village":o("fish",t.nextInt(10,25)),o("wheat",t.nextInt(3,8));break;case"port":o("fish",t.nextInt(15,30)),o("bread",t.nextInt(10,15)),o("ale",t.nextInt(5,12)),o("tools",t.nextInt(2,5));break;default:o("wheat",t.nextInt(3,8));break}return i}class _t{data=[];get size(){return this.data.length}push(t){this.data.push(t),this.bubbleUp(this.data.length-1)}pop(){if(this.data.length===0)return;const t=this.data[0],i=this.data.pop();return this.data.length>0&&(this.data[0]=i,this.bubbleDown(0)),t}bubbleUp(t){for(;t>0;){const i=t-1>>1;if(this.data[t].cost>=this.data[i].cost)break;[this.data[t],this.data[i]]=[this.data[i],this.data[t]],t=i}}bubbleDown(t){const i=this.data.length;for(;;){let o=t;const n=2*t+1,s=2*t+2;if(n<i&&this.data[n].cost<this.data[o].cost&&(o=n),s<i&&this.data[s].cost<this.data[o].cost&&(o=s),o===t)break;[this.data[t],this.data[o]]=[this.data[o],this.data[t]],t=o}}}function ne(e){return`${e.x},${e.y}`}function ke(e,t,i,o,n){const s=new _t,a=new Map,r=new Map,l=new Map,c=ne(e);r.set(c,0),l.set(c,S(e,t)),s.push({pos:e,cost:l.get(c)});const d=new Set;for(;s.size>0;){const f=s.pop(),u=ne(f.pos);if(f.pos.x===t.x&&f.pos.y===t.y){const p=[];let y=t;for(;y;)p.unshift(y),y=a.get(ne(y));return p}if(d.has(u))continue;d.add(u);const h=tt(f.pos,i,o);for(const p of h){const y=ne(p);if(d.has(y))continue;const b=n(p.x,p.y,f.pos.x,f.pos.y);if(b>=1/0)continue;const m=(r.get(u)??1/0)+b,I=r.get(y)??1/0;if(m<I){a.set(y,f.pos),r.set(y,m);const v=m+S(p,t);l.set(y,v),s.push({pos:p,cost:v})}}}return[]}function he(e){const t=e.terrainType;if(t==="deep_ocean"||t==="shallow_ocean")return 1/0;const i=oe[e.biome];if(!i)return 5;let o=i.movementCost;return e.roadLevel>=3?o*=.35:e.roadLevel>=2?o*=.5:e.roadLevel>=1&&(o*=.7),o+=Math.max(0,(e.elevation-8)*.15),Math.max(.5,o)}function Ae(e){return Math.max(1,Math.ceil(he(e)))}function Et(e,t,i,o){const n=Array.from(t.values()).filter(m=>!m.isDestroyed&&m.type!=="dungeon"&&m.type!=="ruins"&&m.type!=="dragon_lair"&&m.type!=="bandit_camp");if(n.length<2)return;const s=new Map;n.forEach((m,I)=>s.set(m.id,I));const a=[],r=30;for(let m=0;m<n.length;m++)for(let I=m+1;I<n.length;I++){const v=K(n[m].position,n[I].position);if(v>r)continue;const w=qe(n[m].type)+qe(n[I].type);a.push({a:m,b:I,dist:v,importance:w})}a.sort((m,I)=>m.dist/m.importance-I.dist/I.importance);const l=n.map((m,I)=>I);function c(m){for(;l[m]!==m;)l[m]=l[l[m]],m=l[m];return m}function d(m,I){const v=c(m),w=c(I);return v===w?!1:(l[v]=w,!0)}const f=[];for(const m of a)if(d(m.a,m.b)&&(f.push(m),f.length===n.length-1))break;const u=new Set(["town","city","castle","port"]),h=new Set(f.map(m=>`${m.a}-${m.b}`)),p=[],y=Math.max(2,Math.floor(n.length/10));for(const m of a){if(p.length>=y)break;const I=`${m.a}-${m.b}`;h.has(I)||!u.has(n[m.a].type)||!u.has(n[m.b].type)||m.dist>20||(p.push(m),h.add(I))}const b=[...f,...p];for(const m of b){const I=n[m.a],v=n[m.b],w=ke(I.position,v.position,i,o,(M,T)=>he(e[T][M]));if(w.length===0)continue;const R=m.importance,k=R>=6?3:R>=4?2:1;for(const M of w)e[M.y][M.x].roadLevel=Math.max(e[M.y][M.x].roadLevel,k)}$t(e,i,o)}function $t(e,t,i){for(let o=1;o<i-1;o++)for(let n=1;n<t-1;n++){const s=e[o][n];if(s.roadLevel===0||s.roadLevel>=3)continue;const a=e[o][n-1].roadLevel>0||e[o][n+1].roadLevel>0,r=e[o-1][n].roadLevel>0||e[o+1][n].roadLevel>0;if(a)for(let l=1;l<=2;l++){if(o+l<i&&e[o+l][n].roadLevel>0&&(e[o+l][n-1]?.roadLevel>0||e[o+l][n+1]?.roadLevel>0)&&s.roadLevel<=e[o+l][n].roadLevel){s.roadLevel=0;break}if(o-l>=0&&e[o-l][n].roadLevel>0&&(e[o-l][n-1]?.roadLevel>0||e[o-l][n+1]?.roadLevel>0)&&s.roadLevel<e[o-l][n].roadLevel){s.roadLevel=0;break}}if(r&&s.roadLevel>0)for(let l=1;l<=2;l++){if(n+l<t&&e[o][n+l].roadLevel>0&&(e[o-1]?.[n+l]?.roadLevel>0||e[o+1]?.[n+l]?.roadLevel>0)&&s.roadLevel<=e[o][n+l].roadLevel){s.roadLevel=0;break}if(n-l>=0&&e[o][n-l].roadLevel>0&&(e[o-1]?.[n-l]?.roadLevel>0||e[o+1]?.[n-l]?.roadLevel>0)&&s.roadLevel<e[o][n-l].roadLevel){s.roadLevel=0;break}}}for(let o=1;o<i-1;o++)for(let n=1;n<t-1;n++){const s=e[o][n];if(s.roadLevel===0)continue;(e[o-1][n].roadLevel>0?1:0)+(e[o+1][n].roadLevel>0?1:0)+(e[o][n-1].roadLevel>0?1:0)+(e[o][n+1].roadLevel>0?1:0)===0&&(s.roadLevel=0)}}function qe(e){switch(e){case"city":return 5;case"town":return 4;case"castle":return 4;case"port":return 3;case"village":return 2;case"fishing_village":return 2;case"hamlet":return 1;case"mine":return 1;case"farm":return 1;case"lumber_camp":return 1;case"homestead":return 1;default:return 0}}const Ht=new Set(["fishing_village","port","town","city","castle"]),de=[{dx:1,dy:0},{dx:0,dy:-1},{dx:-1,dy:-1},{dx:-1,dy:0},{dx:0,dy:1},{dx:1,dy:1}];function Wt(e,t,i,o){for(const n of t.values()){if(n.isDestroyed||!(Ht.has(n.type)||Bt(e,n,i,o)))continue;const{x:a,y:r}=n.position,l=[];for(let c=-2;c<=2;c++)for(let d=-2;d<=2;d++){if(d===0&&c===0)continue;const f=a+d,u=r+c;if(f<0||f>=i||u<0||u>=o)continue;const h=e[u][f];if(!E(h.terrainType)||h.features.some(b=>b.type==="pier"))continue;let p=!1;for(const b of de){const m=f+b.dx,I=u+b.dy;if(m>=0&&m<i&&I>=0&&I<o&&!E(e[I][m].terrainType)){p=!0;break}}if(!p)continue;let y=0;for(const b of de){const m=f+b.dx,I=u+b.dy;m>=0&&m<i&&I>=0&&I<o&&E(e[I][m].terrainType)&&y++}if(y>=1){if(Ot(e,f,u,i,o)<10)continue;const m=Math.abs(d)+Math.abs(c);l.push({x:f,y:u,score:y*10-m})}}if(l.sort((c,d)=>d.score-c.score),l.length>0){const c=l[0];e[c.y][c.x].features.push({type:"pier",variant:0})}}}function Bt(e,t,i,o){const n=new Set,s=[t.position];let a=0;const r=200;for(;s.length>0&&a<r;){const l=s.shift(),c=`${l.x},${l.y}`;if(n.has(c))continue;n.add(c);const d=e[l.y]?.[l.x];if(!(!d||E(d.terrainType))){a++;for(const f of de){const u=l.x+f.dx,h=l.y+f.dy;u>=0&&u<i&&h>=0&&h<o&&s.push({x:u,y:h})}}}return a<r}function Ot(e,t,i,o,n){const s=new Set,a=[{x:t,y:i}];let r=0;const l=100;for(;a.length>0&&r<l;){const c=a.shift(),d=`${c.x},${c.y}`;if(s.has(d))continue;s.add(d);const f=e[c.y]?.[c.x];if(!(!f||!E(f.terrainType))){r++;for(const u of de){const h=c.x+u.dx,p=c.y+u.dy;if(h>=0&&h<o&&p>=0&&p<n){const y=`${h},${p}`;s.has(y)||a.push({x:h,y:p})}}}}return r}const Nt={homestead:[["farmer",5],["hunter",2],["unemployed",1]],hamlet:[["farmer",5],["hunter",2],["miner",1],["lumberjack",2],["unemployed",1]],village:[["farmer",4],["hunter",2],["blacksmith",1],["baker",1],["weaver",1],["merchant",1],["guard",1],["priest",.5],["unemployed",1]],town:[["farmer",3],["hunter",1],["blacksmith",2],["baker",1],["weaver",1],["brewer",1],["tanner",1],["merchant",2],["soldier",2],["guard",2],["scholar",.5],["priest",1],["herbalist",1],["unemployed",1]],city:[["farmer",2],["blacksmith",2],["baker",2],["weaver",2],["brewer",1],["tanner",1],["merchant",3],["soldier",3],["guard",3],["scholar",1],["priest",1],["herbalist",1],["noble",.5],["unemployed",1]],mine:[["miner",5],["farmer",1],["unemployed",1]],farm:[["farmer",6],["unemployed",1]],lumber_camp:[["lumberjack",5],["farmer",1],["unemployed",1]],fishing_village:[["fisher",5],["farmer",1],["merchant",1],["unemployed",1]],port:[["fisher",3],["merchant",3],["soldier",1],["guard",2],["baker",1],["unemployed",1]],castle:[["soldier",4],["guard",3],["noble",1],["unemployed",2],["blacksmith",1]]},zt={homestead:[4,8],hamlet:[15,30],village:[40,80],town:[100,200],city:[200,400],mine:[10,25],farm:[6,15],lumber_camp:[8,20],fishing_village:[20,40],port:[60,120],castle:[40,100]};function J(e,t,i,o="unemployed"){const n=e.chance(.5)?"male":"female",s=ce(e,n),a=Ft(e,o),r=Yt(e,o),l=jt(e);return{id:L("ch"),name:s,age:a,gender:n,position:{...t},homeLocationId:i,jobType:o,health:50+r.endurance*5,maxHealth:50+r.endurance*5,stats:r,needs:{food:70+e.nextInt(-10,10),shelter:i?80:30,safety:60+e.nextInt(-10,10),social:50+e.nextInt(-10,10),purpose:o!=="unemployed"?60:30},personality:l,relationships:[],skills:Xt(e,o),inventory:[],gold:e.nextInt(0,20),equippedWeapon:null,equippedArmor:null,isAlive:!0,currentAction:null,destination:null,turnsUntilArrival:0,onDuty:!1,dutyWanderRadius:0,turnsOnDuty:0,title:null,lordId:null,vassalIds:[],ownedLocationIds:[],knownLocationIds:i?[i]:[],flags:{},herdedCreatureIds:[]}}function Ft(e,t){return t==="child"?e.nextInt(0,14):t==="elder"?e.nextInt(55,75):t==="noble"?e.nextInt(25,55):t==="soldier"||t==="guard"?e.nextInt(18,40):t==="scholar"||t==="priest"?e.nextInt(25,60):e.nextInt(16,50)}function Yt(e,t){const i=()=>e.nextInt(3,8),o={strength:i(),dexterity:i(),intelligence:i(),charisma:i(),endurance:i()};switch(t){case"farmer":o.strength+=2,o.endurance+=2;break;case"miner":o.strength+=3,o.endurance+=2;break;case"shepherd":o.endurance+=2,o.charisma+=1;break;case"blacksmith":o.strength+=3,o.dexterity+=1;break;case"soldier":o.strength+=2,o.dexterity+=2,o.endurance+=2;break;case"hunter":o.dexterity+=3,o.endurance+=1;break;case"merchant":o.charisma+=3,o.intelligence+=1;break;case"scholar":o.intelligence+=4;break;case"noble":o.charisma+=2,o.intelligence+=2;break;case"adventurer":o.strength+=1,o.dexterity+=1,o.endurance+=1,o.charisma+=1;break}return o}function jt(e){return{ambition:e.next(),courage:e.next(),greed:e.next(),loyalty:e.next(),kindness:e.next(),curiosity:e.next()}}function Xt(e,t){const i={};switch(i.combat=e.nextInt(1,15),i.survival=e.nextInt(5,20),t){case"farmer":i.farming=e.nextInt(20,60),i.cooking=e.nextInt(10,30);break;case"miner":i.mining=e.nextInt(20,60);break;case"lumberjack":i.woodworking=e.nextInt(20,60);break;case"fisher":i.fishing=e.nextInt(20,60);break;case"blacksmith":i.blacksmithing=e.nextInt(25,65),i.smelting=e.nextInt(15,40);break;case"weaver":i.weaving=e.nextInt(25,60);break;case"baker":i.cooking=e.nextInt(25,60);break;case"brewer":i.brewing=e.nextInt(25,60);break;case"tanner":i.leatherworking=e.nextInt(25,60);break;case"merchant":i.trading=e.nextInt(25,65),i.persuasion=e.nextInt(15,40);break;case"soldier":case"guard":i.combat=e.nextInt(30,70),i.tactics=e.nextInt(10,30);break;case"hunter":i.hunting=e.nextInt(25,60),i.combat=e.nextInt(15,40),i.survival=e.nextInt(20,50);break;case"herbalist":i.herbalism=e.nextInt(25,60);break;case"scholar":i.lore=e.nextInt(30,70);break;case"priest":i.healing=e.nextInt(20,50),i.persuasion=e.nextInt(15,40);break;case"noble":i.tactics=e.nextInt(15,40),i.persuasion=e.nextInt(20,50),i.trading=e.nextInt(10,30);break;case"adventurer":i.combat=e.nextInt(20,50),i.survival=e.nextInt(20,50),i.lore=e.nextInt(10,30);break}return i}function Gt(e,t){const i=new Map;for(const o of e.values()){if(o.isDestroyed)continue;const n=zt[o.type]??[2,6],s=t.nextInt(n[0],n[1]),a=Nt[o.type]??[["farmer",3],["unemployed",2]];let r=0;for(;r<s;){const c=Math.min(t.nextInt(1,4),s-r),d=t.weightedPick(a),f=J(t,o.position,o.id,d);if(f.age=t.nextInt(25,50),f.gold=t.nextInt(5,40),i.set(f.id,f),o.residentIds.push(f.id),r++,c>=2){const u=f.gender==="male"?"female":"male",h=t.weightedPick(a),p=J(t,o.position,o.id,h);p.gender=u,p.name=ce(t,u),p.age=f.age+t.nextInt(-5,5),i.set(p.id,p),o.residentIds.push(p.id),r++,f.relationships.push({targetId:p.id,type:"spouse",strength:60+t.nextInt(0,30)}),p.relationships.push({targetId:f.id,type:"spouse",strength:60+t.nextInt(0,30)});for(let y=2;y<c&&r<s;y++){const b=t.nextInt(1,Math.max(1,f.age-18)),m=t.chance(.5)?"male":"female",I=b<15?"child":t.weightedPick(a),v=J(t,o.position,o.id,I);v.gender=m,v.name=ce(t,m),v.age=b,i.set(v.id,v),o.residentIds.push(v.id),r++,f.relationships.push({targetId:v.id,type:"child",strength:70+t.nextInt(0,20)}),v.relationships.push({targetId:f.id,type:"parent",strength:60+t.nextInt(0,30)}),p.relationships.push({targetId:v.id,type:"child",strength:70+t.nextInt(0,20)}),v.relationships.push({targetId:p.id,type:"parent",strength:60+t.nextInt(0,30)})}}}Vt(o,i);const l=[...o.residentIds];for(let c=0;c<Math.min(5,l.length);c++){const d=i.get(t.pick(l)),f=i.get(t.pick(l));d&&f&&d.id!==f.id&&(d.relationships.find(h=>h.targetId===f.id)||(t.chance(.7)?(d.relationships.push({targetId:f.id,type:"friend",strength:t.nextInt(20,60)}),f.relationships.push({targetId:d.id,type:"friend",strength:t.nextInt(20,60)})):(d.relationships.push({targetId:f.id,type:"rival",strength:t.nextInt(-40,-10)}),f.relationships.push({targetId:d.id,type:"rival",strength:t.nextInt(-40,-10)}))))}}return i}function Vt(e,t,i){const o={farm_field:["farmer"],mine_shaft:["miner"],sawmill:["lumberjack"],blacksmith:["blacksmith"],weaponsmith:["blacksmith","soldier"],armorer:["blacksmith"],bakery:["baker"],brewery:["brewer"],weaver:["weaver"],tanner:["tanner"],dock:["fisher"],apothecary:["herbalist"],hunter_lodge:["hunter"],barracks:["soldier"],church:["priest"],market:["merchant"]};for(const n of e.buildings){if(n.workerId)continue;const s=o[n.type];if(s)for(const a of e.residentIds){const r=t.get(a);if(r&&s.includes(r.jobType)&&!Ut(r.id,e)){n.workerId=r.id;break}}}}function Ut(e,t){return t.buildings.some(i=>i.workerId===e)}const j={wolf:{type:"wolf",name:"Wolf",baseHealth:25,baseAttack:8,baseDefense:3,baseSpeed:4,defaultBehavior:"hunting",hostile:!0,wanderRadius:8,preferredBiomes:["forest","dense_forest","hills","tundra"],packSize:[3,7],lootTable:[{resourceId:"hides",chance:.8,quantity:[1,2]},{resourceId:"meat",chance:.6,quantity:[1,2]}],description:"Cunning pack hunters that roam forests and hills."},bear:{type:"bear",name:"Bear",baseHealth:60,baseAttack:14,baseDefense:6,baseSpeed:2,defaultBehavior:"territorial",hostile:!1,wanderRadius:5,preferredBiomes:["forest","dense_forest","hills","mountain"],packSize:[1,2],lootTable:[{resourceId:"hides",chance:.9,quantity:[2,4]},{resourceId:"meat",chance:.8,quantity:[3,5]}],description:"Powerful solitary predator — territorial but avoids conflict."},deer:{type:"deer",name:"Deer",baseHealth:15,baseAttack:2,baseDefense:1,baseSpeed:5,defaultBehavior:"passive",hostile:!1,wanderRadius:10,preferredBiomes:["forest","grassland","hills"],packSize:[3,8],lootTable:[{resourceId:"meat",chance:1,quantity:[2,3]},{resourceId:"hides",chance:.9,quantity:[1,2]}],description:"Graceful woodland creatures — a valuable game animal."},sheep:{type:"sheep",name:"Wild Sheep",baseHealth:10,baseAttack:1,baseDefense:1,baseSpeed:3,defaultBehavior:"passive",hostile:!1,wanderRadius:6,preferredBiomes:["grassland","hills","savanna"],packSize:[5,15],lootTable:[{resourceId:"wool",chance:1,quantity:[1,3]},{resourceId:"meat",chance:.5,quantity:[1,1]}],description:"Docile grazers valued for wool and meat."},boar:{type:"boar",name:"Wild Boar",baseHealth:35,baseAttack:10,baseDefense:5,baseSpeed:3,defaultBehavior:"territorial",hostile:!1,wanderRadius:6,preferredBiomes:["forest","dense_forest","swamp"],packSize:[2,5],lootTable:[{resourceId:"meat",chance:.9,quantity:[2,4]},{resourceId:"hides",chance:.7,quantity:[1,2]}],description:"Aggressive when provoked — a dangerous quarry."},dragon:{type:"dragon",name:"Dragon",baseHealth:500,baseAttack:50,baseDefense:30,baseSpeed:6,defaultBehavior:"territorial",hostile:!0,wanderRadius:20,preferredBiomes:["mountain","snow_mountain"],packSize:[1,1],lootTable:[{resourceId:"gold_ore",chance:1,quantity:[10,30]},{resourceId:"rare_herbs",chance:.5,quantity:[3,8]}],description:"Ancient and terrifying — the apex predator of legends."},bandit:{type:"bandit",name:"Bandits",baseHealth:30,baseAttack:10,baseDefense:5,baseSpeed:3,defaultBehavior:"raiding",hostile:!0,wanderRadius:12,preferredBiomes:["forest","hills","dense_forest"],packSize:[3,10],lootTable:[{resourceId:"weapons",chance:.3,quantity:[1,1]},{resourceId:"armor",chance:.1,quantity:[1,1]}],description:"Outlaws who prey on travelers and trade routes."},guard:{type:"guard",name:"Guard Patrol",baseHealth:40,baseAttack:12,baseDefense:8,baseSpeed:3,defaultBehavior:"patrolling",hostile:!1,wanderRadius:6,preferredBiomes:[],packSize:[2,5],lootTable:[],description:"Armed guards patrolling the roads near their settlement."},army:{type:"army",name:"Army",baseHealth:120,baseAttack:20,baseDefense:12,baseSpeed:2,defaultBehavior:"marching",hostile:!1,wanderRadius:60,preferredBiomes:[],packSize:[10,30],lootTable:[{resourceId:"weapons",chance:.5,quantity:[2,5]},{resourceId:"armor",chance:.3,quantity:[1,3]}],description:"An organized military force marching to war."},trader:{type:"trader",name:"Trade Caravan",baseHealth:20,baseAttack:3,baseDefense:2,baseSpeed:2,defaultBehavior:"trading",hostile:!1,wanderRadius:40,preferredBiomes:[],packSize:[1,3],lootTable:[],description:"A merchant caravan hauling goods between settlements."},hunter:{type:"hunter",name:"Hunter",baseHealth:30,baseAttack:8,baseDefense:3,baseSpeed:3,defaultBehavior:"hunting",hostile:!1,wanderRadius:15,preferredBiomes:[],packSize:[1,2],lootTable:[],description:"A skilled hunter tracking wild game for their settlement."},builder:{type:"builder",name:"Builder",baseHealth:25,baseAttack:4,baseDefense:2,baseSpeed:2,defaultBehavior:"patrolling",hostile:!1,wanderRadius:30,preferredBiomes:[],packSize:[1,3],lootTable:[],description:"A team of builders sent to rebuild destroyed settlements."}},Ce=150,Qt=5;function Kt(e,t,i,o){const n=new Map,s=[],a={};for(const[f,u]of Object.entries(j))for(const h of u.preferredBiomes)a[h]||(a[h]=[]),a[h].push(f);let r=0;const l=Ce*10;for(;s.length<Ce&&r<l;){r++;const f=o.nextInt(0,t-1),u=o.nextInt(0,i-1),h=e[u][f];if(E(h.terrainType)||h.locationId||s.some(R=>Math.abs(R.x-f)+Math.abs(R.y-u)<Qt))continue;const y=a[h.biome]||[];if(y.length===0)continue;const b=o.pick(y),m=j[b];if(b==="dragon"&&(Array.from(n.values()).filter(k=>k.type==="dragon").length>=3||!o.chance(.15))||b==="bandit"&&(Array.from(n.values()).filter(k=>k.type==="bandit").length>=8||!o.chance(.3)))continue;const I=o.nextInt(m.packSize[0],m.packSize[1]),v=L("creature"),w={id:v,type:b,name:b==="dragon"?De(o):null,position:{x:f,y:u},health:m.baseHealth*I,maxHealth:m.baseHealth*I,attack:m.baseAttack*Math.sqrt(I),defense:m.baseDefense*Math.sqrt(I),speed:m.baseSpeed,behavior:m.defaultBehavior,homePosition:{x:f,y:u},wanderRadius:m.wanderRadius,isHostile:m.hostile,loot:[],age:0,lastActionTurn:0,countryId:null,targetLocationId:null,homeLocationId:null};for(const R of m.lootTable)o.chance(R.chance)&&w.loot.push({resourceId:R.resourceId,quantity:o.nextInt(R.quantity[0],R.quantity[1]),quality:.5+o.next()*.5,age:0});n.set(v,w),s.push({x:f,y:u})}const c=Array.from(n.values()).filter(f=>f.type==="dragon").length,d=Math.max(0,2-c);if(d>0){const f=j.dragon;let u=0;for(let h=0;h<500&&u<d;h++){const p=o.nextInt(0,t-1),y=o.nextInt(0,i-1),b=e[y][p];if(E(b.terrainType)||b.locationId||b.biome!=="mountain"&&b.biome!=="snow_mountain"&&b.biome!=="hills")continue;const m=L("creature"),I={id:m,type:"dragon",name:De(o),position:{x:p,y},health:f.baseHealth,maxHealth:f.baseHealth,attack:f.baseAttack,defense:f.baseDefense,speed:f.baseSpeed,behavior:"territorial",homePosition:{x:p,y},wanderRadius:20,isHostile:!0,loot:[{resourceId:"gold_ore",quantity:o.nextInt(10,30),quality:.8,age:0}],age:0,lastActionTurn:0,countryId:null,targetLocationId:null,homeLocationId:null};n.set(m,I),s.push({x:p,y}),u++}}return n}const pe=["#c44444","#4444c4","#44c444","#c4c444","#c444c4","#44c4c4","#c48844","#8844c4","#44c488","#c44488"];function Zt(e,t,i){const o=new Map,n=[],s=Array.from(e.values()).filter(c=>!c.isDestroyed&&Jt(c.type)).sort((c,d)=>Pe(d.type)-Pe(c.type)),a=Math.min(Math.max(2,Math.floor(s.length/8)),pe.length),r=s.slice(0,a);for(let c=0;c<r.length;c++){const d=r[c],f=L("country"),u=Mt(i),h=xt(d,t,i),p={id:f,name:u,color:pe[c%pe.length],leaderId:h.id,capitalLocationId:d.id,locationIds:[d.id],alliances:[],enemies:[],vassalIds:[],treasury:i.nextInt(200,800),taxRate:i.nextFloat(.05,.2),militaryStrength:0,reputation:i.nextInt(-10,30),foundedTurn:0};o.set(f,p),d.countryId=f,d.ownerId=h.id,h.ownedLocationIds.push(d.id),h.title="King"}const l=Array.from(o.values());for(const c of s){if(c.countryId)continue;let d=null,f=1/0;for(const u of l){const h=e.get(u.capitalLocationId);if(!h)continue;const p=K(c.position,h.position);p<f&&(f=p,d=u)}if(d&&f<50){c.countryId=d.id,d.locationIds.push(c.id);const u=ei(c,t,i);if(u){u.lordId=d.leaderId,u.title=c.type==="town"?"Baron":"Lord",d.vassalIds.push(u.id),c.ownerId=u.id,u.ownedLocationIds.push(c.id);const h=t.get(d.leaderId);h&&(u.relationships.push({targetId:h.id,type:"lord",strength:50+i.nextInt(-20,20)}),h.relationships.push({targetId:u.id,type:"vassal",strength:30+i.nextInt(-20,20)}))}}}for(let c=0;c<l.length;c++)for(let d=c+1;d<l.length;d++){const f=e.get(l[c].capitalLocationId),u=e.get(l[d].capitalLocationId);if(!f||!u)continue;const h=K(f.position,u.position);let p="neutral",y=0;h<30&&(i.chance(.3)?(p="alliance",y=i.nextInt(20,60),l[c].alliances.push(l[d].id),l[d].alliances.push(l[c].id)):i.chance(.3)?(p="rivalry",y=i.nextInt(-60,-20),l[c].enemies.push(l[d].id),l[d].enemies.push(l[c].id)):(p="trade_agreement",y=i.nextInt(5,30))),n.push({countryAId:l[c].id,countryBId:l[d].id,type:p,strength:y,startedTurn:0})}for(const c of l)c.militaryStrength=ti(c,e);return{countries:o,diplomacy:n}}function Jt(e){return["homestead","hamlet","village","town","city","castle","farm","mine","lumber_camp","fishing_village","port"].includes(e)}function Pe(e){return{city:10,town:8,castle:7,port:6,village:4,hamlet:2,homestead:1,mine:2,farm:1,lumber_camp:1,fishing_village:2}[e]??0}function xt(e,t,i){for(const n of e.residentIds){const s=t.get(n);if(s&&s.jobType==="noble")return s}if(e.residentIds.length>0){const n=t.get(e.residentIds[0]);if(n)return n.jobType="noble",n.title="King",n.personality.ambition=Math.max(n.personality.ambition,.7),n}const o=Ye(e,i);return t.set(o.id,o),e.residentIds.push(o.id),o}function ei(e,t,i){for(const o of e.residentIds){const n=t.get(o);if(n&&n.personality.ambition>.5&&n.age>=20)return n.jobType="noble",n}if(e.residentIds.length>=3){const o=Ye(e,i);return t.set(o.id,o),e.residentIds.push(o.id),o}return null}function Ye(e,t){const i=t.chance(.5)?"male":"female";return{id:L("ch"),name:ce(t,i),age:t.nextInt(25,55),gender:i,position:{...e.position},homeLocationId:e.id,jobType:"noble",health:80,maxHealth:80,stats:{strength:t.nextInt(4,8),dexterity:t.nextInt(4,7),intelligence:t.nextInt(5,9),charisma:t.nextInt(6,10),endurance:t.nextInt(4,7)},needs:{food:80,shelter:90,safety:70,social:60,purpose:70},personality:{ambition:t.nextFloat(.6,1),courage:t.next(),greed:t.nextFloat(.3,.8),loyalty:t.next(),kindness:t.next(),curiosity:t.next()},relationships:[],skills:{tactics:t.nextInt(15,40),persuasion:t.nextInt(20,50),trading:t.nextInt(10,30),combat:t.nextInt(10,25)},inventory:[],gold:t.nextInt(50,300),equippedWeapon:null,equippedArmor:null,isAlive:!0,currentAction:null,destination:null,turnsUntilArrival:0,onDuty:!1,dutyWanderRadius:0,turnsOnDuty:0,title:null,lordId:null,vassalIds:[],ownedLocationIds:[],knownLocationIds:[e.id],flags:{},herdedCreatureIds:[]}}function ti(e,t,i){let o=0;for(const n of e.locationIds){const s=t.get(n);s&&(o+=s.defenseLevel*10,o+=s.garrisonIds.length*5,o+=s.wallLevel*20)}return o}const je={width:256,height:256,seed:Date.now()};function ii(e=je,t){const{width:i,height:o,seed:n}=e,s=new x(n);t?.("Shaping continents...",.05);const a=at(i,o,s.fork());t?.("Classifying terrain...",.15);const r=[];for(let m=0;m<o;m++){r[m]=[];for(let I=0;I<i;I++)r[m][I]=nt(a[m][I])}for(let m=0;m<o;m++)for(let I=0;I<i;I++)r[m][I]==="lowland"&&a[m][I]>=4&&a[m][I]<=5&&st(I,m,r,i,o)&&(r[m][I]="coast");t?.("Simulating climate...",.25);const l=lt(i,o,a,s.fork()),c=rt(i,o,a,r,s.fork());t?.("Growing biomes...",.35);const d=dt(i,o,a,c,l,r),f=[];for(let m=0;m<o;m++){f[m]=[];for(let I=0;I<i;I++){const v=oe[d[m][I]],w=r[m][I];let R=a[m][I];(w==="deep_ocean"||w==="shallow_ocean"||w==="coast")&&(R=4),f[m][I]={x:I,y:m,elevation:R,moisture:c[m][I],temperature:l[m][I],terrainType:w,biome:d[m][I],vegetation:(v?.vegetationDensity??0)*(.7+s.next()*.3),features:[],resourceDeposit:null,locationId:null,roadLevel:0,explored:!1,visible:!1,riverFlow:0}}}t?.("Scattering resources...",.45),ht(f,i,o,s.fork()),t?.("Founding settlements...",.55);const u=Ct(f,i,o,s.fork());t?.("Building roads and piers...",.65),Et(f,u,i,o),Wt(f,u,i,o),t?.("Populating the world...",.75);const h=Gt(u,s.fork());t?.("Spawning creatures...",.82);const p=Kt(f,i,o,s.fork());t?.("Establishing kingdoms...",.9);const{countries:y,diplomacy:b}=Zt(u,h,s.fork());return t?.("World complete!",1),{width:i,height:o,seed:n,tiles:f,locations:u,characters:h,creatures:p,countries:y,tradeRoutes:new Map,items:new Map,diplomacy:b,bloodSplashes:[]}}const ge=90,oi=["spring","summer","autumn","winter"];function ni(e){const t=e%(ge*4),i=Math.floor(t/ge);return oi[i]}function si(e){return Math.floor(e/(ge*4))+1}const ai={spring:{clear:.3,cloudy:.25,rain:.3,storm:.1,snow:0,fog:.05,heatwave:0,blizzard:0},summer:{clear:.45,cloudy:.2,rain:.15,storm:.1,snow:0,fog:0,heatwave:.1,blizzard:0},autumn:{clear:.25,cloudy:.3,rain:.25,storm:.05,snow:.05,fog:.1,heatwave:0,blizzard:0},winter:{clear:.2,cloudy:.2,rain:.1,storm:.05,snow:.3,fog:.05,heatwave:0,blizzard:.1}},li=[{id:"saw_lumber",name:"Saw Lumber",buildingType:"sawmill",inputs:[{resourceId:"wood",quantity:3}],outputs:[{resourceId:"lumber",quantity:2,baseQuality:.7}],duration:2,skillRequired:"woodworking",minimumSkillLevel:5,description:"Mill raw wood into usable lumber planks."},{id:"smelt_iron",name:"Smelt Iron",buildingType:"smelter",inputs:[{resourceId:"iron_ore",quantity:2},{resourceId:"coal",quantity:1}],outputs:[{resourceId:"iron_ingot",quantity:1,baseQuality:.6}],duration:3,skillRequired:"smelting",minimumSkillLevel:10,description:"Smelt iron ore into ingots."},{id:"smelt_gold",name:"Smelt Gold",buildingType:"smelter",inputs:[{resourceId:"gold_ore",quantity:2},{resourceId:"coal",quantity:1}],outputs:[{resourceId:"gold_ingot",quantity:1,baseQuality:.7}],duration:4,skillRequired:"smelting",minimumSkillLevel:20,description:"Smelt gold ore into precious ingots."},{id:"bake_bread",name:"Bake Bread",buildingType:"bakery",inputs:[{resourceId:"wheat",quantity:3}],outputs:[{resourceId:"bread",quantity:4,baseQuality:.7}],duration:1,skillRequired:"cooking",minimumSkillLevel:5,description:"Bake nutritious bread from wheat."},{id:"weave_fabric",name:"Weave Fabric",buildingType:"weaver",inputs:[{resourceId:"wool",quantity:3}],outputs:[{resourceId:"fabric",quantity:2,baseQuality:.6}],duration:3,skillRequired:"weaving",minimumSkillLevel:10,description:"Weave wool into usable fabric."},{id:"tan_leather",name:"Tan Leather",buildingType:"tanner",inputs:[{resourceId:"hides",quantity:2}],outputs:[{resourceId:"leather",quantity:2,baseQuality:.6}],duration:3,skillRequired:"leatherworking",minimumSkillLevel:10,description:"Tan raw hides into leather."},{id:"forge_tools",name:"Forge Tools",buildingType:"blacksmith",inputs:[{resourceId:"iron_ingot",quantity:1},{resourceId:"wood",quantity:1}],outputs:[{resourceId:"tools",quantity:2,baseQuality:.6}],duration:2,skillRequired:"blacksmithing",minimumSkillLevel:15,description:"Forge iron and wood into useful tools."},{id:"forge_weapons",name:"Forge Weapons",buildingType:"weaponsmith",inputs:[{resourceId:"iron_ingot",quantity:2},{resourceId:"leather",quantity:1}],outputs:[{resourceId:"weapons",quantity:1,baseQuality:.5}],duration:4,skillRequired:"weaponsmithing",minimumSkillLevel:20,description:"Forge deadly iron weapons."},{id:"craft_armor",name:"Craft Armor",buildingType:"armorer",inputs:[{resourceId:"iron_ingot",quantity:3},{resourceId:"leather",quantity:2}],outputs:[{resourceId:"armor",quantity:1,baseQuality:.5}],duration:5,skillRequired:"armoring",minimumSkillLevel:25,description:"Craft protective armor from iron and leather."},{id:"brew_ale",name:"Brew Ale",buildingType:"brewery",inputs:[{resourceId:"wheat",quantity:3},{resourceId:"herbs",quantity:1}],outputs:[{resourceId:"ale",quantity:3,baseQuality:.6}],duration:3,skillRequired:"brewing",minimumSkillLevel:10,description:"Brew hearty ale from wheat and herbs."},{id:"make_medicine",name:"Make Medicine",buildingType:"apothecary",inputs:[{resourceId:"herbs",quantity:2}],outputs:[{resourceId:"medicine",quantity:1,baseQuality:.5}],duration:2,skillRequired:"herbalism",minimumSkillLevel:15,description:"Prepare medicinal remedies."},{id:"shear_sheep",name:"Shear Sheep",buildingType:"farm_field",inputs:[{resourceId:"sheep",quantity:1}],outputs:[{resourceId:"wool",quantity:3,baseQuality:.7},{resourceId:"meat",quantity:1,baseQuality:.7}],duration:2,skillRequired:"farming",minimumSkillLevel:5,description:"Shear wool from sheep."},{id:"butcher_deer",name:"Process Deer",buildingType:"hunter_lodge",inputs:[{resourceId:"deer",quantity:1}],outputs:[{resourceId:"meat",quantity:3,baseQuality:.7},{resourceId:"hides",quantity:2,baseQuality:.7}],duration:1,skillRequired:"hunting",minimumSkillLevel:5,description:"Butcher deer for meat and hides."},{id:"farm_wheat",name:"Farm Wheat",buildingType:"farm_field",inputs:[],outputs:[{resourceId:"wheat",quantity:4,baseQuality:.7}],duration:5,skillRequired:"farming",minimumSkillLevel:0,description:"Grow and harvest wheat."},{id:"mine_iron",name:"Mine Iron Ore",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"iron_ore",quantity:2,baseQuality:.6}],duration:3,skillRequired:"mining",minimumSkillLevel:5,description:"Extract iron ore from the earth."},{id:"mine_gold",name:"Mine Gold Ore",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"gold_ore",quantity:1,baseQuality:.5}],duration:4,skillRequired:"mining",minimumSkillLevel:15,description:"Extract precious gold ore."},{id:"mine_coal",name:"Mine Coal",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"coal",quantity:3,baseQuality:.8}],duration:2,skillRequired:"mining",minimumSkillLevel:0,description:"Extract coal from the mines."},{id:"quarry_stone",name:"Quarry Stone",buildingType:"mine_shaft",inputs:[],outputs:[{resourceId:"stone",quantity:3,baseQuality:.8}],duration:2,skillRequired:"mining",minimumSkillLevel:0,description:"Quarry stone blocks."},{id:"catch_fish",name:"Catch Fish",buildingType:"dock",inputs:[],outputs:[{resourceId:"fish",quantity:4,baseQuality:.8}],duration:1,skillRequired:"fishing",minimumSkillLevel:0,description:"Catch fresh fish."},{id:"chop_wood",name:"Chop Wood",buildingType:"hunter_lodge",inputs:[],outputs:[{resourceId:"wood",quantity:3,baseQuality:.8}],duration:2,skillRequired:"woodworking",minimumSkillLevel:0,description:"Fell trees and collect wood."},{id:"gather_herbs",name:"Gather Herbs",buildingType:"apothecary",inputs:[],outputs:[{resourceId:"herbs",quantity:2,baseQuality:.6}],duration:2,skillRequired:"herbalism",minimumSkillLevel:0,description:"Gather medicinal herbs from the wild."},{id:"hunt_deer",name:"Hunt Deer",buildingType:"hunter_lodge",inputs:[],outputs:[{resourceId:"meat",quantity:3,baseQuality:.7},{resourceId:"hides",quantity:1,baseQuality:.6}],duration:3,skillRequired:"hunting",minimumSkillLevel:0,description:"Track and hunt wild deer for meat and hides."},{id:"hunt_boar",name:"Hunt Boar",buildingType:"hunter_lodge",inputs:[],outputs:[{resourceId:"meat",quantity:4,baseQuality:.6},{resourceId:"hides",quantity:1,baseQuality:.5}],duration:2,skillRequired:"hunting",minimumSkillLevel:0,description:"Hunt wild boar for meat and hides."},{id:"hunt_sheep",name:"Hunt Sheep",buildingType:"hunter_lodge",inputs:[],outputs:[{resourceId:"meat",quantity:2,baseQuality:.6},{resourceId:"wool",quantity:1,baseQuality:.5}],duration:1,skillRequired:"hunting",minimumSkillLevel:0,description:"Hunt wild sheep for meat and wool."}];function ri(e){return li.filter(t=>t.buildingType===e)}function ci(e,t,i){const o=[];for(const n of e.locations.values()){if(n.isDestroyed)continue;const s=di(n,e,t,i);o.push(...s),yi(n,e),gi(n),bi(n,e),Ii(n),wi(n)}return o}function di(e,t,i,o){const n=[],s=t.tiles[e.position.y]?.[e.position.x],a=s?oe[s.biome]:null,r=i==="winter"?a?.seasonalEffects.winter.productionMultiplier??.5:a?.seasonalEffects.summer.productionMultiplier??1;for(const l of e.buildings){if(!l.isOperational||!l.workerId)continue;const c=ri(l.type);if(c.length!==0)for(const d of c){const f=t.characters.get(l.workerId);if(!f||!f.isAlive)continue;const u=f.skills[d.skillRequired]??0;if(u<d.minimumSkillLevel||!fi(e,d))continue;let h=e.productionSites.find(y=>y.buildingType===l.type&&y.recipeId===d.id);h||(h={buildingType:l.type,recipeId:d.id,workerId:l.workerId,progress:0,efficiency:.5,isActive:!0},e.productionSites.push(h));const p=Math.min(u/100,.5);h.efficiency=(.5+p)*r,h.progress+=h.efficiency*(100/d.duration),h.progress>=100&&(ui(e,d),hi(e,d,u,o),h.progress=0,f.skills[d.skillRequired]!==void 0&&(f.skills[d.skillRequired]=Math.min(100,(f.skills[d.skillRequired]??0)+o.nextFloat(.1,.5))),n.push(`${e.name}: Produced ${d.outputs.map(y=>y.quantity+" "+y.resourceId).join(", ")}`));break}}return n}function fi(e,t){for(const i of t.inputs)if(e.storage.filter(n=>n.resourceId===i.resourceId).reduce((n,s)=>n+s.quantity,0)<i.quantity)return!1;return!0}function ui(e,t){for(const i of t.inputs){let o=i.quantity;for(let n=e.storage.length-1;n>=0&&o>0;n--)if(e.storage[n].resourceId===i.resourceId){const s=Math.min(o,e.storage[n].quantity);e.storage[n].quantity-=s,o-=s,e.storage[n].quantity<=0&&e.storage.splice(n,1)}}}function hi(e,t,i,o){for(const n of t.outputs){const s=i/200,a=Math.min(1,n.baseQuality+s+o.nextFloat(-.1,.1));ee(e,n.resourceId,n.quantity,a)}}function ee(e,t,i,o=.7){const n=B[t];if(!n)return;const s=e.storage.filter(d=>B[d.resourceId]?.storageRequirement===n.storageRequirement).reduce((d,f)=>d+f.quantity,0),a=e.storageCapacity[n.storageRequirement]??0,r=Math.max(0,a-s),l=Math.min(i,r);if(l<=0)return;const c=e.storage.find(d=>d.resourceId===t&&d.quantity<n.stackSize);if(c){const d=Math.min(l,n.stackSize-c.quantity);c.quantity=Math.round(c.quantity+d),c.quality=Math.round((c.quality+o)/2*100)/100,d<l&&e.storage.push({resourceId:t,quantity:Math.round(l-d),quality:o,age:0})}else e.storage.push({resourceId:t,quantity:l,quality:o,age:0})}const pi={city:.5,town:.4,castle:.4,port:.35,village:.3,hamlet:.25,homestead:.2,farm:.15,fishing_village:.2,mine:.3,lumber_camp:.25},mi={city:[{resourceId:"tools",rate:.1},{resourceId:"fabric",rate:.05},{resourceId:"ale",rate:.1},{resourceId:"wood",rate:.15},{resourceId:"stone",rate:.12},{resourceId:"lumber",rate:.1},{resourceId:"iron_ingot",rate:.05}],town:[{resourceId:"tools",rate:.05},{resourceId:"ale",rate:.05},{resourceId:"wood",rate:.1},{resourceId:"stone",rate:.08},{resourceId:"lumber",rate:.05}],castle:[{resourceId:"weapons",rate:.03},{resourceId:"armor",rate:.02},{resourceId:"ale",rate:.05},{resourceId:"stone",rate:.1},{resourceId:"wood",rate:.05},{resourceId:"iron_ingot",rate:.03}],port:[{resourceId:"wood",rate:.08},{resourceId:"lumber",rate:.06},{resourceId:"tools",rate:.03}],village:[{resourceId:"wood",rate:.04}],mine:[{resourceId:"wood",rate:.06},{resourceId:"lumber",rate:.04},{resourceId:"tools",rate:.05}],lumber_camp:[{resourceId:"tools",rate:.03}]};function yi(e,t){const i=e.residentIds.length;if(i===0)return;const o=pi[e.type]??.3,n=i*o;let s=0;const r=["city","castle","port","town"].includes(e.type)?["meat","exotic_fruit","fish","bread","berries","wheat"]:["bread","berries","wheat","fish","meat","exotic_fruit"];for(const h of r){if(s>=n)break;for(let p=e.storage.length-1;p>=0&&!(s>=n);p--)if(e.storage[p].resourceId===h){const b=Math.max(0,e.storage[p].quantity-2);if(b<=0)continue;const m=Math.min(n-s,b);e.storage[p].quantity-=m,s+=m,e.storage[p].quantity<=0&&e.storage.splice(p,1)}}const l=mi[e.type],c=["wood","stone","lumber","iron_ingot"];let d=0,f=0;if(l)for(const h of l){const p=c.includes(h.resourceId);p&&(d+=h.rate);for(let y=e.storage.length-1;y>=0;y--)if(e.storage[y].resourceId===h.resourceId&&e.storage[y].quantity>1){e.storage[y].quantity-=h.rate,e.storage[y].quantity<=0&&e.storage.splice(y,1),p&&(f+=h.rate);break}}if(d>0){const h=f/d;h>=.8?e.durability=Math.min(100,e.durability+.5):h<.3?e.durability=Math.max(50,e.durability-1.5):e.durability=Math.max(50,e.durability-.5)}const u=n>0?Math.min(1,s/n):1;if(e.happiness=Math.max(0,Math.min(100,e.happiness+(u>.8?1:u>.5?0:-3))),u<.3&&i>1){const h=e.residentIds.pop();if(h){const p=t.characters.get(h);p&&(p.homeLocationId=null,p.jobType="unemployed",p.needs.food=0)}e.prosperity=Math.max(0,e.prosperity-2)}for(const h of e.residentIds){const p=t.characters.get(h);p&&(p.needs.food=Math.min(100,u*80+10))}}function gi(e){for(let t=e.storage.length-1;t>=0;t--){const i=e.storage[t];i.age++;const o=B[i.resourceId];if(o&&o.spoilRate>0){const n=Math.ceil(i.quantity*o.spoilRate);i.quantity-=n,i.quantity<=0&&e.storage.splice(t,1)}}}function bi(e,t){for(let o=-3;o<=3;o++)for(let n=-3;n<=3;n++){const s=e.position.x+n,a=e.position.y+o;if(s>=0&&s<t.width&&a>=0&&a<t.height){const r=t.tiles[a][s].resourceDeposit;r&&r.replenishRate>0&&(r.amount=Math.round(Math.min(r.maxAmount,r.amount+r.replenishRate)*10)/10)}}}function Ii(e){const t=new Map;for(const i of e.storage)t.set(i.resourceId,(t.get(i.resourceId)??0)+i.quantity);for(const[i,o]of t){const n=B[i];if(!n)continue;const s=vi(o);e.marketPrices[i]=Math.max(1,Math.round(n.baseValue*s))}}function vi(e){return e<=0?10:e<=1?6:e<=3?4:e<=5?2.5:e<=10?1.5:e<=20?1:e<=40?.75:.5}function wi(e,t,i,o){let n=0;const s=["bread","meat","fish","wheat","berries"],a=e.storage.filter(l=>s.includes(l.resourceId)).reduce((l,c)=>l+c.quantity,0);a>e.residentIds.length*2&&(n+=2),e.prosperity>60&&(n+=1),e.tradeRouteIds.length>0&&(n+=1),e.happiness>70&&(n+=1),e.safety<30&&(n-=2),a<e.residentIds.length&&(n-=2),e.happiness<30&&(n-=1),e.growthPoints=Math.max(0,e.growthPoints+n);const r=30+(a>0?20:0)+(e.safety>50?15:0)+(e.happiness>50?15:0);e.prosperity+=Math.sign(r-e.prosperity)*.5,e.prosperity=Math.max(0,Math.min(100,e.prosperity))}const Ri={hauling:20,cart:80,horse_cart:200,ship:1e3};function ki(e,t){const i=[],o=Array.from(e.locations.values()).filter(n=>!n.isDestroyed&&n.residentIds.length>=3);for(const n of o){if(n.tradeRouteIds.length>=3)continue;const s=[];for(const l of n.storage){const c=B[l.resourceId];c&&l.quantity>c.stackSize*.5&&s.push({resourceId:l.resourceId,amount:l.quantity})}if(s.length===0)continue;let a=null,r=0;for(const l of o){if(l.id===n.id)continue;if(e.tradeRoutes.size>30)break;if(Array.from(e.tradeRoutes.values()).find(u=>u.fromLocationId===n.id&&u.toLocationId===l.id||u.fromLocationId===l.id&&u.toLocationId===n.id))continue;const d=K(n.position,l.position);if(d>30)continue;let f=0;for(const u of s){const h=l.storage.filter(y=>y.resourceId===u.resourceId).reduce((y,b)=>y+b.quantity,0),p=B[u.resourceId];h<(p?.stackSize??20)*.3&&(f+=u.amount*(p?.baseValue??1))}f/=d,n.countryId&&n.countryId===l.countryId&&(f*=1.5),f>r&&(r=f,a=l)}if(a&&r>5){const l=ke(n.position,a.position,e.width,e.height,(c,d)=>he(e.tiles[d][c]));if(l.length>0){const c=L("route"),d={id:c,fromLocationId:n.id,toLocationId:a.id,path:l,distance:l.length,transportType:Si(l.length,n,a),goods:[],merchantId:null,isActive:!0,dangerLevel:0,lastUsedTurn:0};e.tradeRoutes.set(c,d),n.tradeRouteIds.push(c),a.tradeRouteIds.push(c),i.push(`Trade route established: ${n.name} ↔ ${a.name}`)}}}return i}function Si(e,t,i){return t.type==="port"||i.type==="port"?"ship":e>15?"horse_cart":e>8?"cart":"hauling"}function Mi(e,t,i){const o=[];for(const n of e.tradeRoutes.values()){if(!n.isActive)continue;if(Array.from(e.creatures.values()).some(d=>d.type==="trader"&&d.health>0&&(d.homeLocationId===n.fromLocationId&&d.targetLocationId===n.toLocationId||d.homeLocationId===n.toLocationId&&d.targetLocationId===n.fromLocationId))){n.lastUsedTurn=t;continue}const a=e.locations.get(n.fromLocationId),r=e.locations.get(n.toLocationId);if(!a||!r||a.isDestroyed||r.isDestroyed){n.isActive=!1;continue}if(i.chance(n.dangerLevel*.1)){o.push(`Trade route ${a.name} → ${r.name} raided by bandits!`),n.isActive=!1;continue}const l=Ri[n.transportType];let c=0;for(let d=a.storage.length-1;d>=0&&c<l;d--){const f=a.storage[d],u=B[f.resourceId];if(!u||r.storage.filter(b=>b.resourceId===f.resourceId).reduce((b,m)=>b+m.quantity,0)>u.stackSize*.5||f.quantity<=u.stackSize*.3)continue;const p=Math.min(Math.floor(f.quantity*.3),Math.floor((l-c)/u.weight));if(p<=0)continue;f.quantity-=p,f.quantity<=0&&a.storage.splice(d,1),ee(r,f.resourceId,p,f.quality),c+=p*u.weight;const y=Math.floor(p*(r.marketPrices[f.resourceId]??u.baseValue)*.3);for(const b of a.residentIds){const m=e.characters.get(b);if(m&&m.jobType==="merchant"){m.gold+=Math.floor(y/Math.max(1,a.residentIds.filter(I=>e.characters.get(I)?.jobType==="merchant").length));break}}}n.lastUsedTurn=t}return o}function be(e,t,i,o){e.loot=[];const n=50;let s=0;for(let a=t.storage.length-1;a>=0&&s<n;a--){const r=t.storage[a],l=B[r.resourceId];if(!l||i.storage.filter(f=>f.resourceId===r.resourceId).reduce((f,u)=>f+u.quantity,0)>l.stackSize*.5||r.quantity<=l.stackSize*.3)continue;const d=Math.min(Math.floor(r.quantity*.3),Math.floor((n-s)/l.weight));d<=0||(r.quantity-=d,r.quantity<=0&&t.storage.splice(a,1),e.loot.push({resourceId:r.resourceId,quantity:d,quality:r.quality,age:0}),s+=d*l.weight)}}function _e(e,t){for(const i of e.loot)ee(t,i.resourceId,i.quantity,i.quality);e.loot=[]}function Ti(e){for(const t of e.tradeRoutes.values()){let i=0;for(const o of t.path)for(const n of e.creatures.values())n.isHostile&&Math.abs(n.position.x-o.x)+Math.abs(n.position.y-o.y)<5&&(i+=.05);t.dangerLevel=Math.min(1,i)}}function Li(e,t){let o=0;for(const n of e.creatures.values())n.type==="trader"&&n.health>0&&o++;for(const n of e.tradeRoutes.values()){if(!n.isActive||n.path.length<3)continue;if(o>=15)break;if(Array.from(e.creatures.values()).some(f=>f.type==="trader"&&f.health>0&&(f.homeLocationId===n.fromLocationId||f.homeLocationId===n.toLocationId)))continue;const a=e.locations.get(n.fromLocationId);if(!a||a.isDestroyed)continue;const r=j.trader,l=L("creature"),c={id:l,type:"trader",name:null,position:{...a.position},health:r.baseHealth,maxHealth:r.baseHealth,attack:r.baseAttack,defense:r.baseDefense,speed:r.baseSpeed,behavior:"trading",homePosition:{...a.position},wanderRadius:40,isHostile:!1,loot:[],age:0,lastActionTurn:0,countryId:a.countryId,targetLocationId:n.toLocationId,homeLocationId:n.fromLocationId,path:[...n.path],pathProgress:0,pathDirection:1},d=e.locations.get(n.toLocationId);d&&be(c,a,d),e.creatures.set(l,c),o++}}const Di={hungerDrive:2,safetyDrive:1.5,socialDrive:.8,ambitionDrive:1,workDrive:1.5,wanderlust:.05,careerChangeChance:.005,adventurerChance:.001,marriageChance:.01};function Ai(e,t,i,o){if(!e.isAlive)return{type:"idle"};if(e.age<10)return{type:"idle"};if(e.currentAction?.type==="traveling"&&e.turnsUntilArrival>0)return e.currentAction;const n=[],s=e.homeLocationId?t.locations.get(e.homeLocationId):null;if(e.jobType==="shepherd"&&(e.herdedCreatureIds||(e.herdedCreatureIds=[]),e.herdedCreatureIds.length>0)){let l=null,c=1/0;for(const d of e.herdedCreatureIds){const f=t.creatures.get(d);if(!(!f||f.health<=0)){for(const u of t.creatures.values())if(!(u.health<=0)&&(u.type==="wolf"||u.type==="bear"||u.type==="bandit")){const h=S(f.position,u.position);h<8&&h<c&&(c=h,l=u.position)}}}l?n.push({action:{type:"herding"},weight:10,description:"protect flock from predators"}):n.push({action:{type:"herding"},weight:i.workDrive*.8,description:"tend to flock"})}if(s&&e.jobType!=="unemployed"&&e.jobType!=="child"&&e.jobType!=="elder"&&e.jobType!=="shepherd"){const l=i.workDrive*(1-e.personality.curiosity*.3);n.push({action:{type:"working",buildingType:Ei(e.jobType)},weight:l*(e.needs.purpose<40?1.5:1),description:"go to work"})}if(e.needs.food<50){const l=i.hungerDrive*(1-e.needs.food/100);s&&n.push({action:{type:"trading",locationId:s.id},weight:l*2,description:"get food"})}if(e.needs.social<60&&e.relationships.length>0){const l=e.relationships.find(c=>c.type==="friend"||c.type==="spouse");l&&n.push({action:{type:"socializing",targetId:l.targetId},weight:i.socialDrive*(1-e.needs.social/100)*e.personality.kindness,description:"socialize"})}if(e.health<e.maxHealth*.7&&n.push({action:{type:"resting"},weight:i.safetyDrive*(1-e.health/e.maxHealth),description:"rest and recover"}),n.push({action:{type:"idle"},weight:.3,description:"do nothing"}),e.personality.curiosity>.7&&o.chance(i.wanderlust)&&_i(e,t)&&n.push({action:{type:"exploring"},weight:i.ambitionDrive*e.personality.curiosity,description:"explore nearby areas"}),o.chance(i.careerChangeChance*e.personality.ambition)&&(e.needs.purpose<30||e.personality.ambition>.8)&&e.personality.courage>.7&&e.stats.strength>6&&n.push({action:{type:"idle"},weight:i.ambitionDrive*e.personality.ambition*.5,description:"change career"}),e.personality.curiosity>.8&&e.personality.courage>.8&&e.personality.ambition>.7&&e.age>=16&&e.age<=35&&o.chance(i.adventurerChance)&&n.push({action:{type:"exploring"},weight:i.ambitionDrive*2,description:"become an adventurer"}),!e.relationships.some(l=>l.type==="spouse")&&e.age>=16&&e.age<=50&&o.chance(i.marriageChance)&&n.push({action:{type:"socializing",targetId:""},weight:i.socialDrive*.5,description:"look for partner"}),n.length===0)return{type:"idle"};const a=n.reduce((l,c)=>l+Math.max(0,c.weight),0);if(a<=0)return{type:"idle"};let r=o.next()*a;for(const l of n)if(r-=Math.max(0,l.weight),r<=0)return l.action;return n[n.length-1].action}function qi(e,t,i,o){const n=S(e.position,i),s=e.homePosition?S(e.position,e.homePosition):0;return e.type==="dragon"?Ci(e,t,i,n,o):e.type==="bandit"?Pi(e,t,i,n,o):e.type==="guard"?$i(e,t,o):e.type==="army"?Hi(e,t):e.type==="trader"?Oi(e,t):e.type==="hunter"?Wi(e,t,o):e.type==="builder"?Bi(e,t):e.isHostile&&n<4?{dx:Math.sign(i.x-e.position.x),dy:Math.sign(i.y-e.position.y),behavior:"aggressive"}:!e.isHostile&&n<3?{dx:-Math.sign(i.x-e.position.x),dy:-Math.sign(i.y-e.position.y),behavior:"fleeing"}:e.behavior==="territorial"&&s>e.wanderRadius?{dx:Math.sign((e.homePosition?.x??0)-e.position.x),dy:Math.sign((e.homePosition?.y??0)-e.position.y),behavior:"territorial"}:o.chance(.3)?{dx:o.nextInt(-1,1),dy:o.nextInt(-1,1),behavior:e.behavior}:{dx:0,dy:0,behavior:e.behavior}}function Ci(e,t,i,o,n){const s=e.homePosition?S(e.position,e.homePosition):0,a=e.health/e.maxHealth;if(e.attackCooldown&&e.attackCooldown>0)return e.attackCooldown--,e.homePosition&&s>2?{dx:Math.sign(e.homePosition.x-e.position.x)*2,dy:Math.sign(e.homePosition.y-e.position.y)*2,behavior:"territorial"}:(e.health=Math.min(e.maxHealth,e.health+2),{dx:0,dy:0,behavior:"territorial"});if(a<.4&&e.homePosition)return s<=2?(e.health=Math.min(e.maxHealth,e.health+5),{dx:0,dy:0,behavior:"territorial"}):{dx:Math.sign(e.homePosition.x-e.position.x)*3,dy:Math.sign(e.homePosition.y-e.position.y)*3,behavior:"fleeing"};if(a<1&&s<=3?e.health=Math.min(e.maxHealth,e.health+3):a<1&&(e.health=Math.min(e.maxHealth,e.health+.5)),o<8&&a>.5)return{dx:Math.sign(i.x-e.position.x)*2,dy:Math.sign(i.y-e.position.y)*2,behavior:"hunting"};if(n.chance(.1)&&a>.6){let r=null,l=1/0;for(const c of t.locations.values()){if(c.isDestroyed)continue;const d=S(e.position,c.position);d<l&&d<30&&(l=d,r=c)}if(r){const c=Math.sign(r.position.x-e.position.x)*n.nextInt(1,3),d=Math.sign(r.position.y-e.position.y)*n.nextInt(1,3);return{dx:c,dy:d,behavior:"aggressive"}}}return n.chance(.08)?{dx:n.nextInt(-3,3),dy:n.nextInt(-3,3),behavior:"migrating"}:s>e.wanderRadius&&e.homePosition?{dx:Math.sign(e.homePosition.x-e.position.x)*2,dy:Math.sign(e.homePosition.y-e.position.y)*2,behavior:"territorial"}:n.chance(.4)?{dx:n.nextInt(-2,2),dy:n.nextInt(-2,2),behavior:"territorial"}:{dx:0,dy:0,behavior:"territorial"}}function Pi(e,t,i,o,n){if(o<4)return{dx:Math.sign(i.x-e.position.x),dy:Math.sign(i.y-e.position.y),behavior:"raiding"};if(n.chance(.1))for(let a=-5;a<=5;a++)for(let r=-5;r<=5;r++){const l=e.position.x+r,c=e.position.y+a;if(l>=0&&l<t.width&&c>=0&&c<t.height&&t.tiles[c][l].roadLevel>0)return{dx:Math.sign(r),dy:Math.sign(a),behavior:"raiding"}}return n.chance(.3)?{dx:n.nextInt(-1,1),dy:n.nextInt(-1,1),behavior:e.behavior}:{dx:0,dy:0,behavior:e.behavior}}function _i(e,t){for(let o=-5;o<=5;o++)for(let n=-5;n<=5;n++){const s=e.position.x+n,a=e.position.y+o;if(s>=0&&s<t.width&&a>=0&&a<t.height&&!t.tiles[a][s].explored)return{x:s,y:a}}return null}function Ei(e){return{farmer:"farm_field",miner:"mine_shaft",lumberjack:"sawmill",fisher:"dock",shepherd:"farm_field",blacksmith:"blacksmith",weaver:"weaver",baker:"bakery",brewer:"brewery",tanner:"tanner",hunter:"hunter_lodge",herbalist:"apothecary",soldier:"barracks",guard:"wall",priest:"church",merchant:"market"}[e]??"house"}function $i(e,t,i){let o=null,n=1/0;for(const a of t.creatures.values()){if(a.health<=0)continue;const r=a.type==="bandit"||a.type==="dragon",l=a.type==="army"&&a.countryId!==e.countryId;if(!r&&!l)continue;const c=S(e.position,a.position),d=a.type==="dragon"?12:8;c<n&&c<d&&(n=c,o=a)}return o?{dx:Math.sign(o.position.x-e.position.x),dy:Math.sign(o.position.y-e.position.y),behavior:"hunting"}:(e.homePosition?S(e.position,e.homePosition):0)>e.wanderRadius&&e.homePosition?{dx:Math.sign(e.homePosition.x-e.position.x),dy:Math.sign(e.homePosition.y-e.position.y),behavior:"patrolling"}:i.chance(.4)?{dx:i.nextInt(-1,1),dy:i.nextInt(-1,1),behavior:"patrolling"}:{dx:0,dy:0,behavior:"patrolling"}}function Hi(e,t,i){if(e.targetLocationId){const o=t.locations.get(e.targetLocationId);if(o&&!o.isDestroyed){const n=S(e.position,o.position);if(n<=1)return{dx:Math.sign(o.position.x-e.position.x),dy:Math.sign(o.position.y-e.position.y),behavior:"aggressive"};const s=Math.sign(o.position.x-e.position.x)*Math.min(2,n),a=Math.sign(o.position.y-e.position.y)*Math.min(2,n);return{dx:s,dy:a,behavior:"marching"}}else e.targetLocationId=null}if(e.countryId){const o=t.countries.get(e.countryId);if(o){let n=null,s=1/0;for(const a of t.locations.values()){if(a.isDestroyed||!a.countryId||a.countryId===e.countryId||!o.enemies.includes(a.countryId))continue;const r=S(e.position,a.position);r<s&&(s=r,n=a)}if(n)return e.targetLocationId=n.id,{dx:Math.sign(n.position.x-e.position.x),dy:Math.sign(n.position.y-e.position.y),behavior:"marching"}}}return e.homePosition&&S(e.position,e.homePosition)>3?{dx:Math.sign(e.homePosition.x-e.position.x),dy:Math.sign(e.homePosition.y-e.position.y),behavior:"marching"}:{dx:0,dy:0,behavior:"patrolling"}}function Wi(e,t,i){e.turnsWithoutPrey===void 0&&(e.turnsWithoutPrey=0);let o=null,n=1/0;for(const a of t.creatures.values()){if(a.health<=0||!((a.type==="deer"||a.type==="sheep"||a.type==="boar")&&!a.ownerId))continue;const l=S(e.position,a.position);l<n&&l<12&&(n=l,o=a)}return o?(e.turnsWithoutPrey=0,{dx:Math.sign(o.position.x-e.position.x),dy:Math.sign(o.position.y-e.position.y),behavior:"hunting"}):(e.turnsWithoutPrey++,(e.homePosition?S(e.position,e.homePosition):0)>e.wanderRadius&&e.homePosition?{dx:Math.sign(e.homePosition.x-e.position.x),dy:Math.sign(e.homePosition.y-e.position.y),behavior:"hunting"}:i.chance(.5)?{dx:i.nextInt(-1,1),dy:i.nextInt(-1,1),behavior:"hunting"}:{dx:0,dy:0,behavior:"hunting"})}function Bi(e,t,i){const o=e.targetLocationId?t.locations.get(e.targetLocationId):null;return o&&o.isDestroyed&&o.type==="ruins"?S(e.position,o.position)<=1?(o.durability=Math.min(100,o.durability+5),o.durability>=80&&o.originalType&&(o.isDestroyed=!1,o.type=o.originalType,o.originalType=null,o.happiness=30,o.prosperity=20,o.safety=40,e.health=0),{dx:0,dy:0,behavior:"patrolling"}):{dx:Math.sign(o.position.x-e.position.x),dy:Math.sign(o.position.y-e.position.y),behavior:"patrolling"}:e.homePosition&&S(e.position,e.homePosition)>1?{dx:Math.sign(e.homePosition.x-e.position.x),dy:Math.sign(e.homePosition.y-e.position.y),behavior:"patrolling"}:(e.health=0,{dx:0,dy:0,behavior:"patrolling"})}function Oi(e,t,i){if(e.path&&e.path.length>0){const o=e.pathProgress??0,n=e.pathDirection??1,s=o+n;if(s<0||s>=e.path.length){const c=t.locations.get(e.homeLocationId),d=t.locations.get(e.targetLocationId);c&&d&&(_e(e,c),be(e,c,d)),e.pathDirection=n*-1;const f=e.targetLocationId;return e.targetLocationId=e.homeLocationId,e.homeLocationId=f,{dx:0,dy:0,behavior:"trading"}}const a=e.path[s],r=a.x-e.position.x,l=a.y-e.position.y;return e.pathProgress=s,{dx:r,dy:l,behavior:"trading"}}if(e.targetLocationId){const o=t.locations.get(e.targetLocationId);if(o&&!o.isDestroyed){if(S(e.position,o.position)<=1){const s=t.locations.get(e.homeLocationId),a=t.locations.get(e.targetLocationId);s&&a&&(_e(e,s),be(e,s,a));const r=e.targetLocationId;return e.targetLocationId=e.homeLocationId,e.homeLocationId=r,{dx:0,dy:0,behavior:"trading"}}return{dx:Math.sign(o.position.x-e.position.x),dy:Math.sign(o.position.y-e.position.y),behavior:"trading"}}}return e.homePosition&&S(e.position,e.homePosition)>1?{dx:Math.sign(e.homePosition.x-e.position.x),dy:Math.sign(e.homePosition.y-e.position.y),behavior:"trading"}:{dx:0,dy:0,behavior:"trading"}}function Ni(e,t,i,o){const n=[];for(const s of e.creatures.values()){if(s.type!=="dragon"||!o.chance(.03))continue;let a=null,r=1/0;for(const l of e.locations.values()){if(l.isDestroyed)continue;const c=S(s.position,l.position);c<r&&c<10&&(r=c,a=l)}if(a){n.push(F("dragon_attack",t,`${s.name??"A dragon"} attacks ${a.name}!`,`The fearsome ${s.name??"dragon"} descends upon ${a.name}, breathing fire and destruction.`,a.id,[],"major")),a.burningTurns=Math.max(a.burningTurns,3),a.durability=Math.max(0,a.durability-o.nextInt(8,15)),a.defenseLevel=Math.max(0,a.defenseLevel-2),a.safety=Math.max(0,a.safety-30),a.happiness=Math.max(0,a.happiness-20),a.prosperity=Math.max(0,a.prosperity-15);for(const l of a.buildings)o.chance(.3)&&(l.condition=Math.max(0,l.condition-o.nextInt(20,50)),l.condition<=0&&(l.isOperational=!1));s.attackCooldown=o.nextInt(20,40)}}for(const s of e.creatures.values())if(s.type==="bandit"&&o.chance(.05))for(const a of e.locations.values()){if(a.isDestroyed)continue;if(S(s.position,a.position)<5&&a.defenseLevel<3&&a.garrisonIds.length<3){n.push(F("bandit_attack",t,`Bandits raid ${a.name}!`,`A group of bandits attacks the poorly defended ${a.name}, stealing goods and terrorizing residents.`,a.id,[],"moderate"));const l=Math.min(a.storage.length,o.nextInt(1,3));for(let c=0;c<l&&a.storage.length>0;c++){const d=o.nextInt(0,a.storage.length-1);a.storage.splice(d,1)}a.durability=Math.max(0,a.durability-o.nextInt(3,8)),a.safety=Math.max(0,a.safety-15);break}}if(o.chance(.015)){Array.from(e.countries.values());for(const s of e.diplomacy)if(s.type==="rivalry"&&s.strength<-40&&o.chance(.2)){const a=e.countries.get(s.countryAId),r=e.countries.get(s.countryBId);a&&r&&(s.type="war",a.enemies.push(r.id),r.enemies.push(a.id),n.push(F("war_declared",t,`${a.name} declares war on ${r.name}!`,`Tensions between ${a.name} and ${r.name} have erupted into open war. Border settlements prepare for conflict.`,null,[a.leaderId,r.leaderId],"catastrophic")))}}for(const s of e.diplomacy)if(s.type==="war"&&t-s.startedTurn>50&&o.chance(.02)){s.type="truce",s.strength=0;const a=e.countries.get(s.countryAId),r=e.countries.get(s.countryBId);a&&r&&(a.enemies=a.enemies.filter(l=>l!==r.id),r.enemies=r.enemies.filter(l=>l!==a.id),n.push(F("peace_treaty",t,`${a.name} and ${r.name} sign a peace treaty`,`After long conflict, ${a.name} and ${r.name} agree to a truce.`,null,[a.leaderId,r.leaderId],"major")))}if(i==="autumn"&&o.chance(.02)){const s=Array.from(e.locations.values()).filter(a=>!a.isDestroyed&&(a.type==="farm"||a.type==="village"||a.type==="hamlet"));if(s.length>0){const a=o.pick(s);n.push(F("bountiful_harvest",t,`Bountiful harvest in ${a.name}!`,`The farmers of ${a.name} celebrate an exceptional harvest this season.`,a.id,[],"minor")),a.prosperity=Math.min(100,a.prosperity+10),a.happiness=Math.min(100,a.happiness+10)}}if(i==="winter"&&o.chance(.01)){const s=Array.from(e.locations.values()).filter(a=>!a.isDestroyed&&a.residentIds.length>5&&a.storage.filter(r=>["wheat","bread","meat","fish"].includes(r.resourceId)).reduce((r,l)=>r+l.quantity,0)<a.residentIds.length);if(s.length>0){const a=o.pick(s);n.push(F("famine",t,`Famine strikes ${a.name}!`,`Food stores run dangerously low in ${a.name}. The people cry out for relief.`,a.id,[],"major")),a.happiness=Math.max(0,a.happiness-20),a.prosperity=Math.max(0,a.prosperity-10)}}if(o.chance(.002)){const s=Array.from(e.locations.values()).filter(a=>!a.isDestroyed&&a.residentIds.length>15);if(s.length>0){const a=o.pick(s);n.push(F("plague",t,`Plague breaks out in ${a.name}!`,`A terrible sickness spreads through ${a.name}. Many fall ill.`,a.id,[],"catastrophic"));const r=Math.floor(a.residentIds.length*o.nextFloat(.1,.3));for(let l=0;l<r&&a.residentIds.length>2;l++){const c=a.residentIds.pop(),d=e.characters.get(c);d&&(d.isAlive=!1)}a.happiness=Math.max(0,a.happiness-30)}}for(const s of e.locations.values())if(!s.isDestroyed&&!(s.residentIds.length>=s.populationCapacity))for(const a of s.residentIds){const r=e.characters.get(a);if(!r||!r.isAlive||r.age<18||r.age>45)continue;const l=r.relationships.find(d=>d.type==="spouse");if(!l)continue;const c=e.characters.get(l.targetId);if(!(!c||!c.isAlive)&&o.chance(.003)){n.push(F("birth",t,`A child is born in ${s.name}`,`${r.name} and ${c.name} welcome a new child.`,s.id,[r.id,c.id],"minor"));break}}return(i==="autumn"||i==="spring")&&o.chance(.01)&&n.push(F("monster_migration",t,"Creatures are migrating!","Packs of wild beasts are on the move as the seasons change. Travelers beware!",null,[],"moderate")),n}function F(e,t,i,o,n,s,a){return{id:L("evt"),type:e,turn:t,title:i,description:o,locationId:n,characterIds:s,isResolved:!1,effects:[],severity:a}}const zi={minor:0,moderate:15,major:50,catastrophic:999};function Fi(e){const{party:t,world:i,worldEvents:o,knownEventIds:n,eventLog:s}=e,a=i.tiles[t.position.y]?.[t.position.x];if(!a?.locationId)return;const r=i.locations.get(a.locationId);if(!r||r.isDestroyed)return;const l=r.position;for(const c of o){if(n.has(c.id)||e.turn-c.turn>60)continue;const d=zi[c.severity];if(c.locationId===r.id){me(e,c);continue}if(c.locationId){const f=i.locations.get(c.locationId);if(f&&K(l,f.position)<=d){me(e,c);continue}}!c.locationId&&d>=50&&me(e,c)}}function me(e,t){e.knownEventIds.add(t.id),e.eventLog.push({turn:t.turn,message:t.title,type:Yi(t.severity),locationId:t.locationId??void 0})}function U(e,t){const{party:i,world:o}=e;if(!t.locationId&&(t.severity==="catastrophic"||t.severity==="major"))return!0;if(!t.locationId)return!1;const n=o.locations.get(t.locationId);return n?K(i.position,n.position)<=8:!1}function Yi(e){switch(e){case"catastrophic":return"danger";case"major":return"danger";case"moderate":return"info";default:return"info"}}function ji(e){const t=[],{world:i}=e;for(const o of i.locations.values())if(!o.isDestroyed&&!(o.durability>0)){o.isDestroyed=!0,o.originalType=o.type,o.type="ruins";for(const n of o.residentIds){const s=i.characters.get(n);s&&(s.homeLocationId=null,s.jobType="unemployed")}o.residentIds=[],o.garrisonIds=[],t.push({id:L("evt"),type:"settlement_destroyed",turn:e.turn,title:`${o.name} has been destroyed!`,description:`The settlement of ${o.name} lies in ruins. Its people have scattered.`,locationId:o.id,characterIds:[],isResolved:!1,effects:[],severity:"major"})}return t}function Xi(e){for(const t of e.locations.values()){if(t.isDestroyed)continue;if(t.burningTurns>0){t.burningTurns--,t.durability=Math.max(0,t.durability-5),t.happiness=Math.max(0,t.happiness-5);for(const a of t.buildings)Math.random()<.15&&(a.condition=Math.max(0,a.condition-10),a.condition<=0&&(a.isOperational=!1));continue}if(t.durability>=100)continue;const i=t.residentIds.length>=2,o=t.storage.some(a=>a.resourceId==="wood"&&a.quantity>0),n=t.storage.some(a=>a.resourceId==="stone"&&a.quantity>0);let s=0;i&&(s+=.3),o&&(s+=.2),n&&(s+=.2),t.wallLevel>0&&(s+=.1*t.wallLevel),t.durability=Math.min(100,t.durability+s)}}function Gi(e,t){const i=Array.from(e.locations.values()).filter(n=>n.isDestroyed&&n.type==="ruins");if(i.length===0)return;const o=Array.from(e.locations.values()).filter(n=>!n.isDestroyed&&(n.type==="city"||n.type==="town")&&n.residentIds.length>=10);for(const n of i){if(Array.from(e.creatures.values()).some(l=>l.type==="builder"&&l.targetLocationId===n.id))continue;let a=null,r=1/0;for(const l of o){const c=S(l.position,n.position);c<r&&c<40&&(r=c,a=l)}if(a&&t.chance(.15)){const l=j.builder,c=L("creature"),d={id:c,type:"builder",name:`${a.name} Builders`,position:{...a.position},health:l.baseHealth,maxHealth:l.baseHealth,attack:l.baseAttack,defense:l.baseDefense,speed:l.baseSpeed,behavior:"patrolling",homePosition:{...a.position},homeLocationId:a.id,targetLocationId:n.id,wanderRadius:l.wanderRadius,isHostile:!1,loot:[],age:0,lastActionTurn:0,countryId:a.countryId};e.creatures.set(c,d)}}}const Vi=2,Ui=.15;function Qi(e,t){for(const i of e.locations.values()){if(i.isDestroyed||!i.buildings.some(r=>r.type==="hunter_lodge"&&r.isOperational))continue;let n=0;for(const r of i.residentIds){const l=e.characters.get(r);l&&l.jobType==="hunter"&&l.onDuty&&l.isAlive&&n++}if(n>=Vi||!t.chance(Ui))continue;let s=null;for(const r of i.residentIds){const l=e.characters.get(r);if(l&&l.jobType==="hunter"&&!l.onDuty&&l.isAlive&&l.age>=16){s=l;break}}if(s||i.residentIds.length<i.populationCapacity&&(s=J(t,i.position,i.id,"hunter"),e.characters.set(s.id,s),i.residentIds.push(s.id)),!s)continue;const a=j.hunter;s.onDuty=!0,s.dutyWanderRadius=a.wanderRadius,s.turnsOnDuty=0,s.currentAction={type:"working",buildingType:"hunter_lodge"}}}const Ki=20;function Zi(e){for(const t of e.characters.values())if(!(t.jobType!=="hunter"||!t.onDuty)&&t.isAlive&&t.turnsOnDuty>=Ki){const i=t.homeLocationId?e.locations.get(t.homeLocationId):null;i&&S(t.position,i.position)<3&&(t.onDuty=!1,t.turnsOnDuty=0,t.position={...i.position},t.currentAction={type:"idle"})}}const Ji=2;function xi(e,t){for(const i of e.locations.values()){if(i.isDestroyed)continue;const o=i.buildings.some(c=>c.type==="barracks"&&c.isOperational),n=i.buildings.some(c=>c.type==="wall"&&c.isOperational);if(!o&&!n)continue;let s=0;for(const c of i.residentIds){const d=e.characters.get(c);d&&d.jobType==="guard"&&d.onDuty&&d.isAlive&&s++}for(const c of i.garrisonIds){const d=e.characters.get(c);d&&d.jobType==="guard"&&d.onDuty&&d.isAlive&&s++}if(s>=(o?Ji:1))continue;let r=null;for(const c of[...i.residentIds,...i.garrisonIds]){const d=e.characters.get(c);if(d&&d.jobType==="guard"&&!d.onDuty&&d.isAlive&&d.age>=18){r=d;break}}if(!r)for(const c of[...i.residentIds,...i.garrisonIds]){const d=e.characters.get(c);if(d&&d.jobType==="soldier"&&!d.onDuty&&d.isAlive&&d.age>=18){r=d;break}}if(r||i.residentIds.length+i.garrisonIds.length<i.populationCapacity&&(r=J(t,i.position,i.id,"guard"),e.characters.set(r.id,r),i.garrisonIds.push(r.id)),!r)continue;const l=j.guard;r.onDuty=!0,r.dutyWanderRadius=l.wanderRadius,r.turnsOnDuty=0,r.currentAction={type:"working",buildingType:"barracks"}}}const eo=2;function to(e,t){const i=[],{world:o}=e;for(const n of o.diplomacy){if(n.type!=="war")continue;const s=o.countries.get(n.countryAId),a=o.countries.get(n.countryBId);if(!(!s||!a))for(const[r,l]of[[s,a],[a,s]]){let c=0;for(const m of o.creatures.values())m.type==="army"&&m.countryId===r.id&&m.health>0&&c++;if(c>=eo||!t.chance(.08))continue;const d=o.locations.get(r.capitalLocationId);if(!d||d.isDestroyed)continue;let f=null,u=1/0;for(const m of l.locationIds){const I=o.locations.get(m);if(!I||I.isDestroyed)continue;const v=S(d.position,I.position);v<u&&(u=v,f=I)}if(!f)continue;const h=j.army,p=t.nextInt(h.packSize[0],h.packSize[1]),y=L("creature"),b={id:y,type:"army",name:`${r.name} Army`,position:{...d.position},health:h.baseHealth*Math.sqrt(p),maxHealth:h.baseHealth*Math.sqrt(p),attack:h.baseAttack*Math.sqrt(p),defense:h.baseDefense*Math.sqrt(p),speed:h.baseSpeed,behavior:"marching",homePosition:{...d.position},wanderRadius:60,isHostile:!1,loot:[],age:0,lastActionTurn:0,countryId:r.id,targetLocationId:f.id,homeLocationId:d.id};o.creatures.set(y,b),i.push({id:L("evt"),type:"war_declared",turn:e.turn,title:`${r.name} musters an army at ${d.name}!`,description:`An army marches from ${d.name} toward ${f.name}.`,locationId:d.id,characterIds:[],isResolved:!1,effects:[],severity:"major"})}}return i}function io(e,t){const i=[],{world:o}=e,n=Array.from(o.creatures.values()).filter(a=>a.health>0),s=new Map;for(const a of n){const r=`${a.position.x},${a.position.y}`;s.has(r)||s.set(r,[]),s.get(r).push(a)}for(const[,a]of s){if(a.length<2)continue;const r=a.filter(h=>h.type==="guard"&&h.health>0),l=a.filter(h=>h.health>0&&(h.type==="bandit"||h.type==="dragon"||h.type==="army"&&r.length>0&&h.countryId!==r[0].countryId));for(const h of r)for(const p of l){if(h.health<=0||p.health<=0)continue;const y=se(h,p,t);y&&i.push(y)}const c=a.filter(h=>h.type==="dragon"&&h.health>0);for(let h=0;h<c.length;h++)for(let p=h+1;p<c.length;p++){if(c[h].health<=0||c[p].health<=0)continue;const y=se(c[h],c[p],t);y&&i.push(y)}const d=a.filter(h=>h.type==="army"&&h.health>0);for(let h=0;h<d.length;h++)for(let p=h+1;p<d.length;p++){if(d[h].countryId===d[p].countryId||d[h].health<=0||d[p].health<=0)continue;const y=se(d[h],d[p],t);y&&i.push(y)}const f=a.filter(h=>h.type==="hunter"&&h.health>0),u=a.filter(h=>h.health>0&&(h.type==="deer"||h.type==="sheep"||h.type==="boar"));for(const h of f)for(const p of u){if(h.health<=0||p.health<=0)continue;const y=se(h,p,t);if(y&&p.health<=0){const b=h.homeLocationId?o.locations.get(h.homeLocationId):null;if(b&&!b.isDestroyed){for(const m of p.loot)ee(b,m.resourceId,m.quantity,m.quality);i.push({id:L("evt"),type:"trade",turn:e.turn,title:`Hunters return with game at ${b.name}`,description:`Hunters brought back ${p.loot.map(m=>`${Math.round(m.quantity)} ${m.resourceId}`).join(", ")}.`,locationId:b.id,characterIds:[],isResolved:!1,effects:[],severity:"minor"})}}y&&i.push(y)}}for(const a of n){if(a.type!=="army"||a.health<=0)continue;const r=o.tiles[a.position.y]?.[a.position.x];if(!r?.locationId)continue;const l=o.locations.get(r.locationId);if(!l||l.isDestroyed||l.countryId===a.countryId)continue;const c=a.attack/10,d=l.durability;l.durability=Math.max(0,l.durability-c),l.safety=Math.max(0,l.safety-5),l.happiness=Math.max(0,l.happiness-3);const f=l.defenseLevel*2+l.garrisonIds.length;if(a.health=Math.max(0,a.health-f),d>20&&l.durability<=20&&a.countryId){const u=o.countries.get(a.countryId),h=l.countryId?o.countries.get(l.countryId):null;if(u){h&&(h.locationIds=h.locationIds.filter(b=>b!==l.id));const p=h?.name??"independent",y=h&&h.capitalLocationId===l.id;if(l.countryId=u.id,u.locationIds.push(l.id),y&&h&&h.locationIds.length>0){let b=null,m=0;for(const I of h.locationIds){const v=o.locations.get(I);v&&!v.isDestroyed&&v.size>m&&(b=v,m=v.size)}b&&(h.capitalLocationId=b.id)}l.happiness=Math.max(20,l.happiness-30),l.safety=Math.max(10,l.safety-20),l.garrisonIds=[],i.push({id:L("evt"),type:"war_declared",turn:e.turn,title:`${l.name} falls to ${u.name}!`,description:`${l.name} has been conquered by ${u.name} forces. The settlement now flies ${u.name}'s banner. Former allegiance: ${p}.`,locationId:l.id,characterIds:[],isResolved:!1,effects:[],severity:"major"})}}else t.chance(.1)&&i.push({id:L("evt"),type:"bandit_attack",turn:e.turn,title:`${a.name??"An army"} attacks ${l.name}!`,description:`Military forces assault ${l.name}. Durability: ${Math.round(l.durability)}.`,locationId:l.id,characterIds:[],isResolved:!1,effects:[],severity:"major"})}return i}function se(e,t,i){for(let a=0;a<5;a++){const r=Math.max(1,e.attack-t.defense+i.nextInt(-2,2));if(t.health-=r,t.health<=0)break;const l=Math.max(1,t.attack-e.defense+i.nextInt(-2,2));if(e.health-=l,e.health<=0)break}const n=e.name??e.type,s=t.name??t.type;if(e.health<=0||t.health<=0){const a=e.health>0?n:s,r=e.health>0?s:n;return{id:L("evt"),type:"bandit_attack",turn:0,title:`${a} defeated ${r} in combat!`,description:`${a} prevailed against ${r}.`,locationId:null,characterIds:[],isResolved:!1,effects:[],severity:"moderate"}}return null}function oo(e){const t=new Set;for(const i of e.diplomacy)i.type==="war"&&(t.add(i.countryAId),t.add(i.countryBId));for(const[i,o]of e.creatures)o.type==="army"&&o.countryId&&!t.has(o.countryId)&&e.creatures.delete(i)}const Xe=12,no=5,ae=15;function so(e,t){const i=[];for(const o of e.characters.values())if(!(!o.isAlive||o.jobType!=="shepherd")&&(o.herdedCreatureIds||(o.herdedCreatureIds=[]),!(o.herdedCreatureIds.length>=Xe))){for(const n of e.creatures.values())if(!(n.type!=="sheep"||n.ownerId||n.health<=0||S(o.position,n.position)>8)){if(n.ownerId=o.id,o.herdedCreatureIds.push(n.id),n.lastWoolProduction=0,n.breedingCooldown=t.nextInt(0,ae),n.behavior="passive",n.homePosition={...o.position},o.homeLocationId){const a=e.locations.get(o.homeLocationId);a&&!a.isDestroyed&&i.push({id:L("evt"),type:"trade",turn:0,title:`${o.name} gathered sheep at ${a.name}`,description:`Shepherd ${o.name} added a sheep to their flock.`,locationId:a.id,characterIds:[o.id],isResolved:!1,effects:[],severity:"minor"})}break}}return i}function ao(e){for(const t of e.characters.values())if(!(!t.isAlive||t.jobType!=="shepherd")&&(t.herdedCreatureIds||(t.herdedCreatureIds=[]),t.herdedCreatureIds.length!==0))for(const i of t.herdedCreatureIds){const o=e.creatures.get(i);if(!o||o.health<=0)continue;const n=S(o.position,t.position);if(n>3){const s=Math.sign(t.position.x-o.position.x),a=Math.sign(t.position.y-o.position.y);o.position.x+=s,o.position.y+=a}else if(n>1&&Math.random()<.3){const s=Math.sign(t.position.x-o.position.x),a=Math.sign(t.position.y-o.position.y);o.position.x+=s,o.position.y+=a}o.homePosition={...t.position}}}function lo(e,t){const i=[];for(const o of e.characters.values()){if(!o.isAlive||o.jobType!=="shepherd"||!o.homeLocationId||(o.herdedCreatureIds||(o.herdedCreatureIds=[]),o.herdedCreatureIds.length===0))continue;const n=e.locations.get(o.homeLocationId);if(!n||n.isDestroyed)continue;let s=0;for(const a of o.herdedCreatureIds){const r=e.creatures.get(a);if(!r||r.health<=0)continue;const l=r.lastWoolProduction??0;if(t-l>=no){const c=1+Math.random()*.5;ee(n,"wool",c,.7),r.lastWoolProduction=t,s+=c}}s>0&&i.push({id:L("evt"),type:"trade",turn:t,title:`Wool produced at ${n.name}`,description:`${o.name}'s flock produced ${s.toFixed(1)} wool.`,locationId:n.id,characterIds:[o.id],isResolved:!1,effects:[],severity:"minor"})}return i}function ro(e,t,i){const o=[];for(const n of e.characters.values()){if(!n.isAlive||n.jobType!=="shepherd"||(n.herdedCreatureIds||(n.herdedCreatureIds=[]),n.herdedCreatureIds.length<2)||n.herdedCreatureIds.length>=Xe)continue;const s=[];for(const a of n.herdedCreatureIds){const r=e.creatures.get(a);if(!r||r.health<=0)continue;if((r.breedingCooldown??0)<=0&&(s.push(r),s.length>=2))break}if(s.length>=2&&i.chance(.2)){const a=j.sheep,r=L("creature"),l={id:r,type:"sheep",name:null,position:{...n.position},health:a.baseHealth*.5,maxHealth:a.baseHealth,attack:a.baseAttack,defense:a.baseDefense,speed:a.baseSpeed,behavior:"passive",homePosition:{...n.position},wanderRadius:3,isHostile:!1,loot:[{resourceId:"wool",quantity:.5,quality:.5,age:0},{resourceId:"meat",quantity:.5,quality:.5,age:0}],age:0,lastActionTurn:t,countryId:null,targetLocationId:null,homeLocationId:n.homeLocationId,ownerId:n.id,lastWoolProduction:t,breedingCooldown:ae};if(e.creatures.set(r,l),n.herdedCreatureIds.push(r),s[0].breedingCooldown=ae,s[1].breedingCooldown=ae,n.homeLocationId){const c=e.locations.get(n.homeLocationId);c&&!c.isDestroyed&&o.push({id:L("evt"),type:"trade",turn:t,title:`Lamb born at ${c.name}`,description:`${n.name}'s flock grew by one!`,locationId:c.id,characterIds:[n.id],isResolved:!1,effects:[],severity:"minor"})}}for(const a of n.herdedCreatureIds){const r=e.creatures.get(a);r&&r.breedingCooldown!==void 0&&r.breedingCooldown>0&&r.breedingCooldown--}}return o}function co(e){for(const t of e.characters.values())t.herdedCreatureIds||(t.herdedCreatureIds=[]),t.herdedCreatureIds.length!==0&&(t.herdedCreatureIds=t.herdedCreatureIds.filter(i=>{const o=e.creatures.get(i);return o&&o.health>0}));for(const t of e.creatures.values())if(t.ownerId){const i=e.characters.get(t.ownerId);(!i||!i.isAlive)&&(t.ownerId=null,t.behavior="passive")}}const g={deepWater:"#0f3460",water:"#1a5276",waterHighlight:"#5dade2",sand:"#e8d4a2",sandDark:"#d4b87a",desert:"#d4a843",desertDark:"#b8922c",grassDark:"#3a7a28",grass:"#5a9c3a",grassLight:"#78b858",dryGrass:"#9ca44c",treeDark:"#14420a",tree:"#1e5810",treeLight:"#2a6e18",treeHighlight:"#3c8828",jungleTree:"#107010",jungleTreeDark:"#084c08",hillGrass:"#8c9c5c",rock:"#7c7c7c",rockDark:"#5c5c5c",snow:"#e8e8f0",snowShadow:"#c8c8d8",tundra:"#a8b8a0",tundraDark:"#8ca080",swampWater:"#3c5c3c",swamp:"#4c6c3c",savanna:"#b8a848",savannaDark:"#a09030",woodWall:"#8c6c3c",woodWallDark:"#6c5028",stoneWall:"#a0a0a0",stoneWallDark:"#707070",stoneWallLight:"#c0c0c0",roofRed:"#a04040",roofRedDark:"#803030",roofBlue:"#4040a0",roofBrown:"#705030",skinLight:"#e8c8a0",skinMedium:"#d4b088",skinPale:"#e8c8a0",skinTan:"#d4b088",hairBrown:"#5a3a1a",clothRed:"#c44444",clothBlue:"#4444c4",clothBrown:"#8c6c3c",clothGold:"#c8a848",uiBorder:"#3a3a5e",uiText:"#e0d8c8",uiHighlight:"#c8a84e",uiDanger:"#c44444",uiSafe:"#44a044",roadDirt:"#a09070",fireOrange:"#e87020",fireYellow:"#f0c040"};function Ie(e,t){const i=Math.max(0,parseInt(e.slice(1,3),16)-t),o=Math.max(0,parseInt(e.slice(3,5),16)-t),n=Math.max(0,parseInt(e.slice(5,7),16)-t);return`#${i.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`}function Ee(e,t){const i=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16);return`rgba(${i},${o},${n},${t})`}const _=32,D=_*Math.sqrt(3),$e=_*2,q=_*1.5,C=12;class fo{x;y;zoom;targetX;targetY;targetZoom;screenWidth;screenHeight;minZoom=.25;maxZoom=3;smoothing=.35;constructor(t,i){this.x=0,this.y=0,this.zoom=1,this.targetX=0,this.targetY=0,this.targetZoom=1,this.screenWidth=t,this.screenHeight=i}update(){this.x+=(this.targetX-this.x)*this.smoothing,this.y+=(this.targetY-this.y)*this.smoothing,this.zoom+=(this.targetZoom-this.zoom)*this.smoothing}pan(t,i){this.targetX-=t/this.zoom,this.targetY-=i/this.zoom}zoomAt(t,i,o){const n=H(this.targetZoom*t,this.minZoom,this.maxZoom),s=n/this.targetZoom,a=(i-this.screenWidth/2)/this.targetZoom+this.targetX,r=(o-this.screenHeight/2)/this.targetZoom+this.targetY;this.targetX=a-(a-this.targetX)/s,this.targetY=r-(r-this.targetY)/s,this.targetZoom=n}centerOnTile(t,i){const{x:o,y:n}=P(t,i,D,q);this.targetX=o,this.targetY=n}screenToWorld(t,i){return{wx:(t-this.screenWidth/2)/this.zoom+this.x,wy:(i-this.screenHeight/2)/this.zoom+this.y}}worldToScreen(t,i){return{sx:(t-this.x)*this.zoom+this.screenWidth/2,sy:(i-this.y)*this.zoom+this.screenHeight/2}}screenToTile(t,i){const{wx:o,wy:n}=this.screenToWorld(t,i),{q:s,r:a}=ye(o,n,D,q);return{tx:s,ty:a}}getVisibleRange(t,i){const n=this.screenToTile(0,0),s=this.screenToTile(this.screenWidth,0),a=this.screenToTile(0,this.screenHeight),r=this.screenToTile(this.screenWidth,this.screenHeight);return{minX:H(Math.min(n.tx,s.tx,a.tx,r.tx)-4,0,t-1),maxX:H(Math.max(n.tx,s.tx,a.tx,r.tx)+4,0,t-1),minY:H(Math.min(n.ty,s.ty,a.ty,r.ty)-4,0,i-1),maxY:H(Math.max(n.ty,s.ty,a.ty,r.ty)+4,0,i-1)}}resize(t,i){this.screenWidth=t,this.screenHeight=i}}const Ge=32;function ie(e,t,i,o=Ge){e.beginPath();for(let n=0;n<6;n++){const s=Math.PI/3*n-Math.PI/6,a=t+o*Math.cos(s),r=i+o*Math.sin(s);n===0?e.moveTo(a,r):e.lineTo(a,r)}e.closePath()}function uo(e,t,i=Ge){const o=[];for(let n=0;n<6;n++){const s=Math.PI/3*n-Math.PI/6;o.push({x:e+i*Math.cos(s),y:t+i*Math.sin(s)})}return o}const ve=new Map;function He(e,t,i,o,n,s="ground"){const a=Math.round(n*3),r=`${s}_${e}_${t}_${i}_${o}_${a}`,l=ve.get(r);if(l)return l;const c=ho(e,t,i,o,n,s);return ve.set(r,c),c}function ho(e,t,i,o,n,s){const a=t*C,r=$e+a+40,l=new OffscreenCanvas(D+4,r),c=l.getContext("2d"),d=po(e,o),f=(D+4)/2,u=r-$e/2-a;return s==="ground"?(a>0&&Io(c,f,u,a,d.sideDark,d.sideLight),bo(c,f,u,_,d.top),vo(c,f,u,e,i,d),e==="ocean"&&Ro(c,f,u,i)):n>.1&&e!=="ocean"&&e!=="beach"&&e!=="desert"&&wo(c,f,u,e,n,o,i),l}function po(e,t){let i,o;switch(e){case"ocean":i=t==="winter"?g.deepWater:g.water,o=g.waterHighlight;break;case"beach":i=g.sand,o=g.sandDark;break;case"desert":i=g.desert,o=g.desertDark;break;case"grassland":i=t==="winter"?g.dryGrass:t==="autumn"?"#8ca04c":g.grass,o=g.grassLight;break;case"forest":case"dense_forest":i=t==="winter"?"#5c7c4c":t==="autumn"?"#a07030":g.grassDark,o=g.treeLight;break;case"jungle":i=g.jungleTree,o=g.jungleTreeDark;break;case"hills":i=t==="winter"?g.snowShadow:g.hillGrass,o=g.rock;break;case"mountain":i=g.rock,o=g.rockDark;break;case"snow_mountain":i=g.snow,o=g.snowShadow;break;case"tundra":i=t==="winter"?g.snow:g.tundra,o=g.tundraDark;break;case"swamp":i=g.swamp,o=g.swampWater;break;case"savanna":i=t==="winter"?g.dryGrass:g.savanna,o=g.savannaDark;break;default:i=g.grass,o=g.grassDark}return{top:i,sideDark:Ie(i,40),sideLight:Ie(i,20),accent:o}}function mo(e,t,i,o){e.fillStyle="#5a3a1a",e.fillRect(t,i-4,2,5);let n,s;o==="autumn"?(n="#a85820",s="#c87838"):o==="winter"?(n="#4a6840",s="#5c7c50"):(n=g.tree,s=g.treeLight),e.fillStyle=n,e.fillRect(t-2,i-8,6,3),e.fillRect(t-1,i-10,4,2),e.fillRect(t,i-11,2,1),e.fillStyle=s,e.fillRect(t,i-10,3,1),e.fillRect(t+1,i-8,2,1)}function yo(e,t,i,o,n){e.fillStyle=n?"#3a2a0a":"#4a2a10",e.fillRect(t,i-6,3,7);let s,a,r;n?(s=g.jungleTreeDark,a=g.jungleTree,r="#18881a"):o==="autumn"?(s="#8a4818",a="#a86020",r="#c08030"):o==="winter"?(s="#3a5430",a="#4a6840",r="#587850"):(s=g.treeDark,a=g.tree,r=g.treeLight),e.fillStyle=s,e.fillRect(t-3,i-10,9,4),e.fillRect(t-2,i-13,7,3),e.fillStyle=a,e.fillRect(t-2,i-12,6,3),e.fillRect(t-1,i-15,5,2),e.fillStyle=r,e.fillRect(t,i-14,3,2),e.fillRect(t+1,i-10,3,1),e.fillRect(t,i-16,3,1)}function go(e,t,i,o){e.fillStyle=o==="winter"?"#5a6848":g.treeLight,e.fillRect(t-1,i-3,4,2),e.fillStyle=o==="winter"?"#6c7c58":g.treeHighlight,e.fillRect(t,i-4,2,1),e.fillRect(t+1,i-3,1,1)}function Se(e){return e=(e>>16^e)*73244475,e=(e>>16^e)*73244475,e=e>>16^e,Math.abs(e)}function bo(e,t,i,o,n){e.fillStyle=n,ie(e,t,i,o),e.fill()}function Io(e,t,i,o,n,s){const a=uo(t,i,_);e.fillStyle=s,e.beginPath(),e.moveTo(a[0].x,a[0].y),e.lineTo(a[5].x,a[5].y),e.lineTo(a[5].x,a[5].y+o),e.lineTo(a[0].x,a[0].y+o),e.closePath(),e.fill(),e.fillStyle=n,e.beginPath(),e.moveTo(a[5].x,a[5].y),e.lineTo(a[4].x,a[4].y),e.lineTo(a[4].x,a[4].y+o),e.lineTo(a[5].x,a[5].y+o),e.closePath(),e.fill(),e.fillStyle=Ie(n,10),e.beginPath(),e.moveTo(a[4].x,a[4].y),e.lineTo(a[3].x,a[3].y),e.lineTo(a[3].x,a[3].y+o),e.lineTo(a[4].x,a[4].y+o),e.closePath(),e.fill()}function vo(e,t,i,o,n,s){const a=Se(n);e.fillStyle=s.accent;const r=_*.8;if(o==="grassland"||o==="savanna")for(let l=0;l<6;l++){const c=a*(l+1)*.7%(Math.PI*2),d=a*(l+1)*11%r,f=Math.cos(c)*d,u=Math.sin(c)*d;e.fillRect(t+f,i+u,2,1)}else if(o==="desert")for(let l=0;l<4;l++){const c=a*(l+1)*.9%(Math.PI*2),d=a*(l+1)*13%r,f=Math.cos(c)*d,u=Math.sin(c)*d;e.fillRect(t+f,i+u,4,1)}else if(o==="mountain"||o==="snow_mountain")for(let l=0;l<5;l++){const c=a*(l+1)*.6%(Math.PI*2),d=a*(l+1)*9%r,f=Math.cos(c)*d,u=Math.sin(c)*d;e.fillRect(t+f,i+u,3,2)}else if(o==="swamp"){e.fillStyle=g.swampWater;for(let l=0;l<3;l++){const c=a*(l+1)*.8%(Math.PI*2),d=a*(l+1)*11%r,f=Math.cos(c)*d,u=Math.sin(c)*d;e.fillRect(t+f,i+u,5,2)}}}function wo(e,t,i,o,n,s,a){const r=Math.floor(n*4),l=Se(a+1e3),c=_*.7;for(let d=0;d<r;d++){const f=(l*(d+1)*.7+d*1.2)%(Math.PI*2),u=l*(d+1)*11%c,h=Math.cos(f)*u,p=Math.sin(f)*u,y=t+h,b=i+p;o==="jungle"||o==="dense_forest"?yo(e,y,b,s,o==="jungle"):o==="forest"?mo(e,y,b,s):go(e,y,b,s)}}function Ro(e,t,i,o){e.fillStyle=g.waterHighlight;const n=Se(o+5e3),s=_*.7;for(let a=0;a<3;a++){const r=n*(a+1)*.7%(Math.PI*2),l=n*(a+1)*11%s,c=Math.cos(r)*l,d=Math.sin(r)*l;e.fillRect(t+c,i+d,3,1)}}function ko(){ve.clear()}const te=6;function So(e){const t=new x(e.world.seed+e.turn*31337);e.turn++;const i=ni(e.turn);i!==e.season&&(e.season=i,ko(),z(e,`Season changes to ${i}.`,"system")),e.weather=_o(e.season,t),ci(e.world,e.season,t.fork()),e.turn%5===0&&Mi(e.world,e.turn,t.fork()),e.turn%20===0&&(ki(e.world,t.fork()),Ti(e.world),Li(e.world,t.fork())),Do(e,t.fork()),qo(e,t.fork());const o=Ni(e.world,e.turn,e.season,t.fork());for(const l of o)e.activeEvents.push(l),e.worldEvents.push(l),U(e,l)&&(e.knownEventIds.add(l.id),z(e,l.title,We(l.severity),l.locationId??void 0));e.worldEvents.length>300&&(e.worldEvents=e.worldEvents.filter(l=>e.turn-l.turn<80));const n=so(e.world,t.fork());for(const l of n)l.turn=e.turn,e.worldEvents.push(l),U(e,l)&&(e.knownEventIds.add(l.id),z(e,l.title,"trade",l.locationId??void 0));ao(e.world);const s=lo(e.world,e.turn);for(const l of s)e.worldEvents.push(l),U(e,l)&&(e.knownEventIds.add(l.id),z(e,l.title,"trade",l.locationId??void 0));if(e.turn%3===0){const l=ro(e.world,e.turn,t.fork());for(const c of l)e.worldEvents.push(c),U(e,c)&&(e.knownEventIds.add(c.id),z(e,c.title,"info",c.locationId??void 0))}if(co(e.world),e.turn%10===0&&(xi(e.world,t.fork()),Qi(e.world,t.fork()),Gi(e.world,t.fork())),Zi(e.world),e.turn%5===0){const l=to(e,t.fork());for(const c of l)e.worldEvents.push(c),U(e,c)&&(e.knownEventIds.add(c.id),z(e,c.title,We(c.severity),c.locationId??void 0))}const a=io(e,t.fork());for(const l of a)l.turn=e.turn,e.worldEvents.push(l),U(e,l)&&(e.knownEventIds.add(l.id),z(e,l.title,"combat",l.locationId??void 0));Xi(e.world);const r=ji(e);for(const l of r)e.activeEvents.push(l),e.worldEvents.push(l),U(e,l)&&(e.knownEventIds.add(l.id),z(e,l.title,"danger",l.locationId??void 0));oo(e.world),Po(e),e.turn%360===0&&Eo(e.world),console.log(`[Turn ${e.turn}] Before restore: AP = ${e.party.actionPoints}`),e.party.maxActionPoints=6,e.party.actionPoints=e.party.maxActionPoints,console.log(`[Turn ${e.turn}] After restore: AP = ${e.party.actionPoints}`),e.activeEvents=e.activeEvents.filter(l=>!l.isResolved&&e.turn-l.turn<50)}function Mo(e,t,i,o){e.turnsOnDuty++;const n=e.homeLocationId?t.locations.get(e.homeLocationId):null;if(!n){e.onDuty=!1;return}const s=S(e.position,n.position);if(e.jobType==="hunter"){let a=null,r=1/0;for(const l of t.creatures.values()){if(l.health<=0||!((l.type==="deer"||l.type==="sheep"||l.type==="boar")&&!l.ownerId))continue;const d=S(e.position,l.position);d<r&&d<12&&(r=d,a=l)}if(a){const l=Math.sign(a.position.x-e.position.x),c=Math.sign(a.position.y-e.position.y);Z(e,l,c,t),S(e.position,a.position)<=1&&To(e,a,n,i,o)}else if(s>e.dutyWanderRadius){const l=Math.sign(n.position.x-e.position.x),c=Math.sign(n.position.y-e.position.y);Z(e,l,c,t)}else if(o.chance(.5)){const l=o.nextInt(-1,1),c=o.nextInt(-1,1);Z(e,l,c,t)}}else if(e.jobType==="guard"||e.jobType==="soldier"){let a=null,r=1/0;for(const l of t.creatures.values()){if(l.health<=0||!(l.type==="bandit"||l.type==="dragon"))continue;const d=S(e.position,l.position),f=l.type==="dragon"?12:8;d<r&&d<f&&(r=d,a=l)}if(a){const l=Math.sign(a.position.x-e.position.x),c=Math.sign(a.position.y-e.position.y);Z(e,l,c,t),S(e.position,a.position)<=1&&Lo(e,a,i,o)}else if(s>e.dutyWanderRadius){const l=Math.sign(n.position.x-e.position.x),c=Math.sign(n.position.y-e.position.y);Z(e,l,c,t)}else if(o.chance(.4)){const l=o.nextInt(-1,1),c=o.nextInt(-1,1);Z(e,l,c,t)}}e.needs.food=Math.max(0,e.needs.food-.3),e.needs.purpose=Math.min(100,e.needs.purpose+2)}function Z(e,t,i,o){const n=e.position.x+t,s=e.position.y+i;if(re({x:n,y:s},o.width,o.height)){const a=o.tiles[s][n];E(a.terrainType)||(e.position.x=n,e.position.y=s)}}function To(e,t,i,o,n){const s=e.stats.strength+e.stats.dexterity+(e.skills.hunting??0)/5,a=Math.max(5,s-t.defense+n.nextInt(-2,3));if(t.health-=a,t.health<=0){for(const l of t.loot)ee(i,l.resourceId,l.quantity,l.quality);S(e.position,o.party.position)<6&&z(o,`${e.name} hunted a ${t.type} near ${i.name}.`,"info",i.id),e.skills.hunting=Math.min(100,(e.skills.hunting??0)+1)}}function Lo(e,t,i,o){const n=e.stats.strength+(e.equippedWeapon?.attack??0)+(e.skills.combat??0)/5,s=e.stats.endurance+(e.equippedArmor?.defense??0),a=Math.max(3,n-t.defense+o.nextInt(-2,3));if(t.health-=a,t.health>0){const r=Math.max(1,t.attack-s+o.nextInt(-2,2));e.health-=r,e.health<=0&&(e.isAlive=!1,e.health=0,S(e.position,i.party.position)<6&&z(i,`${e.name} was killed by a ${t.type}!`,"danger"))}e.isAlive&&(e.skills.combat=Math.min(100,(e.skills.combat??0)+1))}function Do(e,t){const i=e.world;for(const o of i.characters.values()){if(!o.isAlive||e.party.members.some(s=>s.id===o.id))continue;if(o.onDuty){Mo(o,i,e,t);continue}const n=Ai(o,i,Di,t);o.currentAction=n,Ao(o,n),o.needs.food=Math.max(0,o.needs.food-.5),o.needs.social=Math.max(0,o.needs.social-.3),o.needs.purpose=Math.max(0,o.needs.purpose-.2),n.type==="working"&&(o.needs.purpose=Math.min(100,o.needs.purpose+3)),n.type==="socializing"&&(o.needs.social=Math.min(100,o.needs.social+5)),n.type==="resting"&&(o.health=Math.min(o.maxHealth,o.health+5))}}function Ao(e,t,i,o){if(t)switch(t.type){case"traveling":e.turnsUntilArrival>0&&(e.turnsUntilArrival--,e.turnsUntilArrival<=0&&e.destination&&(e.position={...e.destination},e.destination=null));break;case"working":break;case"idle":e.health=Math.min(e.maxHealth,e.health+1);break}}function qo(e,t){const i=e.world;for(const o of i.creatures.values()){if(o.health<=0)continue;const{dx:n,dy:s,behavior:a}=qi(o,i,e.party.position,t);o.behavior=a;const r=o.position.x+n,l=o.position.y+s;if(re({x:r,y:l},i.width,i.height)){const c=i.tiles[l][r];E(c.terrainType)||(o.position.x=r,o.position.y=l)}o.lastActionTurn=e.turn,o.age++}Co(e,t);for(const[o,n]of i.creatures)if(n.health<=0){let s=0,a=0;n.position.x===e.party.position.x&&n.position.y===e.party.position.y&&(s=12,a=6),i.bloodSplashes.push({x:n.position.x,y:n.position.y,offsetX:s,offsetY:a,createdTurn:e.turn,creatureType:n.type}),i.creatures.delete(o)}i.bloodSplashes=i.bloodSplashes.filter(o=>e.turn-o.createdTurn<10)}function Co(e,t){const{party:i,world:o}=e,n=i.members[0];if(!n)return;const s=(n.stats.strength+(n.equippedWeapon?.attack??0))*2,a=n.stats.endurance+(n.equippedArmor?.defense??0);for(const r of o.creatures.values())if(!(r.health<=0)&&r.isHostile&&r.position.x===i.position.x&&r.position.y===i.position.y){const l=r.name??r.type;let c=n.health,d=r.health,f=0,u=0,h=0;for(;c>0&&d>0&&h<20;){h++;const p=Math.max(1,s-r.defense+t.nextInt(-2,2));if(d-=p,f+=p,d>0){const y=Math.max(1,r.attack-a+t.nextInt(-2,2));c-=y,u+=y}}if(r.health=Math.max(0,d),n.health=Math.max(1,c),e.combatAnimation={active:!0,partyPos:{...e.party.position},enemyPos:{...r.position},enemyId:r.id,startTime:Date.now(),duration:h*400,rounds:h},r.health<=0){e.eventLog.push({turn:e.turn,message:`${l} attacked! You defeated it (${h} rounds, dealt ${Math.round(f)} dmg).`,type:"combat",locationId:void 0});for(const p of r.loot){const y=e.party.inventory.find(b=>b.resourceId===p.resourceId&&Math.abs(b.quality-p.quality)<.1);y?y.quantity+=p.quantity:e.party.inventory.push({resourceId:p.resourceId,quantity:p.quantity,quality:p.quality,age:0}),e.eventLog.push({turn:e.turn,message:`Obtained ${(Math.round(p.quantity*10)/10).toFixed(1)} ${p.resourceId}.`,type:"info",locationId:void 0})}n.skills.combat=Math.min(100,(n.skills.combat??0)+3)}else e.eventLog.push({turn:e.turn,message:`${l} attacked! Fought for ${h} rounds — dealt ${Math.round(f)} dmg, took ${Math.round(u)}.`,type:"combat",locationId:void 0}),n.skills.combat=Math.min(100,(n.skills.combat??0)+1)}}function Po(e){const{world:t,party:i}=e,{x:o,y:n}=i.position;for(let s=0;s<t.height;s++)for(let a=0;a<t.width;a++)t.tiles[s][a].visible=!1;for(let s=-te;s<=te;s++)for(let a=-te;a<=te;a++){if(Math.sqrt(a*a+s*s)>te)continue;const l=o+a,c=n+s;l>=0&&l<t.width&&c>=0&&c<t.height&&(t.tiles[c][l].visible=!0,t.tiles[c][l].explored=!0)}}function _o(e,t){const i=ai[e],o=Object.entries(i);return t.weightedPick(o)}function Eo(e){for(const t of e.characters.values())t.isAlive&&(t.age++,t.age>65&&Math.random()<(t.age-65)*.05&&(t.isAlive=!1),t.age>=15&&t.jobType==="child"&&(t.jobType="unemployed"))}function z(e,t,i,o){e.eventLog.push({turn:e.turn,message:t,type:i,locationId:o}),e.eventLog.length>200&&(e.eventLog=e.eventLog.slice(-150))}function We(e){switch(e){case"catastrophic":return"danger";case"major":return"danger";case"moderate":return"info";default:return"info"}}function V(e){return(Math.round(e*10)/10).toFixed(1)}class $o{state;rng;constructor(){this.state=null,this.rng=new x(0)}newGame(t,i){const o={...je,...t};this.rng=new x(o.seed),i?.("Generating world...",0);const n=ii(o,i),s=this.findStartPosition(n),a=J(this.rng,s,null,"adventurer");a.name="The Adventurer",a.stats.strength=8,a.stats.dexterity=7,a.stats.intelligence=6,a.stats.charisma=6,a.stats.endurance=8,a.health=100,a.maxHealth=100,a.gold=50,a.skills.combat=25,a.skills.survival=20,a.skills.trading=10;const r={definitionId:"iron_sword",instanceId:L("item"),name:"Worn Iron Sword",ownerId:a.id,condition:"worn",rarity:"common",enchantments:[],attuned:!1,attunedToId:null,createdBy:null,history:["Found in an old chest."],currentDurability:60,maxDurability:100,type:"weapon",attack:7,defense:0,speed:5,weight:3,value:18};a.equippedWeapon=r,a.inventory.push(r);const l={definitionId:"leather_armor",instanceId:L("item"),name:"Leather Vest",ownerId:a.id,condition:"good",rarity:"common",enchantments:[],attuned:!1,attunedToId:null,createdBy:null,history:[],currentDurability:65,maxDurability:80,type:"armor",attack:0,defense:3,speed:-1,weight:5,value:15};a.equippedArmor=l,a.inventory.push(l);const c={members:[a],position:{...s},inventory:[],gold:50,reputation:{},actionPoints:6,maxActionPoints:6,queuedPath:[],isSailing:!1};this.state={world:n,turn:0,season:"spring",weather:"clear",party:c,activeEvents:[],worldEvents:[],knownEventIds:new Set,eventLog:[{turn:0,message:"Your adventure begins in the world of legends. Explore, trade, and survive!",type:"system"}],gameOver:!1,isPaused:!1,selectedTile:null,viewMode:"world",combatAnimation:null},this.updateVisibility(),this.addLog("You stand at the edge of civilization. The world awaits.","system"),this.describeCurrentLocation()}findStartPosition(t){const i=Array.from(t.locations.values()).filter(s=>s.type==="town"||s.type==="village").sort((s,a)=>a.residentIds.length-s.residentIds.length);if(i.length>0){const s=i[0];for(let a=-2;a<=2;a++)for(let r=-2;r<=2;r++){const l=s.position.x+r,c=s.position.y+a;if(l>=0&&l<t.width&&c>=0&&c<t.height){const d=t.tiles[c][l];if(!E(d.terrainType)&&!d.locationId)return{x:l,y:c}}}return s.position}const o=Math.floor(t.width/2),n=Math.floor(t.height/2);for(let s=0;s<20;s++)for(let a=-s;a<=s;a++)for(let r=-s;r<=s;r++){const l=o+r,c=n+a;if(l>=0&&l<t.width&&c>=0&&c<t.height&&!E(t.tiles[c][l].terrainType))return{x:l,y:c}}return{x:o,y:n}}moveParty(t,i){const{party:o,world:n}=this.state,s=o.position.x+t,a=o.position.y+i;if(!re({x:s,y:a},n.width,n.height))return!1;const r=n.tiles[a][s],l=n.tiles[o.position.y][o.position.x],c=E(r.terrainType),d=r.features.some(b=>b.type==="pier"),f=Math.abs(r.elevation-l.elevation),p=r.roadLevel>0||l.roadLevel>0?3:2;if(f>p)return this.addLog("The terrain is too steep to traverse.","system"),!1;let y;if(o.isSailing)if(c||d)y=1;else if(n.tiles[o.position.y][o.position.x].features.some(I=>I.type==="pier"))o.isSailing=!1,y=Ae(r),this.addLog("You disembark at the pier.","discovery");else return this.addLog("You need a pier to disembark.","system"),!1;else if(c&&!d)if(n.tiles[o.position.y][o.position.x].features.some(I=>I.type==="pier")){if(o.gold<10)return this.addLog("You need 10g to board a boat.","system"),!1;if(o.actionPoints<1)return this.addLog("Not enough action points.","system"),!1;o.gold-=10,o.isSailing=!0,y=1,this.addLog("You board a boat for 10g and set sail.","discovery")}else return this.addLog("The way is blocked by water. Find a pier to board a boat.","system"),!1;else y=d?1:Ae(r);if(o.actionPoints<y)return this.addLog("Not enough action points. End your turn.","system"),!1;console.log(`[moveParty] Consuming ${y} AP (before: ${o.actionPoints})`),o.actionPoints-=y,console.log(`[moveParty] After: ${o.actionPoints} AP`),o.isSailing&&!c&&!d&&(o.isSailing=!1,this.addLog("You disembark.","discovery")),o.position.x=s,o.position.y=a;for(const b of o.members)b.position={...o.position};return this.updateVisibility(),this.describeCurrentLocation(),this.checkEncounters(),!0}movePartyToward(t,i){const{party:o,world:n}=this.state;if(o.position.x===t&&o.position.y===i)return o.queuedPath=[],!1;const s=ke(o.position,{x:t,y:i},n.width,n.height,(a,r,l,c)=>{const d=n.tiles[r][a],f=E(d.terrainType),u=d.features.some(h=>h.type==="pier");if(l!==void 0&&c!==void 0){const h=n.tiles[c][l],p=Math.abs(d.elevation-h.elevation),m=d.roadLevel>0||h.roadLevel>0?3:2;if(p>m)return 1/0}return u?1:f?o.isSailing||l!==void 0&&c!==void 0&&n.tiles[c][l].features.some(y=>y.type==="pier")?1:1/0:he(d)});return s.length<2?(this.addLog("No path to that location.","system"),!1):(o.queuedPath=s.slice(1),!0)}embark(){const{party:t,world:i}=this.state;if(t.isSailing)return this.addLog("You are already sailing.","system"),!1;const{x:o,y:n}=t.position;let s=null;const a=[{dx:0,dy:1},{dx:1,dy:0},{dx:0,dy:-1},{dx:-1,dy:0},{dx:1,dy:1},{dx:-1,dy:-1},{dx:1,dy:-1},{dx:-1,dy:1}];if(i.tiles[n][o].features.some(c=>c.type==="pier")&&(s={x:o,y:n}),!s)for(const c of a){const d=o+c.dx,f=n+c.dy;if(d>=0&&d<i.width&&f>=0&&f<i.height&&i.tiles[f][d].features.some(u=>u.type==="pier")){s={x:d,y:f};break}}if(!s)return this.addLog("No pier nearby to board a boat.","system"),!1;const l=10;if(t.gold<l)return this.addLog(`A boat ride costs ${l}g — you can't afford it.`,"system"),!1;if(t.actionPoints<1)return this.addLog("Not enough action points.","system"),!1;if(t.gold-=l,t.actionPoints-=1,t.isSailing=!0,t.position.x!==s.x||t.position.y!==s.y){t.position={...s};for(const c of t.members)c.position={...s}}return this.addLog(`You board a boat for ${l}g. Right-click water to sail!`,"discovery"),this.updateVisibility(),!0}canEmbark(){if(this.state.party.isSailing)return!1;const{x:t,y:i}=this.state.party.position,o=this.state.world;for(let n=-1;n<=1;n++)for(let s=-1;s<=1;s++){const a=t+s,r=i+n;if(a>=0&&a<o.width&&r>=0&&r<o.height&&o.tiles[r][a].features.some(l=>l.type==="pier"))return!0}return!1}tickPartyMovement(){const{party:t}=this.state;if(t.queuedPath.length===0)return!1;const i=t.queuedPath[0],o=i.x-t.position.x,n=i.y-t.position.y;return this.moveParty(o,n)?(t.queuedPath.shift(),!0):(t.queuedPath=[],!1)}cancelMovement(){this.state.party.queuedPath=[]}endTurn(){console.log(`[endTurn] Before advance: AP = ${this.state.party.actionPoints}`),this.state.party.queuedPath=[],So(this.state),console.log(`[endTurn] After advance: AP = ${this.state.party.actionPoints}`)}rest(){const{party:t,world:i}=this.state,o=1;if(t.actionPoints<o)return this.addLog("Not enough action points to rest.","system"),!1;t.actionPoints-=o;const n=i.tiles[t.position.y]?.[t.position.x],s=n?.locationId?i.locations.get(n.locationId):null;if(!s||s.isDestroyed){for(const l of t.members)l.health=Math.min(l.maxHealth,l.health+5);return this.addLog("You camp in the wilderness. Some health restored.","info"),!0}const a=s.buildings.some(l=>l.type==="tavern"&&l.isOperational),r=a?25:15;for(const l of t.members)l.health=Math.min(l.maxHealth,l.health+r),l.needs.food=Math.min(100,l.needs.food+20),l.needs.shelter=Math.min(100,l.needs.shelter+40);return a?(this.addLog(`You rest at the tavern in ${s.name}. Health and spirits restored!`,"social",s.id),t.gold>=2&&(t.gold-=2)):this.addLog(`You rest in ${s.name}. Health restored.`,"info",s.id),!0}previewBuyFood(){const{party:t,world:i}=this.state;if(t.actionPoints<1)return null;const o=i.tiles[t.position.y]?.[t.position.x];if(!o?.locationId)return null;const n=i.locations.get(o.locationId);if(!n||n.isDestroyed||!n.buildings.some(r=>r.isOperational&&(r.type==="market"||r.type==="tavern"||r.type==="dock")))return null;const a=["bread","meat","fish","berries","wheat","exotic_fruit"];for(const r of a){const l=n.storage.findIndex(c=>c.resourceId===r&&c.quantity>0);if(l>=0){const c=n.storage[l].quantity,d=n.marketPrices[r]??3,f=B[r],u=f?d>=f.baseValue*2:!1;return{foodId:r,price:d,stock:c,locName:n.name,isExpensive:u}}}return null}buyFood(){const{party:t,world:i}=this.state;if(t.actionPoints<1)return this.addLog("Not enough action points.","system"),!1;const o=i.tiles[t.position.y]?.[t.position.x];if(!o?.locationId)return this.addLog("There is nowhere to buy food here.","system"),!1;const n=i.locations.get(o.locationId);if(!n||n.isDestroyed)return!1;if(!n.buildings.some(r=>r.isOperational&&(r.type==="market"||r.type==="tavern"||r.type==="dock")))return this.addLog(`${n.name} has no market or tavern to buy food from.`,"system",n.id),!1;const a=["bread","meat","fish","berries","wheat","exotic_fruit"];for(const r of a){const l=n.storage.findIndex(c=>c.resourceId===r&&c.quantity>0);if(l>=0){const c=n.marketPrices[r]??3;if(t.gold<c)return this.addLog(`Cannot afford ${r} — costs ${c}g.`,"system"),!1;t.actionPoints-=1,t.gold-=c;const d=n.storage[l].quality;n.storage[l].quantity--,n.storage[l].quantity<=0&&n.storage.splice(l,1),this.addToPartyInventory(r,1,d);for(const u of t.members)u.needs.food=Math.min(100,u.needs.food+25);const f=n.storage.find(u=>u.resourceId===r)?.quantity??0;return this.addLog(`Bought ${r} for ${c}g in ${n.name} (${V(f)} left).`,"trade",n.id),!0}}return this.addLog(`${n.name} has no food in stock.`,"system",n.id),!1}canBuyFood(){const t=this.state.world.tiles[this.state.party.position.y]?.[this.state.party.position.x];if(!t?.locationId)return!1;const i=this.state.world.locations.get(t.locationId);return!i||i.isDestroyed?!1:i.buildings.some(o=>o.isOperational&&(o.type==="market"||o.type==="tavern"||o.type==="dock"))}isAtMarket(){const t=this.state.world.tiles[this.state.party.position.y]?.[this.state.party.position.x];if(!t?.locationId)return!1;const i=this.state.world.locations.get(t.locationId);return!i||i.isDestroyed?!1:i.buildings.some(o=>o.isOperational&&o.type==="market")}canHunt(){const{party:t,world:i}=this.state;if(t.actionPoints<2)return!1;for(const o of i.creatures.values())if(o.position.x===t.position.x&&o.position.y===t.position.y&&["deer","sheep","boar","wolf","bear"].includes(o.type))return o.health>0;return!1}hunt(){const{party:t,world:i}=this.state,o=t.members[0];if(!o)return!1;if(t.actionPoints<2)return this.addLog("Not enough action points to hunt.","system"),!1;let n=null;const s=["deer","sheep","boar","wolf","bear"];for(const f of i.creatures.values())if(f.position.x===t.position.x&&f.position.y===t.position.y&&s.includes(f.type)&&f.health>0){n=f;break}if(!n)return this.addLog("No wild game to hunt here.","system"),!1;t.actionPoints-=2;const a=n.name??n.type,r=o.skills.hunting??0,l=o.stats.strength+(o.equippedWeapon?.attack??0)+r/10;let c=0,d=0;for(;n.health>0&&c<10;){c++;const f=Math.max(1,Math.floor(l-n.defense/2+Math.random()*3));if(n.health-=f,n.health>0&&Math.random()<.3){const u=Math.max(1,Math.floor(n.attack/3+Math.random()*2));o.health-=u,d+=u}}if(this.state.combatAnimation={active:!0,partyPos:{...t.position},enemyPos:{...n.position},enemyId:n.id,startTime:Date.now(),duration:c*300,rounds:c},n.health<=0){for(const f of n.loot)this.addToPartyInventory(f.resourceId,f.quantity,f.quality),this.addLog(`Hunted ${a}! Obtained ${V(f.quantity)} ${f.resourceId}.`,"info");o.skills.hunting=Math.min(100,(o.skills.hunting??0)+2),d>0&&this.addLog(`Hunt successful (took ${Math.round(d)} dmg).`,"info")}else{const u=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:-1},{dx:-1,dy:1},{dx:1,dy:-1},{dx:1,dy:1}].sort(()=>Math.random()-.5);for(const h of u){const p=n.position.x+h.dx,y=n.position.y+h.dy;if(p>=0&&p<i.width&&y>=0&&y<i.height){const b=i.tiles[y][p];if(b.terrainType!=="shallow_ocean"&&b.terrainType!=="deep_ocean")return n.position.x=p,n.position.y=y,this.addLog(`Hunt failed - ${a} escaped to nearby cover!`,"info"),!0}}this.addLog(`Hunt failed - ${a} escaped!`,"info")}return!0}addToPartyInventory(t,i,o){const{party:n}=this.state,s=n.inventory.find(a=>a.resourceId===t&&Math.abs(a.quality-o)<.1);s?s.quantity+=i:n.inventory.push({resourceId:t,quantity:i,quality:o,age:0})}canSell(){const t=this.state.world.tiles[this.state.party.position.y]?.[this.state.party.position.x];if(!t?.locationId)return!1;const i=this.state.world.locations.get(t.locationId);return!i||i.isDestroyed?!1:i.buildings.some(o=>o.isOperational&&o.type==="market")&&this.state.party.inventory.length>0}buyMarketItem(t,i){const{party:o,world:n}=this.state,s=n.tiles[o.position.y]?.[o.position.x];if(!s?.locationId)return this.addLog("No settlement here.","system"),!1;const a=n.locations.get(s.locationId);if(!a||a.isDestroyed)return this.addLog("This settlement is destroyed.","system"),!1;if(!a.buildings.some(u=>u.isOperational&&u.type==="market"))return this.addLog("No marketplace here.","system"),!1;if(i<0||i>=a.storage.length)return this.addLog("Item no longer available.","system"),!1;const l=a.storage[i];if(l.quantity<=0)return this.addLog("Out of stock.","system"),!1;const c=a.marketPrices[t]??3,d=Math.floor(c*l.quality);if(o.gold<d)return this.addLog(`Cannot afford ${t} — costs ${d}g.`,"system"),!1;if(o.gold-=d,l.quantity-=1,l.quantity<=0&&a.storage.splice(i,1),this.addToPartyInventory(t,1,l.quality),this.addLog(`Bought 1 ${t} for ${d}g.`,"trade",a.id),["bread","meat","fish","berries","wheat","exotic_fruit"].includes(t))for(const u of o.members)u.needs.food=Math.min(100,u.needs.food+25);return!0}sellInventoryItem(t){const{party:i,world:o}=this.state;if(t<0||t>=i.inventory.length)return this.addLog("Invalid item.","system"),!1;const n=o.tiles[i.position.y]?.[i.position.x];if(!n?.locationId)return this.addLog("No settlement here to sell at.","system"),!1;const s=o.locations.get(n.locationId);if(!s||s.isDestroyed)return this.addLog("This settlement is destroyed.","system"),!1;if(!s.buildings.some(u=>u.isOperational&&u.type==="market"))return this.addLog("No marketplace here.","system"),!1;const r=i.inventory[t],l=B[r.resourceId];if(!l)return!1;const c=s.marketPrices[r.resourceId]??l.baseValue,d=Math.floor(r.quantity*c*r.quality);i.gold+=d,this.addLog(`Sold ${V(r.quantity)} ${r.resourceId} for ${d}g.`,"trade",s.id);const f=s.storage.find(u=>u.resourceId===r.resourceId&&Math.abs(u.quality-r.quality)<.1);return f?f.quantity+=r.quantity:s.storage.push({resourceId:r.resourceId,quantity:r.quantity,quality:r.quality,age:0}),i.inventory.splice(t,1),!0}sellInventory(){const{party:t,world:i}=this.state,o=i.tiles[t.position.y]?.[t.position.x];if(!o?.locationId)return!1;const n=i.locations.get(o.locationId);if(!n||n.isDestroyed)return!1;if(!n.buildings.some(r=>r.isOperational&&r.type==="market"))return this.addLog("No marketplace here.","system"),!1;if(t.inventory.length===0)return this.addLog("Nothing to sell.","system"),!1;t.actionPoints-=1;let a=0;for(const r of t.inventory){const l=B[r.resourceId];if(l){const c=n.marketPrices[r.resourceId]??l.baseValue,d=Math.floor(r.quantity*c*r.quality);a+=d,this.addLog(`Sold ${V(r.quantity)} ${r.resourceId} for ${d}g.`,"trade",n.id);const f=n.storage.find(u=>u.resourceId===r.resourceId&&Math.abs(u.quality-r.quality)<.1);f?f.quantity+=r.quantity:n.storage.push({resourceId:r.resourceId,quantity:r.quantity,quality:r.quality,age:0})}}return t.gold+=a,t.inventory=[],this.addLog(`Total earned: ${a}g.`,"trade",n.id),!0}isAtSettlement(){const t=this.state.world.tiles[this.state.party.position.y]?.[this.state.party.position.x];if(!t?.locationId)return!1;const i=this.state.world.locations.get(t.locationId);return!!i&&!i.isDestroyed}getCurrentLocation(){const{party:t,world:i}=this.state,o=i.tiles[t.position.y]?.[t.position.x];return o?.locationId?i.locations.get(o.locationId)??null:null}checkEncounters(){const{party:t,world:i}=this.state,o=t.position;for(const n of i.creatures.values())n.position.x===o.x&&n.position.y===o.y&&(n.isHostile?(this.addLog(`You encounter hostile ${n.name??n.type}!`,"combat"),this.initiateCombat(n)):this.addLog(`You spot a group of ${n.type} nearby.`,"info"))}initiateCombat(t){const i=this.state.party,o=i.members[0];if(!o)return;const n=t.name??t.type;let s=o.health,a=t.health;const r=(o.stats.strength+(o.equippedWeapon?.attack??0))*2,l=o.stats.endurance+(o.equippedArmor?.defense??0),c=t.attack,d=t.defense;let f=0,u=0,h=0;for(;s>0&&a>0&&h<20;){h++;const p=Math.max(1,r-d+Math.floor(Math.random()*4)-2);if(a-=p,f+=p,a>0){const y=Math.max(1,c-l+Math.floor(Math.random()*4)-2);s-=y,u+=y}}if(this.state.combatAnimation={active:!0,partyPos:{...i.position},enemyPos:{...t.position},enemyId:t.id,startTime:Date.now(),duration:h*400,rounds:h},t.health=Math.max(0,a),o.health=Math.max(1,s),t.health<=0){this.addLog(`You defeated ${n}! (${h} rounds, dealt ${Math.round(f)} dmg)`,"combat");for(const p of t.loot)this.addToPartyInventory(p.resourceId,p.quantity,p.quality),this.addLog(`Obtained ${V(p.quantity)} ${p.resourceId}.`,"info");o.skills.combat=Math.min(100,(o.skills.combat??0)+3)}else this.addLog(`Fought ${n} for ${h} rounds — dealt ${Math.round(f)} dmg, took ${Math.round(u)}. ${n} has ${Math.round(t.health)}/${t.maxHealth} HP left.`,"combat"),o.skills.combat=Math.min(100,(o.skills.combat??0)+1)}describeCurrentLocation(){const{party:t,world:i}=this.state,o=i.tiles[t.position.y][t.position.x];if(o.locationId){const n=i.locations.get(o.locationId);if(n){if(this.addLog(`You arrive at ${n.name} (${n.type}).`,"discovery",n.id),n.countryId){const s=i.countries.get(n.countryId);s&&this.addLog(`This land belongs to the ${s.name}.`,"info",n.id)}Fi(this.state)}}o.resourceDeposit&&this.addLog(`You notice deposits of ${o.resourceDeposit.resourceId} here.`,"discovery")}updateVisibility(){const{world:t,party:i}=this.state,o=6;for(let n=0;n<t.height;n++)for(let s=0;s<t.width;s++)t.tiles[n][s].visible=!1;for(let n=-o;n<=o;n++)for(let s=-o;s<=o;s++){if(s*s+n*n>o*o)continue;const a=i.position.x+s,r=i.position.y+n;a>=0&&a<t.width&&r>=0&&r<t.height&&(t.tiles[r][a].visible=!0,t.tiles[r][a].explored=!0)}}getTileInfo(t,i){const{world:o}=this.state;if(!re({x:t,y:i},o.width,o.height))return[];const n=o.tiles[i][t],s=[],a=oe[n.biome];if(s.push(`${a?.name??n.biome} (${t}, ${i})`),s.push(`Elevation: Level ${n.elevation} (${n.terrainType})`),n.resourceDeposit&&s.push(`Resource: ${n.resourceDeposit.resourceId} (${V(n.resourceDeposit.amount)})`),n.locationId){const r=o.locations.get(n.locationId);if(r){if(s.push(`${r.name} — ${r.type}`),s.push(`Population: ${r.residentIds.length}`),s.push(`Durability: ${Math.round(r.durability)}/100`),s.push(`Prosperity: ${Math.round(r.prosperity)}`),s.push(`Safety: ${Math.round(r.safety)}`),r.countryId){const d=o.countries.get(r.countryId);d&&s.push(`Country: ${d.name}`)}const l=r.storage.filter(d=>d.quantity>0),c=l.sort((d,f)=>f.quantity-d.quantity).slice(0,4);if(c.length>0){s.push("Stock:");for(const f of c){const u=r.marketPrices[f.resourceId]??"?";s.push(`  ${f.resourceId}: ${V(f.quantity)} (${u}g)`)}const d=l.length-c.length;d>0&&s.push(`  ...and ${d} more item${d===1?"":"s"}`)}}}if(!n.locationId)for(const r of o.locations.values()){if(r.isDestroyed)continue;const l=Math.abs(r.position.x-t),c=Math.abs(r.position.y-i);if(l>1||c>1||l===0&&c===0)continue;const d=r.buildings.some(h=>h.type==="farm_field"&&h.isOperational),f=r.buildings.some(h=>h.type==="mine_shaft"&&h.isOperational),u=r.buildings.some(h=>(h.type==="sawmill"||h.type==="hunter_lodge")&&h.isOperational);d&&(n.biome==="grassland"||n.biome==="savanna"||n.biome==="forest")?s.push(`Wheat fields (${r.name})`):f&&(n.biome==="hills"||n.biome==="mountain")?s.push(`Mine workings (${r.name})`):u&&(n.biome==="forest"||n.biome==="dense_forest")&&s.push(`Lumber site (${r.name})`)}if(n.visible){for(const r of o.characters.values())if(r.position.x===t&&r.position.y===i&&r.isAlive){if(this.state.party.members.some(c=>c.id===r.id))continue;const l=r.jobType.charAt(0).toUpperCase()+r.jobType.slice(1);if(s.push(`${r.name} (${l})`),s.push(`  HP: ${Math.round(r.health)}/${r.maxHealth}`),r.currentAction){const c=r.currentAction.type;s.push(`  Activity: ${c}`)}(r.jobType==="guard"||r.jobType==="soldier")&&r.onDuty&&s.push("  On patrol")}}if(n.visible){for(const r of o.creatures.values())if(r.position.x===t&&r.position.y===i&&r.health>0){const l=r.name??r.type,c=r.isHostile?" (hostile)":"";if(s.push(`Creature: ${l}${c}`),s.push(`  HP: ${Math.round(r.health)}/${r.maxHealth}`),r.type==="trader"&&r.loot.length>0){s.push("  Carrying:");for(const d of r.loot)s.push(`    ${d.resourceId}: ${V(d.quantity)}`)}}}if(n.roadLevel>0){const r=["","Path","Road","Highway"];s.push(`Road: ${r[n.roadLevel]}`)}return n.features.some(r=>r.type==="pier")&&s.push("Pier — step onto water to board a boat (10g)"),s}getDateString(){const t=si(this.state.turn),i=this.state.season;return`Year ${t}, ${i.charAt(0).toUpperCase()+i.slice(1)} — Day ${this.state.turn%90+1}`}addLog(t,i,o){this.state.eventLog.push({turn:this.state.turn,message:t,type:i,locationId:o}),this.state.eventLog.length>200&&(this.state.eventLog=this.state.eventLog.slice(-150))}}const Be=new Map;function Ho(e,t,i,o=null){const n=`${e}_${t}_${i??"none"}_${o??""}`,s=Be.get(n);if(s)return s;const a=Wo(e,t,i,o);return Be.set(n,a),a}function Wo(e,t,i,o=null){const n=new OffscreenCanvas(48,48),s=n.getContext("2d");switch(e){case"homestead":W(s,24,36);break;case"hamlet":W(s,18,36),W(s,30,36);break;case"village":Q(s,16,36),Q(s,30,36),W(s,24,30);break;case"town":Ve(s);break;case"city":Bo(s);break;case"castle":Oo(s);break;case"mine":No(s);break;case"farm":zo(s);break;case"lumber_camp":Fo(s);break;case"fishing_village":Yo(s);break;case"port":jo(s);break;case"dungeon":Xo(s);break;case"ruins":Go(s,o);break;case"dragon_lair":en(s);break;case"bandit_camp":tn(s);break;case"monastery":on(s);break;default:W(s,24,36)}return i&&["town","city","castle","port","village","hamlet","homestead","fishing_village"].includes(e)&&nn(s,10,8,i),n}function W(e,t,i){e.fillStyle=g.woodWall,e.fillRect(t-4,i-6,8,6),e.fillStyle=g.woodWallDark,e.fillRect(t-4,i-6,2,6),e.fillStyle=g.roofBrown,e.fillRect(t-5,i-9,10,3),e.fillRect(t-4,i-10,8,1),e.fillStyle="#f0e0a0",e.fillRect(t,i-5,2,2)}function Q(e,t,i){e.fillStyle=g.woodWall,e.fillRect(t-5,i-8,10,8),e.fillStyle=g.woodWallDark,e.fillRect(t-5,i-8,2,8),e.fillStyle=g.roofRed,e.fillRect(t-6,i-11,12,3),e.fillRect(t-5,i-12,10,1),e.fillStyle="#f0e0a0",e.fillRect(t-2,i-6,2,2),e.fillRect(t+1,i-6,2,2),e.fillStyle=g.woodWallDark,e.fillRect(t-1,i-3,3,3)}function Ve(e,t){e.fillStyle=g.stoneWall,e.fillRect(22,6,5,8),e.fillStyle=g.roofRed,e.fillRect(21,4,7,3),e.fillRect(22,3,5,1),e.fillStyle=g.stoneWall,e.fillRect(18,18,12,16),e.fillStyle=g.stoneWallDark,e.fillRect(18,18,3,16),e.fillStyle=g.roofRedDark,e.fillRect(17,14,14,4),e.fillRect(18,12,12,2),Q(e,12,40),Q(e,28,40),Q(e,36,40)}function Bo(e,t){Ve(e),W(e,6,40),W(e,42,40),e.fillStyle=g.stoneWallDark,e.fillRect(2,34,2,8),e.fillRect(44,34,2,8),e.fillRect(2,42,44,2)}function Oo(e,t){e.fillStyle=g.stoneWall,e.fillRect(8,20,32,20),e.fillStyle=g.stoneWallDark,e.fillRect(8,20,4,20),e.fillStyle=g.stoneWall,e.fillRect(6,10,8,14),e.fillStyle=g.stoneWallDark,e.fillRect(6,10,2,14),e.fillRect(6,8,2,3),e.fillRect(10,8,2,3),e.fillStyle=g.stoneWall,e.fillRect(34,10,8,14),e.fillStyle=g.stoneWallDark,e.fillRect(34,10,2,14),e.fillRect(34,8,2,3),e.fillRect(38,8,2,3),e.fillStyle=g.stoneWallLight,e.fillRect(18,8,12,18),e.fillStyle=g.stoneWallDark,e.fillRect(18,8,3,18),e.fillStyle=g.roofRed,e.fillRect(17,4,14,4),e.fillRect(19,2,10,2),e.fillStyle="#2a2a2a",e.fillRect(21,32,6,8),e.fillStyle="#3a3a3a",e.fillRect(22,32,4,7)}function No(e){e.fillStyle="#3a3a3a",e.fillRect(16,28,16,12),e.fillStyle=g.woodWall,e.fillRect(15,26,18,3),e.fillRect(15,26,3,14),e.fillRect(30,26,3,14),e.fillStyle=g.woodWallDark,e.fillRect(20,38,8,2),W(e,36,36)}function zo(e){W(e,12,30),e.fillStyle="#a08840",e.fillRect(22,28,20,12),e.fillStyle="#60a030";for(let t=0;t<4;t++)e.fillRect(24,29+t*3,16,1)}function Fo(e){W(e,24,36),e.fillStyle=g.woodWallDark,e.fillRect(8,34,10,3),e.fillRect(9,32,8,2),e.fillStyle="#6c5028",e.fillRect(36,36,4,3)}function Yo(e){W(e,16,32),W(e,30,32),e.fillStyle=g.woodWall,e.fillRect(20,36,12,2),e.fillRect(24,38,4,6)}function jo(e,t){Q(e,16,34),Q(e,32,34),e.fillStyle=g.woodWall,e.fillRect(10,38,28,3),e.fillRect(18,41,4,5),e.fillRect(30,41,4,5),e.fillStyle=g.stoneWall,e.fillRect(22,24,10,8),e.fillStyle=g.roofBrown,e.fillRect(21,22,12,3)}function Xo(e){e.fillStyle="#2a2a3a",e.fillRect(18,30,12,10),e.fillStyle="#4a4a5a",e.fillRect(17,28,14,3),e.fillStyle="#e0d0b0",e.fillRect(22,34,4,3),e.fillRect(23,33,2,1)}function Go(e,t){switch(t){case"city":case"town":Vo(e);break;case"castle":Uo(e);break;case"village":case"hamlet":Qo(e);break;case"farm":Ko(e);break;case"mine":Zo(e);break;case"fishing_village":case"port":Jo(e);break;default:xo(e);break}}function Vo(e){e.fillStyle=g.stoneWallDark,e.fillRect(18,18,8,14),e.fillStyle="#5a5a5a",e.fillRect(18,18,3,10),e.fillRect(19,14,3,4),e.fillRect(23,16,2,2),e.fillRect(8,30,4,8),e.fillRect(34,28,5,10),e.fillRect(28,34,3,4),e.fillStyle="#4a4a4a",e.fillRect(8,38,32,2),e.fillStyle="#8a8070",e.fillRect(12,34,5,3),e.fillRect(24,35,6,2),e.fillRect(30,32,4,3),e.fillStyle="#3a2a1a",e.fillRect(14,32,3,2),e.fillRect(26,33,4,1)}function Uo(e){e.fillStyle=g.stoneWallDark,e.fillRect(6,16,8,14),e.fillStyle="#5a5a5a",e.fillRect(6,16,2,10),e.fillRect(6,14,2,3),e.fillRect(36,22,6,8),e.fillRect(37,20,3,2),e.fillRect(14,26,20,3),e.fillStyle="#4a4a4a",e.fillRect(14,29,20,2),e.fillStyle="#6a6a6a",e.fillRect(20,18,8,10),e.fillStyle="#5a5a5a",e.fillRect(20,14,6,4),e.fillStyle="#8a8070",e.fillRect(10,30,8,4),e.fillRect(28,28,6,4),e.fillStyle="#3a3a3a",e.fillRect(22,32,4,6)}function Qo(e){e.fillStyle=g.woodWallDark,e.fillRect(10,32,6,4),e.fillRect(12,30,3,2),e.fillRect(28,30,8,5),e.fillRect(30,28,4,2),e.fillStyle="#3a2a1a",e.fillRect(9,30,8,2),e.fillRect(27,28,10,2),e.fillStyle="#6a5028",e.fillRect(18,34,6,1),e.fillRect(20,36,4,1),e.fillStyle="#8a8070",e.fillRect(14,35,4,2),e.fillRect(22,33,3,2)}function Ko(e){e.fillStyle=g.woodWallDark,e.fillRect(14,30,8,5),e.fillRect(16,28,4,2),e.fillStyle="#3a2a1a",e.fillRect(13,28,10,2),e.fillStyle="#8a7a40",e.fillRect(26,32,12,6),e.fillStyle="#6a5a30";for(let t=0;t<3;t++)e.fillRect(28+t*3,33+t,4,1)}function Zo(e){e.fillStyle="#2a2a2a",e.fillRect(18,30,12,8),e.fillStyle=g.woodWallDark,e.fillRect(16,28,3,6),e.fillRect(29,28,3,4),e.fillRect(17,27,14,2),e.fillStyle="#7a6a5a",e.fillRect(20,36,8,3),e.fillRect(22,34,4,2)}function Jo(e){e.fillStyle=g.woodWallDark,e.fillRect(14,38,3,5),e.fillRect(22,38,3,5),e.fillRect(30,38,3,5),e.fillStyle="#5a4020",e.fillRect(12,36,24,2),e.fillStyle=g.stoneWallDark,e.fillRect(16,28,10,6),e.fillRect(18,26,6,2),e.fillStyle="#8a8070",e.fillRect(12,34,6,2),e.fillRect(28,32,4,3)}function xo(e){e.fillStyle=g.stoneWallDark,e.fillRect(16,32,4,6),e.fillRect(28,30,3,8),e.fillStyle="#4a4a4a",e.fillRect(14,38,20,2),e.fillStyle="#8a8070",e.fillRect(18,35,5,2),e.fillRect(24,36,3,2),e.fillStyle="#3a2a1a",e.fillRect(20,34,3,1)}function en(e){e.fillStyle="#2a2a2a",e.fillRect(14,24,20,16),e.fillStyle=g.rockDark,e.fillRect(12,22,24,4),e.fillRect(14,20,20,3),e.fillStyle=g.clothGold,e.fillRect(20,36,2,2),e.fillRect(26,35,3,2),e.fillStyle=g.fireOrange,e.fillRect(22,30,4,2),e.fillStyle=g.fireYellow,e.fillRect(23,29,2,1)}function tn(e){e.fillStyle="#7c6c4c",e.fillRect(12,28,10,8),e.fillRect(11,26,12,3),e.fillRect(28,30,8,6),e.fillRect(27,28,10,3),e.fillStyle=g.fireOrange,e.fillRect(22,34,3,2),e.fillStyle=g.fireYellow,e.fillRect(23,33,1,1)}function on(e){e.fillStyle=g.stoneWallLight,e.fillRect(14,18,20,20),e.fillStyle=g.stoneWallDark,e.fillRect(14,18,4,20),e.fillStyle=g.roofBlue,e.fillRect(13,14,22,4),e.fillRect(15,12,18,2),e.fillStyle=g.stoneWallLight,e.fillRect(21,4,6,10),e.fillStyle=g.roofBlue,e.fillRect(20,2,8,3),e.fillStyle=g.clothGold,e.fillRect(23,0,2,3),e.fillRect(22,1,4,1)}function nn(e,t,i,o){e.fillStyle=g.woodWallDark,e.fillRect(t,i,1,10),e.fillStyle=o,e.fillRect(t+1,i,6,4),e.fillRect(t+1,i+4,5,1)}const fe=new Map;function sn(){const e="party",t=fe.get(e);if(t)return t;const i=new OffscreenCanvas(16,24),o=i.getContext("2d");return an(o,8,20),fe.set(e,i),i}function Oe(e){const t=`creature_${e}`,i=fe.get(t);if(i)return i;const o=new OffscreenCanvas(16,20),n=o.getContext("2d");switch(e){case"wolf":ln(n,8,16);break;case"bear":rn(n,8,16);break;case"deer":cn(n,8,16);break;case"sheep":dn(n,8,16);break;case"boar":fn(n,8,16);break;case"dragon":un(n,8,12);break;case"bandit":hn(n,8,16);break;case"guard":gn(n,8,16);break;case"army":bn(n,8,16);break;case"trader":pn(n,8,16);break;case"hunter":mn(n,8,16);break;case"builder":yn(n,8,16);break}return fe.set(t,o),o}function an(e,t,i){e.fillStyle=g.clothBrown,e.fillRect(t-2,i-4,2,4),e.fillRect(t+1,i-4,2,4),e.fillStyle=g.clothBlue,e.fillRect(t-3,i-9,7,5),e.fillRect(t-4,i-8,1,4),e.fillRect(t+4,i-8,1,4),e.fillStyle=g.skinLight,e.fillRect(t-2,i-13,5,4),e.fillStyle=g.hairBrown,e.fillRect(t-2,i-14,5,2),e.fillStyle="#2a2a2a",e.fillRect(t-1,i-12,1,1),e.fillRect(t+1,i-12,1,1),e.fillStyle="#a0a0a0",e.fillRect(t+4,i-14,1,8),e.fillStyle=g.clothGold,e.fillRect(t+3,i-7,3,1),e.fillStyle=g.clothRed,e.fillRect(t-3,i-9,2,6)}function ln(e,t,i){e.fillStyle="#6a6a6a",e.fillRect(t-4,i-4,8,3),e.fillRect(t+3,i-6,4,3),e.fillRect(t+4,i-7,1,1),e.fillRect(t+6,i-7,1,1),e.fillRect(t-3,i-1,1,2),e.fillRect(t-1,i-1,1,2),e.fillRect(t+2,i-1,1,2),e.fillRect(t+4,i-1,1,2),e.fillRect(t-5,i-5,2,1),e.fillStyle="#ffcc00",e.fillRect(t+5,i-5,1,1)}function rn(e,t,i){e.fillStyle="#5a3a1a",e.fillRect(t-5,i-5,10,4),e.fillRect(t+4,i-7,4,4),e.fillRect(t+4,i-8,1,1),e.fillRect(t+7,i-8,1,1),e.fillRect(t-4,i-1,2,2),e.fillRect(t+1,i-1,2,2),e.fillStyle="#1a1a1a",e.fillRect(t+6,i-6,1,1)}function cn(e,t,i){e.fillStyle="#a07040",e.fillRect(t-4,i-5,8,3),e.fillRect(t+3,i-8,3,3),e.fillStyle="#7c6c4c",e.fillRect(t+3,i-10,1,2),e.fillRect(t+5,i-10,1,2),e.fillRect(t+2,i-10,1,1),e.fillRect(t+6,i-10,1,1),e.fillStyle="#a07040",e.fillRect(t-3,i-2,1,3),e.fillRect(t-1,i-2,1,3),e.fillRect(t+2,i-2,1,3),e.fillRect(t+4,i-2,1,3),e.fillStyle="#1a1a1a",e.fillRect(t+4,i-7,1,1)}function dn(e,t,i){e.fillStyle="#e0d8c8",e.fillRect(t-3,i-5,7,4),e.fillRect(t-2,i-6,5,1),e.fillStyle="#2a2a2a",e.fillRect(t+3,i-5,2,2),e.fillStyle="#3a3a3a",e.fillRect(t-2,i-1,1,2),e.fillRect(t+1,i-1,1,2)}function fn(e,t,i){e.fillStyle="#5a4030",e.fillRect(t-4,i-4,8,3),e.fillRect(t+3,i-5,3,3),e.fillStyle="#e0d0b0",e.fillRect(t+6,i-4,1,1),e.fillStyle="#3a2a1a",e.fillRect(t-3,i-1,1,2),e.fillRect(t+2,i-1,1,2)}function un(e,t,i){e.fillStyle="#8a2020",e.fillRect(t-7,i-6,5,3),e.fillRect(t+3,i-6,5,3),e.fillRect(t-6,i-8,3,2),e.fillRect(t+4,i-8,3,2),e.fillStyle="#c44444",e.fillRect(t-4,i-3,9,4),e.fillRect(t+4,i-5,4,3),e.fillRect(t-6,i-2,3,2),e.fillRect(t-7,i-1,2,1),e.fillStyle="#ffcc00",e.fillRect(t+6,i-4,1,1),e.fillStyle=g.fireOrange,e.fillRect(t+8,i-4,2,1),e.fillStyle=g.fireYellow,e.fillRect(t+8,i-5,1,1),e.fillStyle="#3a1a1a",e.fillRect(t+4,i-6,1,1),e.fillRect(t+6,i-6,1,1),e.fillStyle="#a03030",e.fillRect(t-2,i+1,2,2),e.fillRect(t+2,i+1,2,2)}function hn(e,t,i){e.fillStyle="#3a3a2a",e.fillRect(t-2,i-4,2,4),e.fillRect(t+1,i-4,2,4),e.fillStyle="#4a3a2a",e.fillRect(t-3,i-9,7,5),e.fillStyle=g.skinMedium,e.fillRect(t-2,i-12,5,3),e.fillStyle="#2a2a1a",e.fillRect(t-2,i-13,5,2),e.fillRect(t-3,i-12,1,2),e.fillStyle="#1a1a1a",e.fillRect(t-1,i-10,3,1),e.fillStyle="#a0a0a0",e.fillRect(t+4,i-10,1,6)}function pn(e,t,i){e.fillStyle="#8a7a6a",e.fillRect(t-5,i-3,7,3),e.fillRect(t-6,i-5,3,2),e.fillStyle="#6a5a4a",e.fillRect(t-4,i,1,2),e.fillRect(t,i,1,2),e.fillStyle="#7a5a30",e.fillRect(t-4,i-6,6,3),e.fillStyle="#8a6a40",e.fillRect(t-3,i-7,4,1),e.fillStyle=g.clothBrown,e.fillRect(t+3,i-8,5,4),e.fillStyle=g.skinLight,e.fillRect(t+4,i-10,3,2),e.fillStyle=g.hairBrown,e.fillRect(t+4,i-11,3,1),e.fillStyle=g.clothBrown,e.fillRect(t+4,i-4,1,3),e.fillRect(t+6,i-4,1,3)}function mn(e,t,i){e.fillStyle="#6a5a4a",e.fillRect(t-2,i-4,2,4),e.fillRect(t+1,i-4,2,4),e.fillStyle="#8a6a4a",e.fillRect(t-3,i-9,7,5),e.fillStyle=g.skinPale,e.fillRect(t-4,i-8,1,3),e.fillRect(t+4,i-8,1,3),e.fillStyle=g.skinPale,e.fillRect(t-1,i-13,3,3),e.fillStyle="#6a4a2a",e.fillRect(t-1,i-14,3,2),e.fillStyle="#5a4a3a",e.fillRect(t-5,i-10,1,5),e.fillStyle="#d0d0d0",e.fillRect(t-5,i-10,1,1),e.fillRect(t-5,i-6,1,1),e.fillStyle="#7a5a3a",e.fillRect(t+2,i-11,2,4)}function yn(e,t,i){e.fillStyle=g.skinTan,e.fillRect(t-3,i-2,2,3),e.fillRect(t+1,i-2,2,3),e.fillStyle="#8b7355",e.fillRect(t-3,i-7,6,5),e.fillStyle=g.skinLight,e.fillRect(t-2,i-10,4,3),e.fillStyle="#654321",e.fillRect(t-2,i-12,4,2),e.fillStyle=g.skinTan,e.fillRect(t-4,i-7,1,3),e.fillRect(t+3,i-7,1,3),e.fillStyle="#a0a0a0",e.fillRect(t+3,i-9,3,2),e.fillStyle="#654321",e.fillRect(t+4,i-7,1,3)}function gn(e,t,i){e.fillStyle="#3a3a4a",e.fillRect(t-2,i-4,2,4),e.fillRect(t+1,i-4,2,4),e.fillStyle="#8888a0",e.fillRect(t-3,i-9,7,5),e.fillStyle="#707088",e.fillRect(t-3,i-9,2,5),e.fillStyle=g.skinLight,e.fillRect(t-2,i-12,5,3),e.fillStyle="#7a5a30",e.fillRect(t+4,i-16,1,12),e.fillStyle="#c0c0c0",e.fillRect(t+3,i-17,3,2),e.fillStyle="#4444a0",e.fillRect(t-4,i-9,2,4),e.fillStyle="#333880",e.fillRect(t-4,i-8,2,2)}function bn(e,t,i){for(let o=-1;o<=1;o++){const n=o*3,s=Math.abs(o);e.fillStyle="#3a3a4a",e.fillRect(t+n-1,i-3+s,1,3),e.fillRect(t+n+1,i-3+s,1,3),e.fillStyle="#707088",e.fillRect(t+n-2,i-7+s,5,4),e.fillStyle=g.skinLight,e.fillRect(t+n-1,i-9+s,3,2),e.fillStyle="#7a5a30",e.fillRect(t+n+2,i-12+s,1,8)}e.fillStyle="#7a5a30",e.fillRect(t-2,i-15,1,12)}class In{canvas;ctx;camera;animationTime=0;minimapCanvas=null;minimapDirty=!0;currentState=null;constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.camera=new fo(t.width,t.height),this.ctx.imageSmoothingEnabled=!1}resize(){const t=window.devicePixelRatio||1,i=this.canvas.parentElement;this.canvas.width=i.clientWidth*t,this.canvas.height=i.clientHeight*t,this.canvas.style.width=`${i.clientWidth}px`,this.canvas.style.height=`${i.clientHeight}px`,this.ctx.setTransform(t,0,0,t,0,0),this.ctx.imageSmoothingEnabled=!1,this.camera.resize(i.clientWidth,i.clientHeight)}render(t,i){this.currentState=t,this.animationTime+=i,this.camera.update();const o=this.ctx,{world:n,party:s,season:a}=t;o.fillStyle=g.deepWater,o.fillRect(0,0,this.camera.screenWidth,this.camera.screenHeight),o.save(),o.translate(this.camera.screenWidth/2-this.camera.x*this.camera.zoom,this.camera.screenHeight/2-this.camera.y*this.camera.zoom),o.scale(this.camera.zoom,this.camera.zoom);const r=this.camera.getVisibleRange(n.width,n.height);for(let y=r.minY;y<=r.maxY;y++)for(let b=r.minX;b<=r.maxX;b++)this.renderTileLayer(o,n.tiles[y][b],a,"ground");for(let y=r.minY;y<=r.maxY;y++)for(let b=r.minX;b<=r.maxX;b++){const m=n.tiles[y][b];if(!m.explored)continue;const{x:I,y:v}=P(b,y,D,q),w=m.elevation*C;m.roadLevel>0&&this.renderRoad(o,m,I,v-w,n),m.features.some(R=>R.type==="pier")&&this.renderPier(o,I,v-w)}this.renderWorkingSites(o,n,r);for(let y=r.minY;y<=r.maxY;y++)for(let b=r.minX;b<=r.maxX;b++)this.renderTileLayer(o,n.tiles[y][b],a,"vegetation");for(let y=r.minY;y<=r.maxY;y++)for(let b=r.minX;b<=r.maxX;b++){const m=n.tiles[y][b];if(m.locationId&&m.explored){const I=n.locations.get(m.locationId);if(I){const v=n.countries.get(I.countryId??"")?.color??null;this.renderLocation(o,I,v,m.elevation),!I.isDestroyed&&I.burningTurns>0&&this.renderBurning(o,m,I.burningTurns),(I.isDestroyed||!I.isDestroyed&&I.durability<20)&&this.renderSmoke(o,m)}}}const l=t.combatAnimation;let c={x:0,y:0},d={x:0,y:0},f=0,u=0;if(l&&l.active){const y=Date.now()-l.startTime,b=Math.min(y/l.duration,1),m=Math.sin(b*Math.PI*2*l.rounds),I=2;c={x:m*I,y:0},d={x:-m*I,y:0};const v=.15;if(f=m*v,u=-m*v,b>=1){const w=n.creatures.get(l.enemyId);if(w&&w.health<=0){let R=0,k=0;w.position.x===s.position.x&&w.position.y===s.position.y&&(R=12,k=6),n.bloodSplashes.push({x:w.position.x,y:w.position.y,offsetX:R,offsetY:k,createdTurn:t.turn,creatureType:w.type}),n.creatures.delete(l.enemyId)}t.combatAnimation=null}}for(const y of n.creatures.values()){const{x:b,y:m}=y.position;if(b>=r.minX&&b<=r.maxX&&m>=r.minY&&m<=r.maxY){const I=n.tiles[m][b];if(I.visible){const v=l&&l.enemyId===y.id?d:{x:0,y:0},w=l&&l.enemyId===y.id?u:0;this.renderCreature(o,y,I.elevation,s.position,v,w)}}}for(const y of n.characters.values()){if(!y.onDuty||!y.isAlive)continue;const{x:b,y:m}=y.position;if(b>=r.minX&&b<=r.maxX&&m>=r.minY&&m<=r.maxY){const I=n.tiles[m][b];I.visible&&this.renderCharacterOnDuty(o,y,I.elevation,s.position)}}const h=l?c:{x:0,y:0},p=l?f:0;this.renderParty(o,s.position.x,s.position.y,n.tiles[s.position.y]?.[s.position.x]?.elevation??.3,s.isSailing,h,p),t.selectedTile&&this.renderSelectionHighlight(o,t.selectedTile.x,t.selectedTile.y,n.tiles[t.selectedTile.y]?.[t.selectedTile.x]?.elevation??.3),this.renderBloodSplashes(o,n,t.turn,r),this.renderCountryNames(o,t),this.renderFogOfWar(o,t,r),o.restore(),this.renderMinimap(o,t)}renderTileLayer(t,i,o,n){if(!i.explored)return;const{x:s,y:a}=i,{x:r,y:l}=P(s,a,D,q),c=i.elevation*C;if(n==="ground"){const d=He(i.biome,i.elevation,(s*7+a*13)%8,o,i.vegetation,n),f=r-d.width/2,u=l-c-d.height/2;t.drawImage(d,f,u)}else if(n==="vegetation"){const d=He(i.biome,i.elevation,(s*7+a*13)%8,o,i.vegetation,n);if(d.width>1&&d.height>1){const f=r-d.width/2,u=l-c-d.height/2;t.drawImage(d,f,u)}}}renderRoad(t,i,o,n,s){const a=i.roadLevel,r=a>=3?"rgba(180,170,155,0.6)":a>=2?"rgba(150,135,115,0.55)":"rgba(130,110,80,0.45)",l=a>=3?5:a>=2?4:3;t.strokeStyle=r,t.lineWidth=l,t.lineCap="round",t.lineJoin="round";const c=i.elevation*C,d=(i.x*7+i.y*13)%5-2,f=[{dx:1,dy:0},{dx:0,dy:-1},{dx:-1,dy:-1},{dx:-1,dy:0},{dx:0,dy:1},{dx:1,dy:1}];let u=!1;for(const h of f){const p=i.x+h.dx,y=i.y+h.dy;if(p<0||p>=s.width||y<0||y>=s.height)continue;const b=s.tiles[y][p];if(b.roadLevel>0||b.locationId){const{x:m,y:I}=P(p,y,D,q),v=b.elevation*C,R=(c+v)/2-c,k=(o+m)/2,M=(n+I)/2-R,T=-(I-n)*.05+d*.3,A=(m-o)*.05+d*.2;t.beginPath(),t.moveTo(o,n),t.quadraticCurveTo(k+T,M+A,k,M),t.stroke(),u=!0}}if(!u){t.fillStyle=r;const h=l/2;t.beginPath(),t.arc(o,n,h,0,Math.PI*2),t.fill()}}renderWorkingSites(t,i,o){for(const n of i.locations.values()){if(n.isDestroyed)continue;const{x:s,y:a}=n.position,r=n.buildings.some(y=>y.type==="farm_field"&&y.isOperational),l=n.buildings.some(y=>y.type==="mine_shaft"&&y.isOperational),c=n.buildings.some(y=>(y.type==="sawmill"||y.type==="hunter_lodge")&&y.isOperational);if(!r&&!l&&!c)continue;const d=n.buildings.filter(y=>y.type==="farm_field").length,f=n.buildings.filter(y=>y.type==="mine_shaft").length,u=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1},{dx:1,dy:1},{dx:-1,dy:-1},{dx:1,dy:-1},{dx:-1,dy:1}];let h=0,p=0;for(const y of u){const b=s+y.dx,m=a+y.dy;if(b<o.minX||b>o.maxX||m<o.minY||m>o.maxY||b<0||b>=i.width||m<0||m>=i.height)continue;const I=i.tiles[m][b];if(!I.explored||I.locationId||I.terrainType==="deep_ocean"||I.terrainType==="shallow_ocean")continue;const{x:v,y:w}=P(b,m,D,q),R=I.elevation*C,k=w-R;if(r&&h<d&&(I.biome==="grassland"||I.biome==="savanna"||I.biome==="forest")){this.drawFieldOverlay(t,v,k),h++;continue}if(l&&p<f&&(I.biome==="hills"||I.biome==="mountain")){this.drawMineOverlay(t,v,k),p++;continue}c&&(I.biome==="forest"||I.biome==="dense_forest")&&this.drawStumpOverlay(t,v,k)}}}drawFieldOverlay(t,i,o){const s=_/6;for(let a=1;a<=5;a++){const r=o-_/2+a*s,l=Math.abs(r-o)/(_/2),c=_*.866*(1-l*.5);c<2||(t.fillStyle=a%2===0?"rgba(138,112,64,0.5)":"rgba(110,90,50,0.45)",t.fillRect(i-c,r,c*2,1),t.fillStyle=a%2===0?"rgba(104,160,48,0.6)":"rgba(200,176,64,0.55)",t.fillRect(i-c+2,r-1,c*2-4,1))}}drawMineOverlay(t,i,o){t.fillStyle="#2a2a2a",t.fillRect(i-5,o-4,10,6),t.fillStyle="#6a4a20",t.fillRect(i-6,o-5,12,2),t.fillRect(i-6,o-5,2,8),t.fillRect(i+4,o-5,2,8),t.fillStyle="#7a6a5a",t.fillRect(i+7,o-1,4,2),t.fillStyle="#5a4a3a",t.fillRect(i+8,o-2,2,1),t.fillStyle="#5a4a30",t.fillRect(i-2,o+2,8,1)}drawStumpOverlay(t,i,o){t.fillStyle="#6a5028",t.fillRect(i-6,o,4,3),t.fillRect(i+4,o-2,3,3),t.fillStyle="#7a5a30",t.fillRect(i-2,o+1,6,2),t.fillStyle="#8a6a3a",t.fillRect(i-1,o,4,1)}renderBurning(t,i,o){const{x:n,y:s}=P(i.x,i.y,D,q),a=i.elevation*C,r=Math.min(1,o/3),l=this.animationTime*4,c=Math.sin(l)*.3+.7;t.fillStyle=`rgba(255,100,20,${(.4*r*c).toFixed(2)})`,t.fillRect(n-12,s-a-22,24,14);const d=Math.ceil(r*5);for(let f=0;f<d;f++){const u=n-8+f*5+Math.sin(l+f*2.3)*3,h=s-a-28-f*3+Math.cos(l+f*1.7)*2;t.fillStyle=`rgba(255,200,40,${(.6*r*c).toFixed(2)})`,t.fillRect(u,h,3,4),t.fillStyle=`rgba(255,60,10,${(.5*r).toFixed(2)})`,t.fillRect(u+1,h+3,2,2)}for(let f=0;f<3;f++){const u=n-4+f*4+Math.sin(l*1.5+f*3)*5,h=s-a-35-(l*8+f*12)%20,p=Math.max(0,.5-(l+f*2)%4*.15);t.fillStyle=`rgba(255,180,50,${p.toFixed(2)})`,t.fillRect(u,h,1,1)}}renderSmoke(t,i){const{x:o,y:n}=P(i.x,i.y,D,q),s=i.elevation*C,a=this.animationTime*2;for(let r=0;r<4;r++){const l=o-8+r*5+Math.sin(a+r*1.5)*3,c=n-s-30-(a*2+r*8)%20,d=Math.max(0,.25-(a+r*3)%5*.05);t.fillStyle=`rgba(80,70,60,${d.toFixed(2)})`,t.fillRect(l,c,4,3)}}renderPier(t,i,o){t.fillStyle="#8a6a3a",t.fillRect(i-8,o-2,16,4),t.fillStyle="#7a5a2a",t.fillRect(i-6,o-1,12,2),t.fillStyle="#5a4020",t.fillRect(i-7,o+2,2,4),t.fillRect(i+5,o+2,2,4),t.fillStyle="#6a5030",t.fillRect(i-5,o+5,10,3),t.fillStyle="#8a7040",t.fillRect(i-4,o+5,8,2),t.fillStyle="#5a4020",t.fillRect(i,o+1,1,5),t.fillStyle="#d8d0c0",t.fillRect(i+1,o+1,3,3),t.fillStyle="#c8c0b0",t.fillRect(i+1,o+2,2,2)}renderLocation(t,i,o,n){const{x:s,y:a}=i.position,{x:r,y:l}=P(s,a,D,q),c=n*C,d=Ho(i.type,i.size,o,i.originalType);t.drawImage(d,r-24,l-c-40),t.font="7px monospace",t.textAlign="center";const f=i.isDestroyed?`${i.name} (ruins)`:i.name,h=t.measureText(f).width,p=7,y=2;t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(r-h/2-y,l-c-42-p+1,h+y*2,p+y),t.fillStyle=i.isDestroyed?"#b0a090":g.uiText,t.fillText(f,r,l-c-42)}renderCreature(t,i,o,n,s={x:0,y:0},a=0){const{x:r,y:l}=i.position,c=P(r,l,D,q);let d=c.x,f=c.y;const u=o*C;i.position.x===n.x&&i.position.y===n.y&&(d+=12,f+=6),d+=s.x,f+=s.y;const h=Oe(i.type);if(a!==0){if(t.save(),t.translate(d,f-u-8),t.rotate(a),t.drawImage(h,-8,-8),(i.type==="guard"||i.type==="army")&&i.countryId){const p=this.getCountry(i.countryId);p&&this.drawColoredHelmet(t,0,0,p.color,i.type)}t.restore()}else if(t.drawImage(h,d-8,f-u-16),(i.type==="guard"||i.type==="army")&&i.countryId){const p=this.getCountry(i.countryId);p&&this.drawColoredHelmet(t,d,f-u-16,p.color,i.type)}}renderCharacterOnDuty(t,i,o,n){const{x:s,y:a}=i.position,r=P(s,a,D,q);let l=r.x,c=r.y;const d=o*C;i.position.x===n.x&&i.position.y===n.y&&(l+=12,c+=6);let f;if(i.jobType==="hunter")f="hunter";else if(i.jobType==="guard"||i.jobType==="soldier")f="guard";else return;const u=Oe(f);if(t.drawImage(u,l-8,c-d-16),(i.jobType==="guard"||i.jobType==="soldier")&&i.homeLocationId){const h=this.currentState?.world.locations.get(i.homeLocationId);if(h&&h.countryId){const p=this.getCountry(h.countryId);p&&this.drawColoredHelmet(t,l,c-d-16,p.color,"guard")}}}drawColoredHelmet(t,i,o,n,s){if(s==="guard")t.fillStyle=n,t.fillRect(i-2+8,o+2,5,2),t.fillRect(i-1+8,o+1,3,1);else if(s==="army"){for(let a=-1;a<=1;a++){const r=a*3,l=Math.abs(a);t.fillStyle=n,t.fillRect(i+r-1+8,o+7+l,3,2)}t.fillStyle=n,t.fillRect(i-1+8,o+1,4,3)}}getCountry(t){const i=this.currentState;return i?i.world.countries.get(t):null}renderParty(t,i,o,n,s=!1,a={x:0,y:0},r=0){const l=P(i,o,D,q);let c=l.x,d=l.y;const f=n*C;c+=a.x,d+=a.y;const u=Math.sin(this.animationTime*3)*.3+.7;t.fillStyle=Ee(g.uiHighlight,u*.3),ie(t,c,d-f,_+2),t.fill(),s&&this.drawPartyBoat(t,c,d-f);const h=sn(),p=s?-16:-20;r!==0?(t.save(),t.translate(c,d-f+p+12),t.rotate(r),t.drawImage(h,-8,-12),t.restore()):t.drawImage(h,c-8,d-f+p)}drawPartyBoat(t,i,o){t.fillStyle="#6a4a28",t.beginPath(),t.moveTo(i-14,o-2),t.lineTo(i-10,o+4),t.lineTo(i+10,o+4),t.lineTo(i+14,o-2),t.closePath(),t.fill(),t.fillStyle="#8a6a38",t.fillRect(i-10,o-3,20,3),t.fillStyle="#5a3a18",t.fillRect(i-8,o+3,16,2),t.fillStyle="#5a4020",t.fillRect(i-1,o-18,2,16),t.fillStyle="#e0d8c8",t.beginPath(),t.moveTo(i+1,o-17),t.lineTo(i+12,o-10),t.lineTo(i+1,o-4),t.closePath(),t.fill(),t.fillStyle="#c8c0b0",t.beginPath(),t.moveTo(i+1,o-12),t.lineTo(i+8,o-8),t.lineTo(i+1,o-4),t.closePath(),t.fill();const n=Math.sin(this.animationTime*2)*1;t.strokeStyle="rgba(90,170,220,0.4)",t.lineWidth=1.5,t.beginPath(),t.moveTo(i-16,o+5+n),t.quadraticCurveTo(i,o+3+n,i+16,o+5+n),t.stroke()}renderSelectionHighlight(t,i,o,n){const{x:s,y:a}=P(i,o,D,q),r=n*C;t.strokeStyle=g.uiHighlight,t.lineWidth=2,ie(t,s,a-r,_),t.stroke()}renderCountryBorders(t,i,o){for(let n=o.minY;n<=o.maxY;n++)for(let s=o.minX;s<=o.maxX;s++){const a=i.tiles[n][s];if(!a.locationId)continue;const r=i.locations.get(a.locationId);if(!r?.countryId)continue;const l=i.countries.get(r.countryId);if(!l)continue;const{x:c,y:d}=P(s,n,D,q),f=a.elevation*C;t.strokeStyle=Ee(l.color,.4),t.lineWidth=1,ie(t,c,d-f,_),t.stroke()}}renderCountryNames(t,i){const{world:o}=i;for(const n of o.countries.values()){const s=o.locations.get(n.capitalLocationId);if(!s)continue;const a=o.tiles[s.position.y]?.[s.position.x];if(!a||!a.explored)continue;const{x:r,y:l}=s.position,{x:c,y:d}=P(r,l,D,q),f=a.elevation*C;t.font="bold 10px monospace",t.textAlign="center",t.fillStyle="rgba(0,0,0,0.6)",t.fillText(n.name,c+1,d-f-55+1),t.fillStyle=n.color,t.fillText(n.name,c,d-f-55)}}renderMinimap(t,i){const n=this.camera.screenWidth-160-12,s=12;(this.minimapDirty||!this.minimapCanvas)&&(this.minimapCanvas=this.generateMinimapImage(i),this.minimapDirty=!1),t.fillStyle="rgba(10,10,20,0.8)",t.fillRect(n-2,s-2,164,164),t.strokeStyle=g.uiBorder,t.lineWidth=1,t.strokeRect(n-2,s-2,164,164),t.drawImage(this.minimapCanvas,n,s,160,160);const a=160/i.world.width,r=160/i.world.height,l=this.camera.getVisibleRange(i.world.width,i.world.height);t.strokeStyle=g.uiHighlight,t.lineWidth=1,t.strokeRect(n+l.minX*a,s+l.minY*r,(l.maxX-l.minX)*a,(l.maxY-l.minY)*r);const c=n+i.party.position.x*a,d=s+i.party.position.y*r;t.fillStyle=g.uiHighlight,t.fillRect(c-2,d-2,4,4),this.minimapBounds={x:n,y:s,size:160}}minimapBounds={x:0,y:0,size:0};handleMinimapClick(t,i,o,n){const{x:s,y:a,size:r}=this.minimapBounds;if(r===0||t<s||t>s+r||i<a||i>a+r)return null;const l=Math.floor((t-s)/r*o),c=Math.floor((i-a)/r*n);return{tx:l,ty:c}}generateMinimapImage(t){const{world:i}=t,o=new OffscreenCanvas(i.width,i.height),n=o.getContext("2d");for(let s=0;s<i.height;s++)for(let a=0;a<i.width;a++){const r=i.tiles[s][a];n.fillStyle=vn(r),n.fillRect(a,s,1,1)}for(const s of i.locations.values()){if(s.isDestroyed)continue;const a=i.countries.get(s.countryId??"");n.fillStyle=a?.color??"#ffffff",n.fillRect(s.position.x-1,s.position.y-1,3,3)}return o}invalidateMinimap(){this.minimapDirty=!0}renderFogOfWar(t,i,o){const{world:n,party:s}=i,a=s.position.x,r=s.position.y,l=6,c=o.maxX-o.minX+1,d=o.maxY-o.minY+1,f=new Float32Array(c*d);for(let p=o.minY;p<=o.maxY;p++)for(let y=o.minX;y<=o.maxX;y++){const b=n.tiles[p][y],m=y-a,I=p-r,v=Math.sqrt(m*m+I*I);let w;b.explored?b.visible?w=Math.max(0,Math.min(1,(v-l+2)/2.5))*.4:w=.48:w=.86,f[(p-o.minY)*c+(y-o.minX)]=w}const u=new Float32Array(c*d);for(let p=0;p<d;p++)for(let y=0;y<c;y++){let b=0,m=0;for(let I=-1;I<=1;I++)for(let v=-1;v<=1;v++){const w=y+v,R=p+I;w>=0&&w<c&&R>=0&&R<d&&(b+=f[R*c+w],m++)}u[p*c+y]=b/m}const h=_+2;for(let p=o.minY;p<=o.maxY;p++)for(let y=o.minX;y<=o.maxX;y++){const b=u[(p-o.minY)*c+(y-o.minX)];if(b<.01)continue;const{x:m,y:I}=P(y,p,D,q),v=n.tiles[p][y].elevation*C,w=I-v;t.fillStyle=`rgba(10,10,18,${b.toFixed(3)})`,ie(t,m,w,h),t.fill()}}renderBloodSplashes(t,i,o,n){for(const a of i.bloodSplashes){const{x:r,y:l,offsetX:c,offsetY:d,createdTurn:f}=a;if(r<n.minX||r>n.maxX||l<n.minY||l>n.maxY)continue;const u=i.tiles[l]?.[r];if(!u||!u.visible)continue;const h=o-f;if(h>=10)continue;const p=P(r,l,D,q);let y=p.x,b=p.y;const m=u.elevation*C;y+=c,b+=d;const I=Math.max(0,1-h/10);t.fillStyle=`rgba(100, 20, 20, ${I*.7})`;const v=4;t.globalAlpha=I*.7,t.beginPath(),t.arc(y,b-m,v,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(y-3,b-m-2,v*.6,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(y+2,b-m+2,v*.5,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(y+4,b-m-1,v*.4,0,Math.PI*2),t.fill(),t.globalAlpha=1}}}function vn(e){if(e.locationId)return"#ffffff";if(e.roadLevel>0)return g.roadDirt;switch(e.biome){case"ocean":return g.deepWater;case"beach":return g.sand;case"desert":return g.desert;case"grassland":return g.grass;case"forest":return g.tree;case"dense_forest":return g.treeDark;case"jungle":return g.jungleTree;case"hills":return g.hillGrass;case"mountain":return g.rock;case"snow_mountain":return g.snow;case"tundra":return g.tundra;case"swamp":return g.swamp;case"savanna":return g.savanna;default:return g.grass}}class wn{engine;renderer;canvas;hud=null;isPanning=!1;lastMouseX=0;lastMouseY=0;dragDistance=0;keysDown=new Set;constructor(t,i,o){this.engine=t,this.renderer=i,this.canvas=o,this.setupEventListeners()}setHUD(t){this.hud=t}setupEventListeners(){window.addEventListener("keydown",t=>this.onKeyDown(t)),window.addEventListener("keyup",t=>this.onKeyUp(t)),this.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),this.canvas.addEventListener("mousemove",t=>this.onMouseMove(t)),this.canvas.addEventListener("mouseup",t=>this.onMouseUp(t)),this.canvas.addEventListener("wheel",t=>this.onWheel(t),{passive:!1}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.canvas.addEventListener("touchstart",t=>this.onTouchStart(t)),this.canvas.addEventListener("touchmove",t=>this.onTouchMove(t),{passive:!1}),this.canvas.addEventListener("touchend",()=>this.onTouchEnd())}onKeyDown(t){console.log(`[InputHandler] Key pressed: "${t.key}"`),this.keysDown.add(t.key.toLowerCase());const i=this.engine.state;if(!i||i.gameOver){console.log("[InputHandler] No state or game over, ignoring key");return}if(t.key==="i"||t.key==="I"){this.hud&&this.hud.openInventoryTab("inventory");return}if(t.key==="m"||t.key==="M"){this.hud&&this.hud.openInventoryTab("market");return}if(t.key==="Escape"&&this.hud?.isInventoryOpen()){this.hud.toggleInventory();return}if(!this.hud?.isInventoryOpen())switch(t.key){case"Enter":case" ":console.log("[InputHandler] Space/Enter detected, calling endTurn()"),t.preventDefault(),this.engine.cancelMovement(),this.engine.endTurn();break;case"c":case"C":this.renderer.camera.centerOnTile(i.party.position.x,i.party.position.y);break;case"r":case"R":this.engine.cancelMovement(),this.engine.rest();break;case"h":case"H":this.engine.cancelMovement(),this.engine.hunt();break;case"Escape":this.engine.cancelMovement(),i.selectedTile=null;break;case"+":case"=":this.renderer.camera.zoomAt(1.2,this.renderer.camera.screenWidth/2,this.renderer.camera.screenHeight/2);break;case"-":case"_":this.renderer.camera.zoomAt(.8,this.renderer.camera.screenWidth/2,this.renderer.camera.screenHeight/2);break}}onKeyUp(t){this.keysDown.delete(t.key.toLowerCase())}onMouseDown(t){this.isPanning=!0,this.dragDistance=0,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY}onMouseMove(t){if(this.isPanning){const i=t.clientX-this.lastMouseX,o=t.clientY-this.lastMouseY;this.dragDistance+=Math.abs(i)+Math.abs(o),(t.buttons===4||this.dragDistance>6)&&this.renderer.camera.pan(i,o),this.lastMouseX=t.clientX,this.lastMouseY=t.clientY}}onMouseUp(t){const i=this.dragDistance>6;if(this.isPanning=!1,i)return;const o=this.engine.state;if(!o)return;if(this.hud?.isInventoryOpen())return t.button===0&&this.hud?.handleInventoryClick(t.clientX,t.clientY),void 0;if(t.button===0&&this.hud?.handleClick(t.clientX,t.clientY,o))return;const n=this.renderer.handleMinimapClick(t.clientX,t.clientY,o.world.width,o.world.height);if(n){this.renderer.camera.centerOnTile(n.tx,n.ty);return}const s=this.pickTile(t.clientX,t.clientY);s&&(t.button===0?o.selectedTile={x:s.x,y:s.y}:t.button===2&&(this.engine.cancelMovement(),this.engine.movePartyToward(s.x,s.y)))}onWheel(t){if(t.preventDefault(),this.hud?.handleScroll(t.clientX,t.clientY,t.deltaY))return;const i=t.deltaY>0?.9:1.1;this.renderer.camera.zoomAt(i,t.clientX,t.clientY)}onTouchStart(t){t.touches.length===1&&(this.isPanning=!0,this.dragDistance=0,this.lastMouseX=t.touches[0].clientX,this.lastMouseY=t.touches[0].clientY)}onTouchMove(t){if(t.preventDefault(),this.isPanning&&t.touches.length===1){const i=t.touches[0].clientX-this.lastMouseX,o=t.touches[0].clientY-this.lastMouseY;this.dragDistance+=Math.abs(i)+Math.abs(o),this.renderer.camera.pan(i,o),this.lastMouseX=t.touches[0].clientX,this.lastMouseY=t.touches[0].clientY}}onTouchEnd(){this.isPanning=!1}pickTile(t,i){const o=this.engine.state;if(!o)return null;const n=this.renderer.camera,{wx:s,wy:a}=n.screenToWorld(t,i);let r=ye(s,a,D,q),l=r.q,c=r.r;l=Math.max(0,Math.min(o.world.width-1,l)),c=Math.max(0,Math.min(o.world.height-1,c));const f=o.world.tiles[c][l].elevation*C,u=a+f;return r=ye(s,u,D,q),l=Math.max(0,Math.min(o.world.width-1,r.q)),c=Math.max(0,Math.min(o.world.height-1,r.r)),{x:l,y:c}}update(){if(this.hud?.isInventoryOpen())return;const t=40;let i=0,o=0;(this.keysDown.has("a")||this.keysDown.has("arrowleft"))&&(i+=t),(this.keysDown.has("d")||this.keysDown.has("arrowright"))&&(i-=t),(this.keysDown.has("w")||this.keysDown.has("arrowup"))&&(o+=t),(this.keysDown.has("s")||this.keysDown.has("arrowdown"))&&(o-=t),(i!==0||o!==0)&&this.renderer.camera.pan(i,o)}}const Ne=new Map;function ze(e){const t=Ne.get(e);if(t)return t;const i=new OffscreenCanvas(16,16),o=i.getContext("2d");switch(e){case"bread":Rn(o,8,8);break;case"meat":kn(o,8,8);break;case"fish":Sn(o,8,8);break;case"berries":Mn(o,8,8);break;case"exotic_fruit":Tn(o,8,8);break;case"wheat":Ln(o,8,8);break;case"wood":Dn(o,8,8);break;case"stone":An(o,8,8);break;case"iron_ore":qn(o,8,8);break;case"coal":Cn(o,8,8);break;case"gold_ore":Pn(o,8,8);break;case"copper_ore":_n(o,8,8);break;case"clay":En(o,8,8);break;case"salt":$n(o,8,8);break;case"iron":Hn(o,8,8);break;case"steel":Wn(o,8,8);break;case"copper":Bn(o,8,8);break;case"gold":On(o,8,8);break;case"lumber":Nn(o,8,8);break;case"planks":zn(o,8,8);break;case"bricks":Fn(o,8,8);break;case"wool":Yn(o,8,8);break;case"cloth":jn(o,8,8);break;case"hides":Xn(o,8,8);break;case"leather":Gn(o,8,8);break;case"wine":Vn(o,8,8);break;case"jewelry":Un(o,8,8);break;case"silk":Qn(o,8,8);break;case"spices":Kn(o,8,8);break;case"tools":Zn(o,8,8);break;case"weapons":Jn(o,8,8);break;default:xn(o,8,8);break}return Ne.set(e,i),i}function Rn(e,t,i){e.fillStyle="#d4a574",e.fillRect(t-4,i-2,8,4),e.fillRect(t-3,i-3,6,1),e.fillStyle="#a67c52",e.fillRect(t-4,i+1,1,1),e.fillRect(t+3,i+1,1,1),e.fillRect(t-2,i-3,1,1),e.fillRect(t+1,i-3,1,1)}function kn(e,t,i){e.fillStyle="#c85050",e.fillRect(t-3,i-3,6,6),e.fillRect(t-4,i-2,1,4),e.fillRect(t+3,i-1,1,2),e.fillStyle="#f0d0d0",e.fillRect(t-2,i-1,2,1),e.fillRect(t+1,i+1,1,1),e.fillStyle="#e8e8d0",e.fillRect(t-5,i,2,2),e.fillRect(t-6,i,1,1),e.fillRect(t-6,i+1,1,1)}function Sn(e,t,i){e.fillStyle="#8090b0",e.fillRect(t-4,i-1,6,3),e.fillRect(t-5,i,1,1),e.fillRect(t+2,i-2,2,1),e.fillRect(t+2,i+2,2,1),e.fillStyle="#2a2a2a",e.fillRect(t-4,i,1,1),e.fillStyle="#a0b0c8",e.fillRect(t-2,i,1,1),e.fillRect(t,i+1,1,1)}function Mn(e,t,i){e.fillStyle="#a03060",e.fillRect(t-2,i-1,2,2),e.fillRect(t,i-2,2,2),e.fillRect(t-1,i,2,2),e.fillRect(t+1,i+1,2,2),e.fillStyle="#d05080",e.fillRect(t-1,i-1,1,1),e.fillRect(t+1,i-1,1,1),e.fillRect(t,i+1,1,1),e.fillStyle="#508040",e.fillRect(t,i-3,1,2)}function Tn(e,t,i){e.fillStyle="#f08030",e.fillRect(t-3,i-2,6,5),e.fillRect(t-2,i-3,4,1),e.fillStyle="#f0a050",e.fillRect(t-2,i-1,2,2),e.fillRect(t+1,i+1,2,1),e.fillStyle="#40a040",e.fillRect(t-1,i-4,3,2)}function Ln(e,t,i){e.fillStyle="#d4b070",e.fillRect(t-3,i-3,1,6),e.fillRect(t-1,i-4,1,7),e.fillRect(t+1,i-3,1,6),e.fillRect(t+3,i-2,1,5),e.fillStyle="#e8c878",e.fillRect(t-4,i-4,2,2),e.fillRect(t-2,i-5,2,2),e.fillRect(t,i-4,2,2),e.fillRect(t+2,i-3,2,2)}function Dn(e,t,i){e.fillStyle="#6a4a2a",e.fillRect(t-4,i-2,8,4),e.fillStyle="#8a6a4a",e.fillRect(t+3,i-2,1,4),e.fillStyle="#5a3a1a",e.fillRect(t-3,i-1,6,1),e.fillRect(t-2,i+1,4,1),e.fillRect(t-4,i-1,1,1),e.fillRect(t-4,i+1,1,1)}function An(e,t,i){e.fillStyle="#808080",e.fillRect(t-3,i-2,6,4),e.fillRect(t-4,i-1,1,2),e.fillRect(t+3,i,1,1),e.fillStyle="#a0a0a0",e.fillRect(t-2,i-2,2,1),e.fillRect(t+1,i-1,1,1),e.fillStyle="#606060",e.fillRect(t-3,i+1,3,1),e.fillRect(t+2,i+1,1,1)}function qn(e,t,i){e.fillStyle="#706060",e.fillRect(t-3,i-2,6,4),e.fillRect(t-4,i-1,1,2),e.fillStyle="#b87030",e.fillRect(t-2,i-1,2,1),e.fillRect(t+1,i,2,1),e.fillRect(t-1,i+1,1,1)}function Cn(e,t,i){e.fillStyle="#2a2a2a",e.fillRect(t-3,i-2,3,3),e.fillRect(t,i-1,3,3),e.fillRect(t-2,i,2,2),e.fillStyle="#4a4a4a",e.fillRect(t-2,i-1,1,1),e.fillRect(t+1,i,1,1)}function Pn(e,t,i){e.fillStyle="#706050",e.fillRect(t-3,i-2,6,4),e.fillStyle="#d4a020",e.fillRect(t-2,i-1,3,1),e.fillRect(t,i,2,1),e.fillRect(t+1,i+1,1,1),e.fillStyle="#f0c840",e.fillRect(t-1,i-1,1,1),e.fillRect(t+1,i,1,1)}function _n(e,t,i){e.fillStyle="#605850",e.fillRect(t-3,i-2,6,4),e.fillStyle="#b86040",e.fillRect(t-2,i-1,2,1),e.fillRect(t+1,i,2,1),e.fillRect(t-1,i+1,2,1)}function En(e,t,i){e.fillStyle="#a07860",e.fillRect(t-3,i-2,6,4),e.fillRect(t-4,i-1,1,2),e.fillRect(t+3,i,1,1),e.fillStyle="#907050",e.fillRect(t-2,i,3,1),e.fillRect(t+1,i-1,1,1)}function $n(e,t,i){e.fillStyle="#f0f0f0",e.fillRect(t-3,i-1,3,3),e.fillRect(t,i-2,3,3),e.fillRect(t-2,i,2,2),e.fillStyle="#ffffff",e.fillRect(t-2,i,1,1),e.fillRect(t+1,i-1,1,1),e.fillStyle="#d0d0d0",e.fillRect(t-3,i+1,2,1),e.fillRect(t+1,i+1,1,1)}function Hn(e,t,i){e.fillStyle="#a0a0a8",e.fillRect(t-4,i-1,8,3),e.fillStyle="#c8c8d0",e.fillRect(t-3,i-1,5,1),e.fillStyle="#707078",e.fillRect(t-3,i+1,6,1)}function Wn(e,t,i){e.fillStyle="#b0b0c0",e.fillRect(t-4,i-1,8,3),e.fillStyle="#e0e0f0",e.fillRect(t-2,i-1,4,1),e.fillStyle="#808090",e.fillRect(t-3,i+1,6,1)}function Bn(e,t,i){e.fillStyle="#c87850",e.fillRect(t-4,i-1,8,3),e.fillStyle="#e89870",e.fillRect(t-3,i-1,5,1),e.fillStyle="#a05030",e.fillRect(t-3,i+1,6,1)}function On(e,t,i){e.fillStyle="#e8b830",e.fillRect(t-4,i-1,8,3),e.fillStyle="#f8d850",e.fillRect(t-3,i-1,5,1),e.fillStyle="#c09010",e.fillRect(t-3,i+1,6,1)}function Nn(e,t,i){e.fillStyle="#8a6a4a",e.fillRect(t-4,i-2,8,4),e.fillStyle="#aa8a6a",e.fillRect(t-3,i-2,6,1),e.fillRect(t-3,i+1,6,1),e.fillStyle="#6a4a2a",e.fillRect(t-2,i-1,1,2),e.fillRect(t+1,i,1,1)}function zn(e,t,i){e.fillStyle="#9a7a5a",e.fillRect(t-4,i-2,8,1),e.fillRect(t-4,i,8,1),e.fillRect(t-4,i+2,8,1),e.fillStyle="#7a5a3a",e.fillRect(t-2,i-2,4,1),e.fillRect(t-3,i,5,1),e.fillRect(t-1,i+2,3,1)}function Fn(e,t,i){e.fillStyle="#a86050",e.fillRect(t-4,i-3,3,2),e.fillRect(t-1,i-3,3,2),e.fillRect(t+2,i-3,2,2),e.fillRect(t-4,i-1,2,2),e.fillRect(t-2,i-1,3,2),e.fillRect(t+1,i-1,3,2),e.fillStyle="#d0c8c0",e.fillRect(t-4,i-1,8,1),e.fillRect(t-1,i-3,1,2),e.fillRect(t+2,i-3,1,2),e.fillRect(t-2,i-1,1,2),e.fillRect(t+1,i-1,1,2)}function Yn(e,t,i){e.fillStyle="#f0f0e8",e.fillRect(t-3,i-2,6,4),e.fillRect(t-4,i-1,1,2),e.fillRect(t+3,i,1,1),e.fillStyle="#e8e8d8",e.fillRect(t-2,i-2,1,1),e.fillRect(t,i-2,1,1),e.fillRect(t+2,i-1,1,1),e.fillRect(t-1,i,2,1),e.fillRect(t-3,i+1,2,1),e.fillRect(t+1,i+1,2,1)}function jn(e,t,i){e.fillStyle="#d0c8b0",e.fillRect(t-4,i-2,8,4),e.fillStyle="#b0a890",e.fillRect(t-3,i-1,1,3),e.fillRect(t-1,i-2,1,4),e.fillRect(t+1,i-1,1,3),e.fillRect(t+3,i,1,2),e.fillStyle="#e8e0c8",e.fillRect(t-2,i-2,1,1),e.fillRect(t,i-2,1,1),e.fillRect(t+2,i-1,1,1)}function Xn(e,t,i){e.fillStyle="#9a7860",e.fillRect(t-4,i-3,7,6),e.fillRect(t-5,i-2,1,4),e.fillRect(t+3,i-1,1,2),e.fillStyle="#8a6850",e.fillRect(t-3,i-2,5,1),e.fillRect(t-2,i,3,1),e.fillRect(t-3,i+2,4,1),e.fillStyle="#6a4830",e.fillRect(t-2,i-1,2,1),e.fillRect(t+1,i+1,1,1)}function Gn(e,t,i){e.fillStyle="#8a5a3a",e.fillRect(t-4,i-2,8,4),e.fillStyle="#6a3a1a",e.fillRect(t-3,i-2,1,1),e.fillRect(t-1,i-2,1,1),e.fillRect(t+1,i-2,1,1),e.fillRect(t+3,i-2,1,1),e.fillRect(t-3,i+1,1,1),e.fillRect(t-1,i+1,1,1),e.fillRect(t+1,i+1,1,1),e.fillRect(t+3,i+1,1,1)}function Vn(e,t,i){e.fillStyle="#304030",e.fillRect(t-2,i-4,4,6),e.fillRect(t-1,i-5,2,2),e.fillStyle="#8a6a4a",e.fillRect(t-1,i-6,2,1),e.fillStyle="#e8d8c0",e.fillRect(t-2,i-2,4,2),e.fillStyle="#507050",e.fillRect(t-1,i-3,1,2)}function Un(e,t,i){e.fillStyle="#e8b830",e.fillRect(t-3,i,6,1),e.fillRect(t-3,i-1,1,1),e.fillRect(t+2,i-1,1,1),e.fillRect(t-3,i+1,1,1),e.fillRect(t+2,i+1,1,1),e.fillStyle="#3080c8",e.fillRect(t-1,i-2,2,2),e.fillStyle="#60a8f0",e.fillRect(t-1,i-2,1,1)}function Qn(e,t,i){e.fillStyle="#d870a0",e.fillRect(t-4,i-2,8,4),e.fillStyle="#f090c0",e.fillRect(t-3,i-2,2,1),e.fillRect(t,i-1,3,1),e.fillRect(t-2,i,2,1),e.fillRect(t+1,i+1,2,1),e.fillStyle="#b85080",e.fillRect(t-1,i-2,1,4),e.fillRect(t+2,i-1,1,3)}function Kn(e,t,i){e.fillStyle="#a08060",e.fillRect(t-3,i-1,6,3),e.fillRect(t-2,i-2,4,1),e.fillStyle="#6a4a2a",e.fillRect(t-1,i-3,2,2),e.fillStyle="#d08030",e.fillRect(t-2,i+2,1,1),e.fillRect(t+1,i+2,1,1),e.fillStyle="#e89840",e.fillRect(t-1,i+1,1,1),e.fillRect(t,i+2,1,1)}function Zn(e,t,i){e.fillStyle="#808080",e.fillRect(t-3,i-1,4,2),e.fillStyle="#6a4a2a",e.fillRect(t+1,i-3,1,5),e.fillStyle="#909090",e.fillRect(t-5,i+1,3,1),e.fillRect(t-4,i,1,1)}function Jn(e,t,i){e.fillStyle="#b0b0c0",e.fillRect(t-1,i-5,2,6),e.fillRect(t,i-6,1,1),e.fillStyle="#8a6a4a",e.fillRect(t-1,i+1,2,2),e.fillStyle="#c0a060",e.fillRect(t-3,i+1,6,1)}function xn(e,t,i){e.fillStyle="#8a7a6a",e.fillRect(t-3,i-2,6,4),e.fillStyle="#6a5a4a",e.fillRect(t-2,i-1,4,1),e.fillRect(t-1,i-2,1,4),e.fillStyle="#c0b0a0",e.fillRect(t,i-1,1,1),e.fillRect(t,i+1,1,1)}class es{ctx;engine;renderer=null;width=0;height=0;logHitAreas=[];logScrollOffset=0;logTotalLines=0;logBounds={x:0,y:0,w:0,h:0};showInventory=!1;sellButtonAreas=[];buyButtonAreas=[];inventoryTab="inventory";turnButtonArea=null;constructor(t,i){this.ctx=t,this.engine=i}setRenderer(t){this.renderer=t}toggleInventory(t){const i=this.showInventory;this.showInventory=!this.showInventory,this.showInventory&&t?this.inventoryTab=t:!i&&!t&&(this.inventoryTab="inventory")}openInventoryTab(t){this.showInventory&&this.inventoryTab===t?this.showInventory=!1:(this.showInventory=!0,this.inventoryTab=t)}isInventoryOpen(){return this.showInventory}handleInventoryClick(t,i){if(!this.showInventory)return!1;const o=this.engine.state,n=o.world.tiles[o.party.position.y]?.[o.party.position.x],s=n?.locationId?o.world.locations.get(n.locationId):null;if(s&&!s.isDestroyed&&s.buildings.some(r=>r.isOperational&&r.type==="market")){if(t>=100&&t<=200&&i>=180&&i<=200)return this.inventoryTab="inventory",!0;if(t>=210&&t<=310&&i>=180&&i<=200)return this.inventoryTab="market",!0}for(const r of this.sellButtonAreas)if(t>=r.x&&t<=r.x+r.w&&i>=r.y&&i<=r.y+r.h)return this.engine.sellInventoryItem(r.itemIndex),!0;for(const r of this.buyButtonAreas)if(t>=r.x&&t<=r.x+r.w&&i>=r.y&&i<=r.y+r.h)return this.engine.buyMarketItem(r.resourceId,r.storageIndex),!0;return!1}render(t,i,o){this.width=i,this.height=o,this.renderTopBar(t),this.renderEndTurnButton(t),this.renderEventLog(t),this.renderBottomBar(t),this.renderTileInfo(t),this.renderPartyStatus(t),this.showInventory&&this.renderInventory(t)}handleClick(t,i,o){if(this.turnButtonArea){const n=this.turnButtonArea;if(t>=n.x&&t<=n.x+n.w&&i>=n.y&&i<=n.y+n.h)return this.engine.endTurn(),!0}for(const n of this.logHitAreas)if(t>=n.x&&t<=n.x+n.w&&i>=n.y&&i<=n.y+n.h){const s=o.world.locations.get(n.locationId);return s&&this.renderer&&(this.renderer.camera.centerOnTile(s.position.x,s.position.y),o.selectedTile={x:s.position.x,y:s.position.y}),!0}return!1}handleScroll(t,i,o){const n=this.logBounds;return t>=n.x&&t<=n.x+n.w&&i>=n.y&&i<=n.y+n.h?(this.logScrollOffset+=o>0?-2:2,this.logScrollOffset=Math.max(0,Math.min(this.logScrollOffset,Math.max(0,this.logTotalLines-5))),!0):!1}resetLogScroll(){this.logScrollOffset=0}renderTopBar(t){const i=this.ctx,o=32;i.fillStyle="rgba(10,10,20,0.85)",i.fillRect(0,0,this.width-180,o),i.fillStyle=g.uiBorder,i.fillRect(0,o,this.width-180,1),i.fillStyle=g.uiText,i.font="12px monospace",i.textAlign="left",i.fillText(this.engine.getDateString(),12,20);const n={clear:"Clear",cloudy:"Cloudy",rain:"Rain",storm:"Storm",snow:"Snow",fog:"Fog",heatwave:"Heat",blizzard:"Blizzard"};i.fillStyle=g.uiHighlight,i.fillText(`Weather: ${n[t.weather]??t.weather}`,300,20),i.fillStyle=g.uiText,i.fillText(`Turn ${t.turn}`,480,20);const s=Array.from(t.world.characters.values()).filter(r=>r.isAlive).length,a=Array.from(t.world.locations.values()).filter(r=>!r.isDestroyed).length;i.fillText(`Pop: ${s} | Settlements: ${a}`,570,20)}renderEndTurnButton(t){const i=this.ctx,o=140,n=70,s=this.width-o-12,r=this.height-24-n-8,l=t.party.actionPoints===0;let c=1;l&&(c=.7+.3*Math.sin(Date.now()*3*Math.PI/1e3)),i.globalAlpha=c,i.fillStyle="rgba(80, 140, 80, 0.9)",i.fillRect(s,r,o,n),i.strokeStyle="#60b060",i.lineWidth=2,i.strokeRect(s,r,o,n),i.globalAlpha=1,i.fillStyle="#ffffff",i.font="bold 14px monospace",i.textAlign="center",i.fillText("END TURN",s+o/2,r+22),i.font="10px monospace",i.fillStyle="#b0a090",i.fillText(`Turn ${t.turn}`,s+o/2,r+38),i.font="bold 12px monospace",i.fillStyle=g.uiHighlight;const d=`AP: ${t.party.actionPoints}/${t.party.maxActionPoints}`;i.fillText(d,s+o/2,r+56),this.turnButtonArea={x:s,y:r,w:o,h:n}}renderEventLog(t){const i=this.ctx,o=480,n=140,s=8,a=this.height-n-50,r=s+8,l=o-16,c=13;i.fillStyle="rgba(10,10,20,0.8)",i.fillRect(s,a,o,n),i.strokeStyle=g.uiBorder,i.lineWidth=1,i.strokeRect(s,a,o,n),this.logHitAreas=[],i.font="9px monospace",i.textAlign="left";const d=[],f=t.eventLog;for(const m of f){const v=`[${m.turn}] `+m.message,w=ts(m.type),k=(m.locationId?t.world.locations.get(m.locationId):null)?.name,M=is(i,v,l);for(let T=0;T<M.length;T++){const A=M[T];let N,$;k&&A.includes(k)&&(N=k,$=m.locationId),d.push({text:A,color:w,locName:N,locationId:$})}}this.logTotalLines=d.length,this.logBounds={x:s,y:a,w:o,h:n};const u=Math.floor((n-12)/c);this.logScrollOffset=Math.max(0,Math.min(this.logScrollOffset,Math.max(0,d.length-u)));const h=d.length-this.logScrollOffset,p=Math.max(0,h-u),y=d.slice(p,h);let b=a+12;for(const m of y){if(m.locName&&m.locationId){const I=m.text.indexOf(m.locName),v=m.text.slice(0,I),w=m.text.slice(I+m.locName.length);i.fillStyle=m.color,i.fillText(v,r,b);const R=i.measureText(v).width;i.fillStyle=g.uiHighlight,i.fillText(m.locName,r+R,b);const k=i.measureText(m.locName).width;i.fillRect(r+R,b+2,k,1),this.logHitAreas.push({x:r+R,y:b-c+2,w:k,h:c,locationId:m.locationId}),i.fillStyle=m.color,i.fillText(w,r+R+k,b)}else i.fillStyle=m.color,i.fillText(m.text,r,b);b+=c}i.font="8px monospace",i.textAlign="right",this.logScrollOffset>0&&(i.fillStyle=g.uiHighlight,i.fillText("▼ newer",s+o-8,a+n-4)),p>0&&(i.fillStyle=g.uiHighlight,i.fillText("▲ older",s+o-8,a+10))}renderBottomBar(t){const i=this.ctx,o=24,n=this.height-o;i.fillStyle="rgba(10,10,20,0.85)",i.fillRect(0,n,this.width,o),i.fillStyle=g.uiBorder,i.fillRect(0,n,this.width,1),i.font="10px monospace",i.textAlign="center";const s=["WASD: Pan","Right-click: Move","SPACE: End Turn","R: Rest","I: Inventory"];this.engine.isAtMarket()&&s.push("M: Market"),this.engine.canHunt()&&s.push("H: Hunt"),this.engine.canEmbark()&&s.push("(Pier: step to water to board)"),t.party.isSailing&&s.push("(Sailing)"),s.push("Scroll: Zoom","C: Center"),i.fillStyle="#8a8070",i.fillText(s.join(" | "),this.width/2,n+15)}renderTileInfo(t){if(!t.selectedTile)return;const i=this.ctx,o=this.engine.getTileInfo(t.selectedTile.x,t.selectedTile.y);if(o.length===0)return;const n=220,s=o.length*16+24,a=this.width-n-12,r=180;i.fillStyle="rgba(10,10,20,0.85)",i.fillRect(a,r,n,s),i.strokeStyle=g.uiBorder,i.lineWidth=1,i.strokeRect(a,r,n,s),i.fillStyle=g.uiHighlight,i.font="10px monospace",i.textAlign="left",i.fillText("TILE INFO",a+8,r+14);let l=r+30;for(const c of o)i.fillStyle=g.uiText,i.font="9px monospace",i.fillText(c,a+8,l),l+=16}renderPartyStatus(t){const i=this.ctx,o=t.party.members[0];if(!o)return;const n=8,s=40,a=180,r=100;i.fillStyle="rgba(10,10,20,0.8)",i.fillRect(n,s,a,r),i.strokeStyle=g.uiBorder,i.lineWidth=1,i.strokeRect(n,s,a,r),i.fillStyle=g.uiHighlight,i.font="10px monospace",i.textAlign="left",i.fillText(o.name,n+8,s+14),i.fillStyle=g.uiText,i.font="9px monospace",i.fillText("Level: Adventurer",n+8,s+28),i.fillText(`STR:${o.stats.strength} DEX:${o.stats.dexterity} INT:${o.stats.intelligence}`,n+8,s+42),i.fillText(`CHR:${o.stats.charisma} END:${o.stats.endurance}`,n+8,s+56);const l=n+8,c=s+64,d=a-16,f=8,u=o.health/o.maxHealth;i.fillStyle="#2a1a1a",i.fillRect(l,c,d,f),i.fillStyle=u>.6?g.uiSafe:u>.3?g.uiHighlight:g.uiDanger,i.fillRect(l,c,d*u,f),i.fillStyle=g.uiText,i.fillText(`Combat: ${o.skills.combat??0} | Survival: ${o.skills.survival??0}`,n+8,s+88)}renderInventory(t){const{party:i}=t,o=this.ctx;this.sellButtonAreas=[],this.buyButtonAreas=[];const n=t.world.tiles[i.position.y]?.[i.position.x],s=n?.locationId?t.world.locations.get(n.locationId):null,a=!!(s&&!s.isDestroyed&&s.buildings.some(p=>p.isOperational&&p.type==="market")),r=80,l=this.width-r*2,c=this.height-r*2,d=r,f=r;o.fillStyle="rgba(0, 0, 0, 0.7)",o.fillRect(0,0,this.width,this.height),o.fillStyle="rgba(20, 20, 30, 0.95)",o.fillRect(d,f,l,c),o.strokeStyle=g.uiBorder,o.lineWidth=2,o.strokeRect(d,f,l,c),o.fillStyle=g.uiHighlight,o.font="bold 16px monospace",o.textAlign="center",o.fillText(a?"TRADING":"INVENTORY",this.width/2,f+30),o.font="10px monospace",o.fillStyle="#8a8070",o.fillText("Press I or ESC to close",this.width/2,f+50),o.font="12px monospace",o.fillStyle=g.uiHighlight,o.textAlign="left",o.fillText(`Gold: ${i.gold}`,d+20,f+80);const u=i.members[0];if(u&&(o.fillText(`HP: ${Math.round(u.health)}/${u.maxHealth}`,d+180,f+80),o.fillText(`Food Need: ${Math.round(u.needs.food)}`,d+340,f+80)),a&&s){const p=d+20,y=f+100,b=100,m=20;o.fillStyle=this.inventoryTab==="inventory"?"rgba(80, 80, 100, 0.8)":"rgba(40, 40, 50, 0.6)",o.fillRect(p,y,b,m),o.strokeStyle=this.inventoryTab==="inventory"?g.uiHighlight:"#4a4a5a",o.lineWidth=1,o.strokeRect(p,y,b,m),o.fillStyle=g.uiHighlight,o.font="bold 10px monospace",o.textAlign="center",o.fillText("INVENTORY",p+b/2,y+14);const I=d+130;o.fillStyle=this.inventoryTab==="market"?"rgba(80, 80, 100, 0.8)":"rgba(40, 40, 50, 0.6)",o.fillRect(I,y,b,m),o.strokeStyle=this.inventoryTab==="market"?g.uiHighlight:"#4a4a5a",o.lineWidth=1,o.strokeRect(I,y,b,m),o.fillStyle=g.uiHighlight,o.fillText("MARKET",I+b/2,y+14)}const h=a?f+130:f+110;if(a&&s&&this.inventoryTab==="market"){this.renderMarketTab(s,d,h,l);return}this.renderInventoryTab(t,s,a,d,h,l)}renderInventoryTab(t,i,o,n,s,a){const{party:r}=t,l=this.ctx;if(l.font="12px monospace",l.fillStyle=g.uiHighlight,l.textAlign="left",l.fillText("YOUR ITEMS:",n+20,s),r.inventory.length===0){l.fillStyle="#8a8070",l.fillText("(empty - hunt animals or trade to gather items)",n+20,s+30);return}const c=2,d=(a-60)/c;let f=0,u=0;for(let h=0;h<r.inventory.length;h++){const p=r.inventory[h],y=n+20+u*d,b=s+30+f*60;l.fillStyle="rgba(40, 40, 50, 0.8)",l.fillRect(y,b,d-10,50),l.strokeStyle="#4a4a5a",l.lineWidth=1,l.strokeRect(y,b,d-10,50);const m=ze(p.resourceId);l.drawImage(m,y+8,b+8),l.fillStyle=g.uiHighlight,l.font="bold 11px monospace",l.textAlign="left",l.fillText(p.resourceId.toUpperCase(),y+28,b+18);const I=(Math.round(p.quantity*10)/10).toFixed(1),v=(p.quality*100).toFixed(0);if(l.font="10px monospace",l.fillStyle="#b0a090",l.fillText(`Qty: ${I}`,y+28,b+34),l.fillText(`Quality: ${v}%`,y+28,b+46),o&&i){const w=i.marketPrices[p.resourceId]??3,R=Math.floor(w*p.quality*p.quantity),k=y+d-90,M=b+10,T=80,A=30;l.fillStyle="rgba(80, 140, 80, 0.8)",l.fillRect(k,M,T,A),l.strokeStyle="#60b060",l.lineWidth=1,l.strokeRect(k,M,T,A),l.fillStyle="#ffffff",l.font="bold 10px monospace",l.textAlign="center",l.fillText("SELL",k+T/2,M+13),l.font="9px monospace",l.fillStyle="#e0e0e0",l.fillText(`${R}g`,k+T/2,M+25),this.sellButtonAreas.push({x:k,y:M,w:T,h:A,itemIndex:h})}u++,u>=c&&(u=0,f++)}}renderMarketTab(t,i,o,n){const s=this.ctx,a=this.engine.state.party;s.font="12px monospace",s.fillStyle=g.uiHighlight,s.textAlign="left",s.fillText(`MARKET GOODS (${t.name}):`,i+20,o);const r=t.storage.filter(u=>u.quantity>0);if(r.length===0){s.fillStyle="#8a8070",s.fillText("(no goods available for purchase)",i+20,o+30);return}const l=2,c=(n-60)/l;let d=0,f=0;for(let u=0;u<r.length;u++){const h=r[u],p=i+20+f*c,y=o+30+d*60;s.fillStyle="rgba(40, 40, 50, 0.8)",s.fillRect(p,y,c-10,50),s.strokeStyle="#4a4a5a",s.lineWidth=1,s.strokeRect(p,y,c-10,50);const b=ze(h.resourceId);s.drawImage(b,p+8,y+8),s.fillStyle=g.uiHighlight,s.font="bold 11px monospace",s.textAlign="left",s.fillText(h.resourceId.toUpperCase(),p+28,y+18);const m=(Math.round(h.quantity*10)/10).toFixed(1),I=(h.quality*100).toFixed(0);s.font="10px monospace",s.fillStyle="#b0a090",s.fillText(`Stock: ${m}`,p+28,y+34),s.fillText(`Quality: ${I}%`,p+28,y+46);const v=t.marketPrices[h.resourceId]??3,w=Math.floor(v*h.quality),R=p+c-90,k=y+10,M=80,T=30,A=a.gold>=w;if(s.fillStyle=A?"rgba(80, 120, 180, 0.8)":"rgba(80, 60, 60, 0.6)",s.fillRect(R,k,M,T),s.strokeStyle=A?"#5090d0":"#604040",s.lineWidth=1,s.strokeRect(R,k,M,T),s.fillStyle=A?"#ffffff":"#909090",s.font="bold 10px monospace",s.textAlign="center",s.fillText("BUY",R+M/2,k+13),s.font="9px monospace",s.fillStyle=A?"#e0e0e0":"#808080",s.fillText(`${w}g`,R+M/2,k+25),A){const N=t.storage.findIndex($=>$.resourceId===h.resourceId&&Math.abs($.quality-h.quality)<.01&&Math.abs($.quantity-h.quantity)<.01);this.buyButtonAreas.push({x:R,y:k,w:M,h:T,resourceId:h.resourceId,storageIndex:N})}f++,f>=l&&(f=0,d++)}}}function ts(e){switch(e){case"combat":return"#c04040";case"trade":return"#3080b0";case"political":return"#8030a0";case"discovery":return"#30a030";case"danger":return"#c07030";case"social":return"#c080c0";case"system":return"#808070";default:return"#908878"}}function is(e,t,i){const o=t.split(" "),n=[];let s="";for(const a of o){const r=s?s+" "+a:a;e.measureText(r).width>i&&s?(n.push(s),s="  "+a):s=r}return s&&n.push(s),n}const ue=document.getElementById("game-canvas"),we=document.getElementById("loading-screen"),os=document.getElementById("loading-bar"),Y=new $o,O=new In(ue),Re=new es(ue.getContext("2d"),Y);Re.setRenderer(O);function Ue(){O.resize()}window.addEventListener("resize",Ue);Ue();function ns(e,t){os.style.width=`${Math.round(t*100)}%`;const i=we.querySelector("p");i&&(i.textContent=e)}async function ss(){const e=Math.floor(Math.random()*999999999);await new Promise(a=>{setTimeout(()=>{Y.newGame({seed:e,width:128,height:128},ns),a()},50)}),O.camera.centerOnTile(Y.state.party.position.x,Y.state.party.position.y),O.camera.x=O.camera.targetX,O.camera.y=O.camera.targetY,we.style.opacity="0",setTimeout(()=>{we.style.display="none"},500);const t=new wn(Y,O,ue);t.setHUD(Re);let i=performance.now(),o=0;const n=.12;function s(a){const r=(a-i)/1e3;i=a,t.update(),Y.state.party.queuedPath.length>0?(o+=r,o>=n&&(o=0,Y.tickPartyMovement())):o=0,O.render(Y.state,r),ue.getContext("2d"),Re.render(Y.state,O.camera.screenWidth,O.camera.screenHeight),requestAnimationFrame(s)}requestAnimationFrame(s)}ss().catch(console.error);
